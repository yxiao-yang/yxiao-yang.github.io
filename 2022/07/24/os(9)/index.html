

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/app.png">
  <link rel="icon" href="/img/app.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="第九章 实现内核线程 启动多线程调度  写在前面 24日，进入到线程部分了，感觉应该是要接触到一些基本的算法调度了。书上为了教学和方便，采用了创建内核线程的方式，我们一起来看看。  创建内核线程 首先我们梳理一下进程和线程的基础知识。书上举了一个非常生动的例子：将饭店的厨房比作一个进程，其中在厨房工作的人，比如厨师、配菜员、餐具清洁员等，就是一个个线程，食材和烹饪的锅具就是进程的资源。由此可见，">
<meta property="og:type" content="article">
<meta property="og:title" content="第九章 实现内核线程 启动多线程调度">
<meta property="og:url" content="http://example.com/2022/07/24/os(9)/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="第九章 实现内核线程 启动多线程调度  写在前面 24日，进入到线程部分了，感觉应该是要接触到一些基本的算法调度了。书上为了教学和方便，采用了创建内核线程的方式，我们一起来看看。  创建内核线程 首先我们梳理一下进程和线程的基础知识。书上举了一个非常生动的例子：将饭店的厨房比作一个进程，其中在厨房工作的人，比如厨师、配菜员、餐具清洁员等，就是一个个线程，食材和烹饪的锅具就是进程的资源。由此可见，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/os/os9.1.png">
<meta property="og:image" content="http://example.com/img/os/os9.2.png">
<meta property="article:published_time" content="2022-07-24T03:51:17.238Z">
<meta property="article:modified_time" content="2022-07-24T14:17:04.024Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/os/os9.1.png">
  
  
  <title>第九章 实现内核线程 启动多线程调度 - Hexo</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":50,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>羊</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/bg2.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="第九章 实现内核线程 启动多线程调度">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-07-24 11:51" pubdate>
        2022年7月24日 中午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      22k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      181 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">第九章 实现内核线程 启动多线程调度</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：8 天前
                
              </p>
            
            <div class="markdown-body">
              <h1 id="第九章-实现内核线程-启动多线程调度"><a class="markdownIt-Anchor" href="#第九章-实现内核线程-启动多线程调度"></a> 第九章 实现内核线程 启动多线程调度</h1>
<h2 id="写在前面"><a class="markdownIt-Anchor" href="#写在前面"></a> 写在前面</h2>
<p>24日，进入到线程部分了，感觉应该是要接触到一些基本的算法调度了。书上为了教学和方便，采用了创建内核线程的方式，我们一起来看看。</p>
<h2 id="创建内核线程"><a class="markdownIt-Anchor" href="#创建内核线程"></a> 创建内核线程</h2>
<p>首先我们梳理一下进程和线程的基础知识。书上举了一个非常生动的例子：将饭店的厨房比作一个进程，其中在厨房工作的人，比如厨师、配菜员、餐具清洁员等，就是一个个线程，食材和烹饪的锅具就是进程的资源。由此可见，</p>
<blockquote>
<p>线程=进程+资源</p>
</blockquote>
<p>进程有资源即页表，进程的所有线程公用进程的页表。</p>
<p>这次试验创造的是一个内核线程，所以它使用的内存空间是内核内存池，1MB到2MB的页目录和页表。</p>
<p>整个流程如下：<br />
定义了PCB结构体，中断栈结构体（本次实验只是留了个位置，可以不管），线程栈结构体。<br />
其中，PCB中重要的成员变量便是线程名，线程栈指针。<br />
线程栈结构体重要的成员变量便是线程需要执行的函数的指针。因为如果切换到该线程，线程应该知道要执行哪个函数。</p>
<h3 id="threadthreadh创建"><a class="markdownIt-Anchor" href="#threadthreadh创建"></a> thread/thread.h创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></div></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __THREAD_THREAD_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __THREAD_THREAD_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span> <span class="hljs-title function_">thread_func</span><span class="hljs-params">(<span class="hljs-type">void</span>*)</span>;<br><br><span class="hljs-comment">/* 进程或线程的状态 */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">task_status</span> &#123;</span><br>   TASK_RUNNING,<br>   TASK_READY,<br>   TASK_BLOCKED,<br>   TASK_WAITING,<br>   TASK_HANGING,<br>   TASK_DIED<br>&#125;;<br><br><span class="hljs-comment">/***********   中断栈intr_stack   ***********</span><br><span class="hljs-comment"> * 此结构用于中断发生时保护程序(线程或进程)的上下文环境:</span><br><span class="hljs-comment"> * 进程或线程被外部中断或软中断打断时,会按照此结构压入上下文</span><br><span class="hljs-comment"> * 寄存器,  intr_exit中的出栈操作是此结构的逆操作</span><br><span class="hljs-comment"> * 此栈在线程自己的内核栈中位置固定,所在页的最顶端</span><br><span class="hljs-comment">********************************************/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">intr_stack</span> &#123;</span><br>    <span class="hljs-type">uint32_t</span> vec_no;	 <span class="hljs-comment">// kernel.S 宏VECTOR中push %1压入的中断号</span><br>    <span class="hljs-type">uint32_t</span> edi;<br>    <span class="hljs-type">uint32_t</span> esi;<br>    <span class="hljs-type">uint32_t</span> ebp;<br>    <span class="hljs-type">uint32_t</span> esp_dummy;	 <span class="hljs-comment">// 虽然pushad把esp也压入,但esp是不断变化的,所以会被popad忽略</span><br>    <span class="hljs-type">uint32_t</span> ebx;<br>    <span class="hljs-type">uint32_t</span> edx;<br>    <span class="hljs-type">uint32_t</span> ecx;<br>    <span class="hljs-type">uint32_t</span> eax;<br>    <span class="hljs-type">uint32_t</span> gs;<br>    <span class="hljs-type">uint32_t</span> fs;<br>    <span class="hljs-type">uint32_t</span> es;<br>    <span class="hljs-type">uint32_t</span> ds;<br><br><span class="hljs-comment">/* 以下由cpu从低特权级进入高特权级时压入 */</span><br>    <span class="hljs-type">uint32_t</span> err_code;		 <span class="hljs-comment">// err_code会被压入在eip之后</span><br>    <span class="hljs-type">void</span> (*eip) (<span class="hljs-type">void</span>);<br>    <span class="hljs-type">uint32_t</span> cs;<br>    <span class="hljs-type">uint32_t</span> eflags;<br>    <span class="hljs-type">void</span>* esp;<br>    <span class="hljs-type">uint32_t</span> ss;<br>&#125;;<br><br><span class="hljs-comment">/***********  线程栈thread_stack  ***********</span><br><span class="hljs-comment"> * 线程自己的栈,用于存储线程中待执行的函数</span><br><span class="hljs-comment"> * 此结构在线程自己的内核栈中位置不固定,</span><br><span class="hljs-comment"> * 用在switch_to时保存线程环境。</span><br><span class="hljs-comment"> * 实际位置取决于实际运行情况。</span><br><span class="hljs-comment"> ******************************************/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">thread_stack</span> &#123;</span><br>   <span class="hljs-type">uint32_t</span> ebp;<br>   <span class="hljs-type">uint32_t</span> ebx;<br>   <span class="hljs-type">uint32_t</span> edi;<br>   <span class="hljs-type">uint32_t</span> esi;<br><br><span class="hljs-comment">/* 线程第一次执行时,eip指向待调用的函数kernel_thread </span><br><span class="hljs-comment">其它时候,eip是指向switch_to的返回地址*/</span><br>   <span class="hljs-type">void</span> (*eip) (thread_func* func, <span class="hljs-type">void</span>* func_arg);<br><br><span class="hljs-comment">/*****   以下仅供第一次被调度上cpu时使用   ****/</span><br><br><span class="hljs-comment">/* 参数unused_ret只为占位置充数为返回地址 */</span><br>   <span class="hljs-type">void</span> (*unused_retaddr);<br>   thread_func* function;   <span class="hljs-comment">// 由Kernel_thread所调用的函数名</span><br>   <span class="hljs-type">void</span>* func_arg;    <span class="hljs-comment">// 由Kernel_thread所调用的函数所需的参数</span><br>&#125;;<br><br><span class="hljs-comment">/* 进程或线程的pcb,程序控制块 */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> &#123;</span><br>   <span class="hljs-type">uint32_t</span>* self_kstack;	 <span class="hljs-comment">// 各内核线程都用自己的内核栈</span><br>   <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">task_status</span> <span class="hljs-title">status</span>;</span><br>   <span class="hljs-type">char</span> name[<span class="hljs-number">16</span>];<br>   <span class="hljs-type">uint8_t</span> priority;<br>   <span class="hljs-type">uint32_t</span> stack_magic;	 <span class="hljs-comment">// 用这串数字做栈的边界标记,用于检测栈的溢出</span><br>&#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">thread_create</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct* pthread, thread_func function, <span class="hljs-type">void</span>* func_arg)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">init_thread</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct* pthread, <span class="hljs-type">char</span>* name, <span class="hljs-type">int</span> prio)</span>;<br><span class="hljs-keyword">struct</span> task_struct* <span class="hljs-title function_">thread_start</span><span class="hljs-params">(<span class="hljs-type">char</span>* name, <span class="hljs-type">int</span> prio, thread_func function, <span class="hljs-type">void</span>* func_arg)</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
<h3 id="threadthreadc创建"><a class="markdownIt-Anchor" href="#threadthreadc创建"></a> thread/thread.c创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;thread.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;string.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;global.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;memory.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PG_SIZE 4096</span><br><br><span class="hljs-comment">/* 由kernel_thread去执行function(func_arg) */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">kernel_thread</span><span class="hljs-params">(thread_func* function, <span class="hljs-type">void</span>* func_arg)</span> &#123;<br><br>   function(func_arg); <br>&#125;<br><br><span class="hljs-comment">/* 初始化线程栈thread_stack,将待执行的函数和参数放到thread_stack中相应的位置 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">thread_create</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct* pthread, thread_func function, <span class="hljs-type">void</span>* func_arg)</span> &#123;<br>   <span class="hljs-comment">/* 先预留中断使用栈的空间,可见thread.h中定义的结构 */</span><br>   pthread-&gt;self_kstack -= <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> intr_stack);<br><br>   <span class="hljs-comment">/* 再留出线程栈空间,可见thread.h中定义 */</span><br>   pthread-&gt;self_kstack -= <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> thread_stack);<br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">thread_stack</span>* <span class="hljs-title">kthread_stack</span> =</span> (<span class="hljs-keyword">struct</span> thread_stack*)pthread-&gt;self_kstack;<br>   kthread_stack-&gt;eip = kernel_thread;<br>   kthread_stack-&gt;function = function;<br>   kthread_stack-&gt;func_arg = func_arg;<br>   kthread_stack-&gt;ebp = kthread_stack-&gt;ebx = kthread_stack-&gt;esi = kthread_stack-&gt;edi = <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/* 初始化线程基本信息 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">init_thread</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct* pthread, <span class="hljs-type">char</span>* name, <span class="hljs-type">int</span> prio)</span> &#123;<br>   <span class="hljs-built_in">memset</span>(pthread, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(*pthread));<br>   <span class="hljs-built_in">strcpy</span>(pthread-&gt;name, name);<br><br>  pthread-&gt;status = TASK_RUNNING;<br><br><span class="hljs-comment">/* self_kstack是线程自己在内核态下使用的栈顶地址 */</span><br>   pthread-&gt;self_kstack = (<span class="hljs-type">uint32_t</span>*)((<span class="hljs-type">uint32_t</span>)pthread + PG_SIZE);<br>   pthread-&gt;priority = prio;<br><br>   pthread-&gt;stack_magic = <span class="hljs-number">0x19870916</span>;	  <span class="hljs-comment">// 自定义的魔数</span><br>&#125;<br><br><span class="hljs-comment">/* 创建一优先级为prio的线程,线程名为name,线程所执行的函数是function(func_arg) */</span><br><span class="hljs-keyword">struct</span> task_struct* <span class="hljs-title function_">thread_start</span><span class="hljs-params">(<span class="hljs-type">char</span>* name, <span class="hljs-type">int</span> prio, thread_func function, <span class="hljs-type">void</span>* func_arg)</span> &#123;<br><span class="hljs-comment">/* pcb都位于内核空间,包括用户进程的pcb也是在内核空间 */</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span>* <span class="hljs-title">thread</span> =</span> get_kernel_pages(<span class="hljs-number">1</span>);<br>   init_thread(thread, name, prio);<br>   thread_create(thread, function, func_arg);<br><br>  <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span> <span class="hljs-params">(<span class="hljs-string">&quot;movl %0, %%esp; pop %%ebp; pop %%ebx; pop %%edi; pop %%esi; \</span></span><br><span class="hljs-string"><span class="hljs-params">	ret &quot;</span>: : <span class="hljs-string">&quot;g&quot;</span> (thread-&gt;self_kstack) :<span class="hljs-string">&quot;memory&quot;</span>)</span>;<br>   <span class="hljs-keyword">return</span> thread;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="kernelmainc修改"><a class="markdownIt-Anchor" href="#kernelmainc修改"></a> kernel/main.c修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;init.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;thread.h&quot;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">k_thread_a</span><span class="hljs-params">(<span class="hljs-type">void</span>* )</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>   	put_str(<span class="hljs-string">&quot;I am kernel\n&quot;</span>);<br>   	init_all();<br>	<br>	thread_start(<span class="hljs-string">&quot;k_thread_a&quot;</span>, <span class="hljs-number">31</span>, k_thread_a, <span class="hljs-string">&quot;argA &quot;</span>);<br>	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">k_thread_a</span><span class="hljs-params">(<span class="hljs-type">void</span>* arg)</span>&#123;<br>	<span class="hljs-type">char</span>* para = arg;<br>	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)&#123;<br>	put_str(para);<br>	&#125;	<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="makefile修改"><a class="markdownIt-Anchor" href="#makefile修改"></a> makefile修改</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs shell">BUILD_DIR = ./build<br>ENTRY_POINT = 0xc0001500<br>AS = nasm<br>CC = gcc<br>LD = ld<br>LIB = -I lib/ -I lib/kernel/ -I lib/user/ -I kernel/ -I device/ -I thread/<br>ASFLAGS = -f elf<br>CFLAGS = -Wall -m32 -fno-stack-protector $(LIB) -c -fno-builtin -W -Wstrict-prototypes -Wmissing-prototypes<br>LDFLAGS =  -m elf_i386 -Ttext $(ENTRY_POINT) -e main -Map $(BUILD_DIR)/kernel.map<br>OBJS = $(BUILD_DIR)/main.o $(BUILD_DIR)/init.o $(BUILD_DIR)/interrupt.o \<br>      $(BUILD_DIR)/timer.o $(BUILD_DIR)/kernel.o $(BUILD_DIR)/print.o \<br>      $(BUILD_DIR)/debug.o $(BUILD_DIR)/string.o $(BUILD_DIR)/memory.o \<br>      $(BUILD_DIR)/bitmap.o $(BUILD_DIR)/thread.o<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#############     c代码编译     ###############</span></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/main.o: kernel/main.c lib/kernel/print.h \</span><br><span class="language-bash">        lib/stdint.h kernel/init.h lib/string.h kernel/memory.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/init.o: kernel/init.c kernel/init.h lib/kernel/print.h \</span><br><span class="language-bash">        lib/stdint.h kernel/interrupt.h device/timer.h kernel/memory.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/interrupt.o: kernel/interrupt.c kernel/interrupt.h \</span><br><span class="language-bash">        lib/stdint.h kernel/global.h lib/kernel/io.h lib/kernel/print.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/timer.o: device/timer.c device/timer.h lib/stdint.h\</span><br><span class="language-bash">        lib/kernel/io.h lib/kernel/print.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/debug.o: kernel/debug.c kernel/debug.h \</span><br><span class="language-bash">        lib/kernel/print.h lib/stdint.h kernel/interrupt.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/string.o: lib/string.c lib/string.h \</span><br><span class="language-bash">	kernel/debug.h kernel/global.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/memory.o: kernel/memory.c kernel/memory.h \</span><br><span class="language-bash">	lib/stdint.h lib/kernel/bitmap.h kernel/debug.h lib/string.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/bitmap.o: lib/kernel/bitmap.c lib/kernel/bitmap.h \</span><br><span class="language-bash">	lib/string.h kernel/interrupt.h lib/kernel/print.h kernel/debug.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/thread.o: thread/thread.c thread/thread.h lib/stdint.h  \</span><br><span class="language-bash">    kernel/global.h lib/string.h lib/stdint.h kernel/debug.h \</span><br><span class="language-bash">    lib/kernel/print.h kernel/memory.h \</span><br><span class="language-bash">    lib/kernel/bitmap.h thread/thread.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#############    汇编代码编译    ###############</span></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/kernel.o: kernel/kernel.S</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(AS) $(ASFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/print.o: lib/kernel/print.S</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(AS) $(ASFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#############    链接所有目标文件    #############</span></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/kernel.bin: $(OBJS)</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(LD) $(LDFLAGS) $^ -o <span class="hljs-variable">$@</span></span><br><br>.PHONY : mk_dir hd clean all<br><br>mk_dir:<br>	if [ ! -d $(BUILD_DIR) ]; then mkdir $(BUILD_DIR); fi<br><br>hd:<br>	dd if=$(BUILD_DIR)/kernel.bin \<br>           of=/home/podest/bochs/hd60M.img \<br>           bs=512 count=200 seek=9 conv=notrunc<br><br>clean:<br>	cd $(BUILD_DIR) &amp;&amp; rm -f  ./*<br><br>build: $(BUILD_DIR)/kernel.bin<br><br>all: mk_dir build hd<br></code></pre></td></tr></table></figure>
<h3 id="运行结果"><a class="markdownIt-Anchor" href="#运行结果"></a> 运行结果</h3>
<p><img src="/img/os/os9.1.png" srcset="/img/loading.gif" lazyload alt="图为bochs运行界面" /></p>
<h2 id="编写双向链表"><a class="markdownIt-Anchor" href="#编写双向链表"></a> 编写双向链表</h2>
<h3 id="libkernellisth创建"><a class="markdownIt-Anchor" href="#libkernellisth创建"></a> lib/kernel/list.h创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __LIB_KERNEL_LIST_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LIB_KERNEL_LIST_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;global.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> offset(struct_type,member) (int)(&amp;((struct_type*)0)-&gt;member)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> elem2entry(struct_type, struct_member_name, elem_ptr) \</span><br><span class="hljs-meta">	 (struct_type*)((int)elem_ptr - offset(struct_type, struct_member_name))</span><br><br><span class="hljs-comment">/**********   定义链表结点成员结构   ***********</span><br><span class="hljs-comment">*结点中不需要数据成元,只要求前驱和后继结点指针*/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_elem</span> &#123;</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_elem</span>* <span class="hljs-title">prev</span>;</span> <span class="hljs-comment">// 前躯结点</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_elem</span>* <span class="hljs-title">next</span>;</span> <span class="hljs-comment">// 后继结点</span><br>&#125;;<br><br><span class="hljs-comment">/* 链表结构,用来实现队列 */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list</span> &#123;</span><br><span class="hljs-comment">/* head是队首,是固定不变的，不是第1个元素,第1个元素为head.next */</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_elem</span> <span class="hljs-title">head</span>;</span><br><span class="hljs-comment">/* tail是队尾,同样是固定不变的 */</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_elem</span> <span class="hljs-title">tail</span>;</span><br>&#125;;<br><br><span class="hljs-comment">/* 自定义函数类型function,用于在list_traversal中做回调函数 */</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-title function_">bool</span> <span class="hljs-params">(function)</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> list_elem*, <span class="hljs-type">int</span> arg)</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">list_init</span> <span class="hljs-params">(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">list</span>*)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">list_insert_before</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> list_elem* before, <span class="hljs-keyword">struct</span> list_elem* elem)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">list_push</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">list</span>* plist, <span class="hljs-keyword">struct</span> list_elem* elem)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">list_iterate</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">list</span>* plist)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">list_append</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">list</span>* plist, <span class="hljs-keyword">struct</span> list_elem* elem)</span>;  <br><span class="hljs-type">void</span> <span class="hljs-title function_">list_remove</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> list_elem* pelem)</span>;<br><span class="hljs-keyword">struct</span> list_elem* <span class="hljs-title function_">list_pop</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">list</span>* plist)</span>;<br><span class="hljs-type">bool</span> <span class="hljs-title function_">list_empty</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">list</span>* plist)</span>;<br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">list_len</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">list</span>* plist)</span>;<br><span class="hljs-keyword">struct</span> list_elem* <span class="hljs-title function_">list_traversal</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">list</span>* plist, function func, <span class="hljs-type">int</span> arg)</span>;<br><span class="hljs-type">bool</span> <span class="hljs-title function_">elem_find</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">list</span>* plist, <span class="hljs-keyword">struct</span> list_elem* obj_elem)</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
<h3 id="libkernellistc创建"><a class="markdownIt-Anchor" href="#libkernellistc创建"></a> lib/kernel/list.c创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;list.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;interrupt.h&quot;</span></span><br><br><span class="hljs-comment">/* 初始化双向链表list */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">list_init</span> <span class="hljs-params">(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">list</span>* <span class="hljs-built_in">list</span>)</span> &#123;<br>   <span class="hljs-built_in">list</span>-&gt;head.prev = <span class="hljs-literal">NULL</span>;<br>   <span class="hljs-built_in">list</span>-&gt;head.next = &amp;<span class="hljs-built_in">list</span>-&gt;tail;<br>   <span class="hljs-built_in">list</span>-&gt;tail.prev = &amp;<span class="hljs-built_in">list</span>-&gt;head;<br>   <span class="hljs-built_in">list</span>-&gt;tail.next = <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-comment">/* 把链表元素elem插入在元素before之前 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">list_insert_before</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> list_elem* before, <span class="hljs-keyword">struct</span> list_elem* elem)</span> &#123; <br>   <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">intr_status</span> <span class="hljs-title">old_status</span> =</span> intr_disable();<br><br><span class="hljs-comment">/* 将before前驱元素的后继元素更新为elem, 暂时使before脱离链表*/</span> <br>   before-&gt;prev-&gt;next = elem; <br><br><span class="hljs-comment">/* 更新elem自己的前驱结点为before的前驱,</span><br><span class="hljs-comment"> * 更新elem自己的后继结点为before, 于是before又回到链表 */</span><br>   elem-&gt;prev = before-&gt;prev;<br>   elem-&gt;next = before;<br><br><span class="hljs-comment">/* 更新before的前驱结点为elem */</span><br>   before-&gt;prev = elem;<br><br>   intr_set_status(old_status);<br>&#125;<br><br><span class="hljs-comment">/* 添加元素到列表队首,类似栈push操作 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">list_push</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">list</span>* plist, <span class="hljs-keyword">struct</span> list_elem* elem)</span> &#123;<br>   list_insert_before(plist-&gt;head.next, elem); <span class="hljs-comment">// 在队头插入elem</span><br>&#125;<br><br><span class="hljs-comment">/* 追加元素到链表队尾,类似队列的先进先出操作 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">list_append</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">list</span>* plist, <span class="hljs-keyword">struct</span> list_elem* elem)</span> &#123;<br>   list_insert_before(&amp;plist-&gt;tail, elem);     <span class="hljs-comment">// 在队尾的前面插入</span><br>&#125;<br><br><span class="hljs-comment">/* 使元素pelem脱离链表 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">list_remove</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> list_elem* pelem)</span> &#123;<br>   <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">intr_status</span> <span class="hljs-title">old_status</span> =</span> intr_disable();<br>   <br>   pelem-&gt;prev-&gt;next = pelem-&gt;next;<br>   pelem-&gt;next-&gt;prev = pelem-&gt;prev;<br><br>   intr_set_status(old_status);<br>&#125;<br><br><span class="hljs-comment">/* 将链表第一个元素弹出并返回,类似栈的pop操作 */</span><br><span class="hljs-keyword">struct</span> list_elem* <span class="hljs-title function_">list_pop</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">list</span>* plist)</span> &#123;<br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_elem</span>* <span class="hljs-title">elem</span> =</span> plist-&gt;head.next;<br>   list_remove(elem);<br>   <span class="hljs-keyword">return</span> elem;<br>&#125; <br><br><span class="hljs-comment">/* 从链表中查找元素obj_elem,成功时返回true,失败时返回false */</span><br><span class="hljs-type">bool</span> <span class="hljs-title function_">elem_find</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">list</span>* plist, <span class="hljs-keyword">struct</span> list_elem* obj_elem)</span> &#123;<br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_elem</span>* <span class="hljs-title">elem</span> =</span> plist-&gt;head.next;<br>   <span class="hljs-keyword">while</span> (elem != &amp;plist-&gt;tail) &#123;<br>      <span class="hljs-keyword">if</span> (elem == obj_elem) &#123;<br>	 <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>      &#125;<br>      elem = elem-&gt;next;<br>   &#125;<br>   <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-comment">/* 把列表plist中的每个元素elem和arg传给回调函数func,</span><br><span class="hljs-comment"> * arg给func用来判断elem是否符合条件.</span><br><span class="hljs-comment"> * 本函数的功能是遍历列表内所有元素,逐个判断是否有符合条件的元素。</span><br><span class="hljs-comment"> * 找到符合条件的元素返回元素指针,否则返回NULL. */</span><br><span class="hljs-keyword">struct</span> list_elem* <span class="hljs-title function_">list_traversal</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">list</span>* plist, function func, <span class="hljs-type">int</span> arg)</span> &#123;<br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_elem</span>* <span class="hljs-title">elem</span> =</span> plist-&gt;head.next;<br><span class="hljs-comment">/* 如果队列为空,就必然没有符合条件的结点,故直接返回NULL */</span><br>   <span class="hljs-keyword">if</span> (list_empty(plist)) &#123; <br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>   &#125;<br><br>   <span class="hljs-keyword">while</span> (elem != &amp;plist-&gt;tail) &#123;<br>      <span class="hljs-keyword">if</span> (func(elem, arg)) &#123;		  <span class="hljs-comment">// func返回ture则认为该元素在回调函数中符合条件,命中,故停止继续遍历</span><br>	 <span class="hljs-keyword">return</span> elem;<br>      &#125;					  <span class="hljs-comment">// 若回调函数func返回true,则继续遍历</span><br>      elem = elem-&gt;next;	       <br>   &#125;<br>   <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-comment">/* 返回链表长度 */</span><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">list_len</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">list</span>* plist)</span> &#123;<br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_elem</span>* <span class="hljs-title">elem</span> =</span> plist-&gt;head.next;<br>   <span class="hljs-type">uint32_t</span> length = <span class="hljs-number">0</span>;<br>   <span class="hljs-keyword">while</span> (elem != &amp;plist-&gt;tail) &#123;<br>      length++; <br>      elem = elem-&gt;next;<br>   &#125;<br>   <span class="hljs-keyword">return</span> length;<br>&#125;<br><br><span class="hljs-comment">/* 判断链表是否为空,空时返回true,否则返回false */</span><br><span class="hljs-type">bool</span> <span class="hljs-title function_">list_empty</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">list</span>* plist)</span> &#123;		<span class="hljs-comment">// 判断队列是否为空</span><br>   <span class="hljs-keyword">return</span> (plist-&gt;head.next == &amp;plist-&gt;tail ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="实现多线程调度"><a class="markdownIt-Anchor" href="#实现多线程调度"></a> 实现多线程调度</h2>
<p>本次实验实现了多线程的调度，增加的功能如下<br />
1.增了加专门的时钟中断处理函数，判断如果当前线程时间片用完，则执行调度函数schedule<br />
2.schedule对当前线程如果时间片用完，则加入就绪队列，然后弹出队头，调用switch_to(cur,next)函数<br />
3.switch_to函数保护当前线程环境，恢复下一个线程环境，ret开始执行下一个线程。<br />
具体流程如下：<br />
1.main.c里的init_all创建了主线程main_thread，为运行态，然后thread_start创建了两个线程。<br />
注意：此时的thread_start没有ret指令了，说明没有开启此线程，仅仅完成了单线程实验init和create的工作，并将线程挂上就绪队列，此线程的开启由时钟中断引出。<br />
2.main线程时间片31，argA时间片31，argB时间片8。开中断后，时钟中断频繁发生，cpu频繁执行新写的时钟中断处理程序，不断判断主线程时间片是否够用，如果为0，在schedule中将主线程则放入就绪队列，补满时间片，并出栈队头的argA，从而执行argA线程。<br />
3.之后便是依次循环执行，因此main argA argB会循环打印。</p>
<h3 id="threadthreadh修改"><a class="markdownIt-Anchor" href="#threadthreadh修改"></a> thread/thread.h修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __THREAD_THREAD_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __THREAD_THREAD_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;list.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;bitmap.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;memory.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TASK_NAME_LEN 16</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_FILES_OPEN_PER_PROC 8</span><br><span class="hljs-comment">/* 自定义通用函数类型,它将在很多线程函数中做为形参类型 */</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span> <span class="hljs-title function_">thread_func</span><span class="hljs-params">(<span class="hljs-type">void</span>*)</span>;<br><span class="hljs-keyword">typedef</span> <span class="hljs-type">int16_t</span> <span class="hljs-type">pid_t</span>;<br><br><span class="hljs-comment">/* 进程或线程的状态 */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">task_status</span> &#123;</span><br>   TASK_RUNNING,<br>   TASK_READY,<br>   TASK_BLOCKED,<br>   TASK_WAITING,<br>   TASK_HANGING,<br>   TASK_DIED<br>&#125;;<br><br><span class="hljs-comment">/***********   中断栈intr_stack   ***********</span><br><span class="hljs-comment"> * 此结构用于中断发生时保护程序(线程或进程)的上下文环境:</span><br><span class="hljs-comment"> * 进程或线程被外部中断或软中断打断时,会按照此结构压入上下文</span><br><span class="hljs-comment"> * 寄存器,  intr_exit中的出栈操作是此结构的逆操作</span><br><span class="hljs-comment"> * 此栈在线程自己的内核栈中位置固定,所在页的最顶端</span><br><span class="hljs-comment">********************************************/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">intr_stack</span> &#123;</span><br>    <span class="hljs-type">uint32_t</span> vec_no;	 <span class="hljs-comment">// kernel.S 宏VECTOR中push %1压入的中断号</span><br>    <span class="hljs-type">uint32_t</span> edi;<br>    <span class="hljs-type">uint32_t</span> esi;<br>    <span class="hljs-type">uint32_t</span> ebp;<br>    <span class="hljs-type">uint32_t</span> esp_dummy;	 <span class="hljs-comment">// 虽然pushad把esp也压入,但esp是不断变化的,所以会被popad忽略</span><br>    <span class="hljs-type">uint32_t</span> ebx;<br>    <span class="hljs-type">uint32_t</span> edx;<br>    <span class="hljs-type">uint32_t</span> ecx;<br>    <span class="hljs-type">uint32_t</span> eax;<br>    <span class="hljs-type">uint32_t</span> gs;<br>    <span class="hljs-type">uint32_t</span> fs;<br>    <span class="hljs-type">uint32_t</span> es;<br>    <span class="hljs-type">uint32_t</span> ds;<br><br><span class="hljs-comment">/* 以下由cpu从低特权级进入高特权级时压入 */</span><br>    <span class="hljs-type">uint32_t</span> err_code;		 <span class="hljs-comment">// err_code会被压入在eip之后</span><br>    <span class="hljs-type">void</span> (*eip) (<span class="hljs-type">void</span>);<br>    <span class="hljs-type">uint32_t</span> cs;<br>    <span class="hljs-type">uint32_t</span> eflags;<br>    <span class="hljs-type">void</span>* esp;<br>    <span class="hljs-type">uint32_t</span> ss;<br>&#125;;<br><br><span class="hljs-comment">/***********  线程栈thread_stack  ***********</span><br><span class="hljs-comment"> * 线程自己的栈,用于存储线程中待执行的函数</span><br><span class="hljs-comment"> * 此结构在线程自己的内核栈中位置不固定,</span><br><span class="hljs-comment"> * 用在switch_to时保存线程环境。</span><br><span class="hljs-comment"> * 实际位置取决于实际运行情况。</span><br><span class="hljs-comment"> ******************************************/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">thread_stack</span> &#123;</span><br>   <span class="hljs-type">uint32_t</span> ebp;<br>   <span class="hljs-type">uint32_t</span> ebx;<br>   <span class="hljs-type">uint32_t</span> edi;<br>   <span class="hljs-type">uint32_t</span> esi;<br><br><span class="hljs-comment">/* 线程第一次执行时,eip指向待调用的函数kernel_thread </span><br><span class="hljs-comment">其它时候,eip是指向switch_to的返回地址*/</span><br>   <span class="hljs-type">void</span> (*eip) (thread_func* func, <span class="hljs-type">void</span>* func_arg);<br><br><span class="hljs-comment">/*****   以下仅供第一次被调度上cpu时使用   ****/</span><br><br><span class="hljs-comment">/* 参数unused_ret只为占位置充数为返回地址 */</span><br>   <span class="hljs-type">void</span> (*unused_retaddr);<br>   thread_func* function;   <span class="hljs-comment">// 由Kernel_thread所调用的函数名</span><br>   <span class="hljs-type">void</span>* func_arg;    <span class="hljs-comment">// 由Kernel_thread所调用的函数所需的参数</span><br>&#125;;<br><br><span class="hljs-comment">/* 进程或线程的pcb,程序控制块 */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> &#123;</span><br>   <span class="hljs-type">uint32_t</span>* self_kstack;	 <span class="hljs-comment">// 各内核线程都用自己的内核栈</span><br>   <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">task_status</span> <span class="hljs-title">status</span>;</span><br>   <span class="hljs-type">char</span> name[<span class="hljs-number">16</span>];<br>   <span class="hljs-type">uint8_t</span> priority;<br>   <span class="hljs-type">uint8_t</span> ticks;	   <span class="hljs-comment">// 每次在处理器上执行的时间嘀嗒数</span><br><span class="hljs-comment">/* 此任务自上cpu运行后至今占用了多少cpu嘀嗒数,</span><br><span class="hljs-comment"> * 也就是此任务执行了多久*/</span><br>   <span class="hljs-type">uint32_t</span> elapsed_ticks;<br><span class="hljs-comment">/* general_tag的作用是用于线程在一般的队列中的结点 */</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_elem</span> <span class="hljs-title">general_tag</span>;</span>				    <br><span class="hljs-comment">/* all_list_tag的作用是用于线程队列thread_all_list中的结点 */</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_elem</span> <span class="hljs-title">all_list_tag</span>;</span><br>   <span class="hljs-type">uint32_t</span>* pgdir;              <span class="hljs-comment">// 进程自己页表的虚拟地址</span><br>   <span class="hljs-type">uint32_t</span> stack_magic;	 <span class="hljs-comment">// 用这串数字做栈的边界标记,用于检测栈的溢出</span><br>&#125;;<br><br><span class="hljs-keyword">extern</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list</span> <span class="hljs-title">thread_ready_list</span>;</span><br><span class="hljs-keyword">extern</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list</span> <span class="hljs-title">thread_all_list</span>;</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">thread_create</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct* pthread, thread_func function, <span class="hljs-type">void</span>* func_arg)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">init_thread</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct* pthread, <span class="hljs-type">char</span>* name, <span class="hljs-type">int</span> prio)</span>;<br><span class="hljs-keyword">struct</span> task_struct* <span class="hljs-title function_">thread_start</span><span class="hljs-params">(<span class="hljs-type">char</span>* name, <span class="hljs-type">int</span> prio, thread_func function, <span class="hljs-type">void</span>* func_arg)</span>;<br><span class="hljs-keyword">struct</span> task_struct* <span class="hljs-title function_">running_thread</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">schedule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">thread_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
<h3 id="threadthreadc修改"><a class="markdownIt-Anchor" href="#threadthreadc修改"></a> thread/thread.c修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;thread.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;string.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;global.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;debug.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;interrupt.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;memory.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;list.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PG_SIZE 4096</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span>* <span class="hljs-title">main_thread</span>;</span>    <span class="hljs-comment">// 主线程PCB</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list</span> <span class="hljs-title">thread_ready_list</span>;</span>	    <span class="hljs-comment">// 就绪队列</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list</span> <span class="hljs-title">thread_all_list</span>;</span>	    <span class="hljs-comment">// 所有任务队列</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_elem</span>* <span class="hljs-title">thread_tag</span>;</span><span class="hljs-comment">// 用于保存队列中的线程结点</span><br><br><br><span class="hljs-comment">/* 获取当前线程pcb指针 */</span><br><span class="hljs-keyword">struct</span> task_struct* <span class="hljs-title function_">running_thread</span><span class="hljs-params">()</span> &#123;<br>   <span class="hljs-type">uint32_t</span> esp; <br>   <span class="hljs-keyword">asm</span> (<span class="hljs-string">&quot;mov %%esp, %0&quot;</span> : <span class="hljs-string">&quot;=g&quot;</span> (esp));<br>  <span class="hljs-comment">/* 取esp整数部分即pcb起始地址 */</span><br>   <span class="hljs-keyword">return</span> (<span class="hljs-keyword">struct</span> task_struct*)(esp &amp; <span class="hljs-number">0xfffff000</span>);<br>&#125;<br><br><span class="hljs-comment">/* 由kernel_thread去执行function(func_arg) */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">kernel_thread</span><span class="hljs-params">(thread_func* function, <span class="hljs-type">void</span>* func_arg)</span> &#123;<br><span class="hljs-comment">/* 执行function前要开中断,避免后面的时钟中断被屏蔽,而无法调度其它线程 */</span><br>   intr_enable();<br>   function(func_arg); <br>&#125;<br><br><br><span class="hljs-comment">/* 初始化线程栈thread_stack,将待执行的函数和参数放到thread_stack中相应的位置 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">thread_create</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct* pthread, thread_func function, <span class="hljs-type">void</span>* func_arg)</span> &#123;<br>   <span class="hljs-comment">/* 先预留中断使用栈的空间,可见thread.h中定义的结构 */</span><br>   pthread-&gt;self_kstack -= <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> intr_stack);<br><br>   <span class="hljs-comment">/* 再留出线程栈空间,可见thread.h中定义 */</span><br>   pthread-&gt;self_kstack -= <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> thread_stack);<br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">thread_stack</span>* <span class="hljs-title">kthread_stack</span> =</span> (<span class="hljs-keyword">struct</span> thread_stack*)pthread-&gt;self_kstack;<br>   kthread_stack-&gt;eip = kernel_thread;<br>   kthread_stack-&gt;function = function;<br>   kthread_stack-&gt;func_arg = func_arg;<br>   kthread_stack-&gt;ebp = kthread_stack-&gt;ebx = kthread_stack-&gt;esi = kthread_stack-&gt;edi = <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/* 初始化线程基本信息 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">init_thread</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct* pthread, <span class="hljs-type">char</span>* name, <span class="hljs-type">int</span> prio)</span> &#123;<br>   <span class="hljs-built_in">memset</span>(pthread, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(*pthread));<br>   <span class="hljs-built_in">strcpy</span>(pthread-&gt;name, name);<br><br>   <span class="hljs-keyword">if</span> (pthread == main_thread) &#123;<br><span class="hljs-comment">/* 由于把main函数也封装成一个线程,并且它一直是运行的,故将其直接设为TASK_RUNNING */</span><br>      pthread-&gt;status = TASK_RUNNING;<br>   &#125; <span class="hljs-keyword">else</span> &#123;<br>      pthread-&gt;status = TASK_READY;<br>   &#125;<br><br><span class="hljs-comment">/* self_kstack是线程自己在内核态下使用的栈顶地址 */</span><br>   pthread-&gt;self_kstack = (<span class="hljs-type">uint32_t</span>*)((<span class="hljs-type">uint32_t</span>)pthread + PG_SIZE);<br>   pthread-&gt;priority = prio;<br>   pthread-&gt;ticks = prio;<br>   pthread-&gt;elapsed_ticks = <span class="hljs-number">0</span>;<br>   pthread-&gt;pgdir = <span class="hljs-literal">NULL</span>;<br>   pthread-&gt;stack_magic = <span class="hljs-number">0x19870916</span>;	  <span class="hljs-comment">// 自定义的魔数</span><br>&#125;<br><br><br><span class="hljs-comment">/* 创建一优先级为prio的线程,线程名为name,线程所执行的函数是function(func_arg) */</span><br><span class="hljs-keyword">struct</span> task_struct* <span class="hljs-title function_">thread_start</span><span class="hljs-params">(<span class="hljs-type">char</span>* name, <span class="hljs-type">int</span> prio, thread_func function, <span class="hljs-type">void</span>* func_arg)</span> &#123;<br><span class="hljs-comment">/* pcb都位于内核空间,包括用户进程的pcb也是在内核空间 */</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span>* <span class="hljs-title">thread</span> =</span> get_kernel_pages(<span class="hljs-number">1</span>);<br>   init_thread(thread, name, prio);<br>   thread_create(thread, function, func_arg);<br><br>   <span class="hljs-comment">/* 确保之前不在队列中 */</span><br>   ASSERT(!elem_find(&amp;thread_ready_list, &amp;thread-&gt;general_tag));<br>   <span class="hljs-comment">/* 加入就绪线程队列 */</span><br>   list_append(&amp;thread_ready_list, &amp;thread-&gt;general_tag);<br><br>   <span class="hljs-comment">/* 确保之前不在队列中 */</span><br>   ASSERT(!elem_find(&amp;thread_all_list, &amp;thread-&gt;all_list_tag));<br>   <span class="hljs-comment">/* 加入全部线程队列 */</span><br>   list_append(&amp;thread_all_list, &amp;thread-&gt;all_list_tag);<br><br>   <span class="hljs-keyword">return</span> thread;<br>&#125;<br><br><span class="hljs-comment">/* 将kernel中的main函数完善为主线程 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">make_main_thread</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br><span class="hljs-comment">/* 因为main线程早已运行,咱们在loader.S中进入内核时的mov esp,0xc009f000,</span><br><span class="hljs-comment">就是为其预留了tcb,地址为0xc009e000,因此不需要通过get_kernel_page另分配一页*/</span><br>   main_thread = running_thread();<br>   init_thread(main_thread, <span class="hljs-string">&quot;main&quot;</span>, <span class="hljs-number">31</span>);<br><br><span class="hljs-comment">/* main函数是当前线程,当前线程不在thread_ready_list中,</span><br><span class="hljs-comment"> * 所以只将其加在thread_all_list中. */</span><br>   ASSERT(!elem_find(&amp;thread_all_list, &amp;main_thread-&gt;all_list_tag));<br>   list_append(&amp;thread_all_list, &amp;main_thread-&gt;all_list_tag);<br>&#125;<br><br><span class="hljs-comment">/* 实现任务调度 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">schedule</span><span class="hljs-params">()</span> &#123;<br>   ASSERT(intr_get_status() == INTR_OFF);<br><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span>* <span class="hljs-title">cur</span> =</span> running_thread(); <br>   <span class="hljs-keyword">if</span> (cur-&gt;status == TASK_RUNNING) &#123; <span class="hljs-comment">// 若此线程只是cpu时间片到了,将其加入到就绪队列尾</span><br>      ASSERT(!elem_find(&amp;thread_ready_list, &amp;cur-&gt;general_tag));<br>      list_append(&amp;thread_ready_list, &amp;cur-&gt;general_tag);<br>      cur-&gt;ticks = cur-&gt;priority;     <span class="hljs-comment">// 重新将当前线程的ticks再重置为其priority;</span><br>      cur-&gt;status = TASK_READY;<br>   &#125; <span class="hljs-keyword">else</span> &#123; <br>      <span class="hljs-comment">/* 若此线程需要某事件发生后才能继续上cpu运行,</span><br><span class="hljs-comment">      不需要将其加入队列,因为当前线程不在就绪队列中。*/</span><br>   &#125;<br><br>  <br><br>   ASSERT(!list_empty(&amp;thread_ready_list));<br>   thread_tag = <span class="hljs-literal">NULL</span>;	  <span class="hljs-comment">// thread_tag清空</span><br><span class="hljs-comment">/* 将thread_ready_list队列中的第一个就绪线程弹出,准备将其调度上cpu. */</span><br>   thread_tag = list_pop(&amp;thread_ready_list);   <br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span>* <span class="hljs-title">next</span> =</span> elem2entry(<span class="hljs-keyword">struct</span> task_struct, general_tag, thread_tag);<br>   next-&gt;status = TASK_RUNNING;<br><br><br>   switch_to(cur, next);<br>&#125;<br><span class="hljs-comment">/* 初始化线程环境 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">thread_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>   put_str(<span class="hljs-string">&quot;thread_init start\n&quot;</span>);<br><br>   list_init(&amp;thread_ready_list);<br>   list_init(&amp;thread_all_list);<br><br><span class="hljs-comment">/* 将当前main函数创建为线程 */</span><br>   make_main_thread();<br><br>   put_str(<span class="hljs-string">&quot;thread_init done\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="kernelinterruptc增加"><a class="markdownIt-Anchor" href="#kernelinterruptc增加"></a> kernel/interrupt.c增加</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">register_handler</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> vector_no, intr_handler function)</span>;<br><br><span class="hljs-comment">/* 在中断处理程序数组第vector_no个元素中注册安装中断处理程序function */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">register_handler</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> vector_no, intr_handler function)</span> &#123;<br><span class="hljs-comment">/* idt_table数组中的函数是在进入中断后根据中断向量号调用的,</span><br><span class="hljs-comment"> * 见kernel/kernel.S的call [idt_table + %1*4] */</span><br>   idt_table[vector_no] = function; <br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="devicetimerc修改"><a class="markdownIt-Anchor" href="#devicetimerc修改"></a> device/timer.c修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;timer.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;io.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;interrupt.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;thread.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;debug.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IRQ0_FREQUENCY	   100</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INPUT_FREQUENCY	   1193180</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COUNTER0_VALUE	   INPUT_FREQUENCY / IRQ0_FREQUENCY</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CONTRER0_PORT	   0x40</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COUNTER0_NO	   0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COUNTER_MODE	   2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> READ_WRITE_LATCH   3</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIT_CONTROL_PORT   0x43</span><br><br><br><span class="hljs-type">uint32_t</span> ticks;          <span class="hljs-comment">// ticks是内核自中断开启以来总共的嘀嗒数</span><br><br><span class="hljs-comment">/* 把操作的计数器counter_no、读写锁属性rwl、计数器模式counter_mode写入模式控制寄存器并赋予初始值counter_value */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">frequency_set</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> counter_port, \</span><br><span class="hljs-params">			  <span class="hljs-type">uint8_t</span> counter_no, \</span><br><span class="hljs-params">			  <span class="hljs-type">uint8_t</span> rwl, \</span><br><span class="hljs-params">			  <span class="hljs-type">uint8_t</span> counter_mode, \</span><br><span class="hljs-params">			  <span class="hljs-type">uint16_t</span> counter_value)</span> &#123;<br><span class="hljs-comment">/* 往控制字寄存器端口0x43中写入控制字 */</span><br>   outb(PIT_CONTROL_PORT, (<span class="hljs-type">uint8_t</span>)(counter_no &lt;&lt; <span class="hljs-number">6</span> | rwl &lt;&lt; <span class="hljs-number">4</span> | counter_mode &lt;&lt; <span class="hljs-number">1</span>));<br><span class="hljs-comment">/* 先写入counter_value的低8位 */</span><br>   outb(counter_port, (<span class="hljs-type">uint8_t</span>)counter_value);<br><span class="hljs-comment">/* 再写入counter_value的高8位 */</span><br>   outb(counter_port, (<span class="hljs-type">uint8_t</span>)counter_value &gt;&gt; <span class="hljs-number">8</span>);<br>&#125;<br><br><span class="hljs-comment">/* 时钟的中断处理函数 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">intr_timer_handler</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span>* <span class="hljs-title">cur_thread</span> =</span> running_thread();<br><br>   ASSERT(cur_thread-&gt;stack_magic == <span class="hljs-number">0x19870916</span>);         <span class="hljs-comment">// 检查栈是否溢出</span><br><br>   cur_thread-&gt;elapsed_ticks++;	  <span class="hljs-comment">// 记录此线程占用的cpu时间嘀</span><br>   ticks++;	  <span class="hljs-comment">//从内核第一次处理时间中断后开始至今的滴哒数,内核态和用户态总共的嘀哒数</span><br><br>   <span class="hljs-keyword">if</span> (cur_thread-&gt;ticks == <span class="hljs-number">0</span>) &#123;	  <span class="hljs-comment">// 若进程时间片用完就开始调度新的进程上cpu</span><br>      schedule(); <br>   &#125; <span class="hljs-keyword">else</span> &#123;				  <span class="hljs-comment">// 将当前进程的时间片-1</span><br>      cur_thread-&gt;ticks--;<br>   &#125;<br>&#125;<br><br><br><br><span class="hljs-comment">/* 初始化PIT8253 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">timer_init</span><span class="hljs-params">()</span> &#123;<br>   put_str(<span class="hljs-string">&quot;timer_init start\n&quot;</span>);<br>   <span class="hljs-comment">/* 设置8253的定时周期,也就是发中断的周期 */</span><br>   frequency_set(CONTRER0_PORT, COUNTER0_NO, READ_WRITE_LATCH, COUNTER_MODE, COUNTER0_VALUE);<br>   register_handler(<span class="hljs-number">0x20</span>, intr_timer_handler);<br>   put_str(<span class="hljs-string">&quot;timer_init done\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="kernelinitc创建"><a class="markdownIt-Anchor" href="#kernelinitc创建"></a> kernel/init.c创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;init.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;interrupt.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../device/timer.h&quot;</span></span><br><br><br><span class="hljs-comment">/*负责初始化所有模块 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">init_all</span><span class="hljs-params">()</span> &#123;<br>   	put_str(<span class="hljs-string">&quot;init_all\n&quot;</span>);<br>   	idt_init();	     <span class="hljs-comment">// 初始化中断</span><br><br>   	mem_init();	     <span class="hljs-comment">// 初始化内存管理系统</span><br> 	thread_init();    <span class="hljs-comment">// 初始化线程相关结构</span><br>	timer_init();<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="threadswitchs创建"><a class="markdownIt-Anchor" href="#threadswitchs创建"></a> thread/switch.S创建</h3>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">[<span class="hljs-meta">bits</span> <span class="hljs-number">32</span>]<br><span class="hljs-meta">section</span> .text<br><span class="hljs-meta">global</span> switch_to<br><span class="hljs-symbol">switch_to:</span><br>   <span class="hljs-comment">;栈中此处是返回地址	       </span><br>   <span class="hljs-keyword">push</span> <span class="hljs-built_in">esi</span><br>   <span class="hljs-keyword">push</span> <span class="hljs-built_in">edi</span><br>   <span class="hljs-keyword">push</span> <span class="hljs-built_in">ebx</span><br>   <span class="hljs-keyword">push</span> <span class="hljs-built_in">ebp</span><br><br>   <span class="hljs-keyword">mov</span> <span class="hljs-built_in">eax</span>, [<span class="hljs-built_in">esp</span> + <span class="hljs-number">20</span>]		 <span class="hljs-comment">; 得到栈中的参数cur, cur = [esp+20]</span><br>   <span class="hljs-keyword">mov</span> [<span class="hljs-built_in">eax</span>], <span class="hljs-built_in">esp</span>                <span class="hljs-comment">; 保存栈顶指针esp. task_struct的self_kstack字段,</span><br>				 <span class="hljs-comment">; self_kstack在task_struct中的偏移为0,</span><br>				 <span class="hljs-comment">; 所以直接往thread开头处存4字节便可。</span><br><span class="hljs-comment">;------------------  以上是备份当前线程的环境，下面是恢复下一个线程的环境  ----------------</span><br>   <span class="hljs-keyword">mov</span> <span class="hljs-built_in">eax</span>, [<span class="hljs-built_in">esp</span> + <span class="hljs-number">24</span>]		 <span class="hljs-comment">; 得到栈中的参数next, next = [esp+24]</span><br>   <span class="hljs-keyword">mov</span> <span class="hljs-built_in">esp</span>, [<span class="hljs-built_in">eax</span>]		 <span class="hljs-comment">; pcb的第一个成员是self_kstack成员,用来记录0级栈顶指针,</span><br>				 <span class="hljs-comment">; 用来上cpu时恢复0级栈,0级栈中保存了进程或线程所有信息,包括3级栈指针</span><br>   <span class="hljs-keyword">pop</span> <span class="hljs-built_in">ebp</span><br>   <span class="hljs-keyword">pop</span> <span class="hljs-built_in">ebx</span><br>   <span class="hljs-keyword">pop</span> <span class="hljs-built_in">edi</span><br>   <span class="hljs-keyword">pop</span> <span class="hljs-built_in">esi</span><br>   <span class="hljs-keyword">ret</span>				 <span class="hljs-comment">; 返回到上面switch_to下面的那句注释的返回地址,</span><br>				 <span class="hljs-comment">; 未由中断进入,第一次执行时会返回到kernel_thread</span><br></code></pre></td></tr></table></figure>
<h3 id="kernelmainc修改-2"><a class="markdownIt-Anchor" href="#kernelmainc修改-2"></a> kernel/main.c修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;interrupt.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;init.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;thread.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">k_thread_a</span><span class="hljs-params">(<span class="hljs-type">void</span>* )</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">k_thread_b</span><span class="hljs-params">(<span class="hljs-type">void</span>* )</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>   put_str(<span class="hljs-string">&quot;I am kernel\n&quot;</span>);<br>   init_all();<br>	thread_start(<span class="hljs-string">&quot;k_thread_a&quot;</span>, <span class="hljs-number">31</span>, k_thread_a, <span class="hljs-string">&quot;argA &quot;</span>);<br>	thread_start(<span class="hljs-string">&quot;k_thread_b&quot;</span>, <span class="hljs-number">8</span>, k_thread_b, <span class="hljs-string">&quot;argB &quot;</span>);<br>   intr_enable();<br>   <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)&#123;<br>	put_str(<span class="hljs-string">&quot;Main &quot;</span>);<br>&#125;<br>   <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">k_thread_a</span><span class="hljs-params">(<span class="hljs-type">void</span>* arg)</span>&#123;<br>	<span class="hljs-type">char</span>* para = arg;<br>	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)&#123;<br>		put_str(para);<br>	&#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">k_thread_b</span><span class="hljs-params">(<span class="hljs-type">void</span>* arg)</span>&#123;<br>	<span class="hljs-type">char</span>* para = arg;<br>	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)&#123;<br>		put_str(para);<br>	&#125;		<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="实验结果"><a class="markdownIt-Anchor" href="#实验结果"></a> 实验结果</h3>
<p><img src="/img/os/os9.2.png" srcset="/img/loading.gif" lazyload alt="图为bochs运行界面" /></p>
<h2 id="写在后面"><a class="markdownIt-Anchor" href="#写在后面"></a> 写在后面</h2>
<p>做完这章愈发感觉自己的知识还很浅薄，在做完这剩下的几章之后，等过几个月回过头来再重新过一遍，这本书真心不错。</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a>
                    
                      <a class="hover-with-bg" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E7%9C%9F%E8%B1%A1%E8%BF%98%E5%8E%9F/">真象还原</a>
                    
                  </div>
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/07/26/os(10)/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">第十章 输入输出系统 锁机制实现</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/07/23/os(8)/">
                        <span class="hidden-mobile">第八章 浅尝makefile 实现assert和内存管理系统</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <div style="font-size: 0.85rem"> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>





  

  
    <!-- KaTeX -->
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0/dist/katex.min.css" />
  











<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
