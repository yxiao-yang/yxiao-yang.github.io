

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/app.png">
  <link rel="icon" href="/img/app.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="第八章 浅尝makefile 实现assert和内存管理系统  写在前面 已经22日了，距离本月结束只剩下9天的时间，奈何又要迎来连续四天的数学建模考试。压力已经伴随我很长时间了，回过头想想，其实压力是来源于现状跟不上内心的欲望，终归还是能力不足以让我从容摆平眼前的障碍。  实现assert断言  kernel&#x2F;interrupt.c新增 1234567891011121314151617181">
<meta property="og:type" content="article">
<meta property="og:title" content="第八章 浅尝makefile 实现assert和内存管理系统">
<meta property="og:url" content="http://example.com/2022/07/23/os(8)/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="第八章 浅尝makefile 实现assert和内存管理系统  写在前面 已经22日了，距离本月结束只剩下9天的时间，奈何又要迎来连续四天的数学建模考试。压力已经伴随我很长时间了，回过头想想，其实压力是来源于现状跟不上内心的欲望，终归还是能力不足以让我从容摆平眼前的障碍。  实现assert断言  kernel&#x2F;interrupt.c新增 1234567891011121314151617181">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/os/os8.1.png">
<meta property="article:published_time" content="2022-07-23T01:32:32.954Z">
<meta property="article:modified_time" content="2022-07-24T04:00:08.828Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/os/os8.1.png">
  
  
  <title>第八章 浅尝makefile 实现assert和内存管理系统 - Hexo</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":50,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>羊</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/bg2.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="第八章 浅尝makefile 实现assert和内存管理系统">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-07-23 09:32" pubdate>
        2022年7月23日 上午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      22k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      186 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">第八章 浅尝makefile 实现assert和内存管理系统</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：1 年前
                
              </p>
            
            <div class="markdown-body">
              <h1 id="第八章-浅尝makefile-实现assert和内存管理系统"><a class="markdownIt-Anchor" href="#第八章-浅尝makefile-实现assert和内存管理系统"></a> 第八章 浅尝makefile 实现assert和内存管理系统</h1>
<h2 id="写在前面"><a class="markdownIt-Anchor" href="#写在前面"></a> 写在前面</h2>
<p>已经22日了，距离本月结束只剩下9天的时间，奈何又要迎来连续四天的数学建模考试。压力已经伴随我很长时间了，回过头想想，其实压力是来源于现状跟不上内心的欲望，终归还是能力不足以让我从容摆平眼前的障碍。</p>
<h2 id="实现assert断言"><a class="markdownIt-Anchor" href="#实现assert断言"></a> 实现assert断言</h2>
<h3 id="kernelinterruptc新增"><a class="markdownIt-Anchor" href="#kernelinterruptc新增"></a> kernel/interrupt.c新增</h3>
<figure class="highlight c"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></div></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> EFLAGS_IF   0x00000200       <span class="hljs-comment">// eflags寄存器中的if位为1</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> GET_EFLAGS(EFLAG_VAR) asm volatile(<span class="hljs-string">&quot;pushfl; popl %0&quot;</span> : <span class="hljs-string">&quot;=g&quot;</span> (EFLAG_VAR))</span><br><br><br><span class="hljs-comment">/* 开中断并返回开中断前的状态*/</span><br><span class="hljs-keyword">enum</span> intr_status <span class="hljs-title function_">intr_enable</span><span class="hljs-params">()</span> &#123;<br>   <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">intr_status</span> <span class="hljs-title">old_status</span>;</span><br>   <span class="hljs-keyword">if</span> (INTR_ON == intr_get_status()) &#123;<br>      old_status = INTR_ON;<br>      <span class="hljs-keyword">return</span> old_status;<br>   &#125; <span class="hljs-keyword">else</span> &#123;<br>      old_status = INTR_OFF;<br>      <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span><span class="hljs-params">(<span class="hljs-string">&quot;sti&quot;</span>)</span>;	 <span class="hljs-comment">// 开中断,sti指令将IF位置1</span><br>      <span class="hljs-keyword">return</span> old_status;<br>   &#125;<br>&#125;<br><br><span class="hljs-comment">/* 关中断,并且返回关中断前的状态 */</span><br><span class="hljs-keyword">enum</span> intr_status <span class="hljs-title function_">intr_disable</span><span class="hljs-params">()</span> &#123;     <br>   <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">intr_status</span> <span class="hljs-title">old_status</span>;</span><br>   <span class="hljs-keyword">if</span> (INTR_ON == intr_get_status()) &#123;<br>      old_status = INTR_ON;<br>      <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span><span class="hljs-params">(<span class="hljs-string">&quot;cli&quot;</span> : : : <span class="hljs-string">&quot;memory&quot;</span>)</span>; <span class="hljs-comment">// 关中断,cli指令将IF位置0</span><br>      <span class="hljs-keyword">return</span> old_status;<br>   &#125; <span class="hljs-keyword">else</span> &#123;<br>      old_status = INTR_OFF;<br>      <span class="hljs-keyword">return</span> old_status;<br>   &#125;<br>&#125;<br><br><span class="hljs-comment">/* 将中断状态设置为status */</span><br><span class="hljs-keyword">enum</span> intr_status <span class="hljs-title function_">intr_set_status</span><span class="hljs-params">(<span class="hljs-keyword">enum</span> intr_status status)</span> &#123;<br>   <span class="hljs-keyword">return</span> status &amp; INTR_ON ? intr_enable() : intr_disable();<br>&#125;<br><br><span class="hljs-comment">/* 获取当前中断状态 */</span><br><span class="hljs-keyword">enum</span> intr_status <span class="hljs-title function_">intr_get_status</span><span class="hljs-params">()</span> &#123;<br>   <span class="hljs-type">uint32_t</span> eflags = <span class="hljs-number">0</span>; <br>   GET_EFLAGS(eflags);<br>   <span class="hljs-keyword">return</span> (EFLAGS_IF &amp; eflags) ? INTR_ON : INTR_OFF;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="kernelinterrupth修改"><a class="markdownIt-Anchor" href="#kernelinterrupth修改"></a> kernel/interrupt.h修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __KERNEL_INTERRUPT_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __KERNEL_INTERRUPT_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span>* intr_handler;<br><span class="hljs-type">void</span> <span class="hljs-title function_">idt_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><br><span class="hljs-comment">/* 定义中断的两种状态:</span><br><span class="hljs-comment"> * INTR_OFF值为0,表示关中断,</span><br><span class="hljs-comment"> * INTR_ON值为1,表示开中断 */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">intr_status</span> &#123;</span>		 <span class="hljs-comment">// 中断状态</span><br>    INTR_OFF,			 <span class="hljs-comment">// 中断关闭</span><br>    INTR_ON		         <span class="hljs-comment">// 中断打开</span><br>&#125;;<br><br><span class="hljs-keyword">enum</span> intr_status <span class="hljs-title function_">intr_get_status</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-keyword">enum</span> intr_status <span class="hljs-title function_">intr_set_status</span> <span class="hljs-params">(<span class="hljs-keyword">enum</span> intr_status)</span>;<br><span class="hljs-keyword">enum</span> intr_status <span class="hljs-title function_">intr_enable</span> <span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-keyword">enum</span> intr_status <span class="hljs-title function_">intr_disable</span> <span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">register_handler</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> vector_no, intr_handler function)</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
<h3 id="kerneldebugh创建"><a class="markdownIt-Anchor" href="#kerneldebugh创建"></a> kernel/debug.h创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __KERNEL_DEBUG_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __KERNEL_DEBUG_H</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">panic_spin</span><span class="hljs-params">(<span class="hljs-type">char</span>* filename, <span class="hljs-type">int</span> line, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* func, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* condition)</span>;<br><br><span class="hljs-comment">/***************************  __VA_ARGS__  *******************************</span><br><span class="hljs-comment"> * __VA_ARGS__ 是预处理器所支持的专用标识符。</span><br><span class="hljs-comment"> * 代表所有与省略号相对应的参数. </span><br><span class="hljs-comment"> * &quot;...&quot;表示定义的宏其参数可变.*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PANIC(...) panic_spin (__FILE__, __LINE__, __func__, __VA_ARGS__)</span><br> <span class="hljs-comment">/***********************************************************************/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> NDEBUG</span><br>   <span class="hljs-meta">#<span class="hljs-keyword">define</span> ASSERT(CONDITION) ((void)0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>   <span class="hljs-meta">#<span class="hljs-keyword">define</span> ASSERT(CONDITION)                                      \</span><br><span class="hljs-meta">      <span class="hljs-keyword">if</span> (CONDITION) &#123;&#125; <span class="hljs-keyword">else</span> &#123;                                    \</span><br><span class="hljs-meta">  <span class="hljs-comment">/* 符号#让编译器将宏的参数转化为字符串字面量 */</span>		  \</span><br><span class="hljs-meta">	 	PANIC(#CONDITION);                                       \</span><br><span class="hljs-meta">      &#125;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/*__NDEBUG */</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/*__KERNEL_DEBUG_H*/</span></span><br></code></pre></td></tr></table></figure>
<h3 id="kerneldebugc创建"><a class="markdownIt-Anchor" href="#kerneldebugc创建"></a> kernel/debug.c创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;debug.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;interrupt.h&quot;</span></span><br><br><span class="hljs-comment">/* 打印文件名,行号,函数名,条件并使程序悬停 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">panic_spin</span><span class="hljs-params">(<span class="hljs-type">char</span>* filename,	       \</span><br><span class="hljs-params">	        <span class="hljs-type">int</span> line,	       \</span><br><span class="hljs-params">		<span class="hljs-type">const</span> <span class="hljs-type">char</span>* func,      \</span><br><span class="hljs-params">		<span class="hljs-type">const</span> <span class="hljs-type">char</span>* condition)</span> \<br>&#123;<br>   intr_disable();	<span class="hljs-comment">// 因为有时候会单独调用panic_spin,所以在此处关中断。</span><br>   put_str(<span class="hljs-string">&quot;\n\n\n!!!!! error !!!!!\n&quot;</span>);<br>   put_str(<span class="hljs-string">&quot;filename:&quot;</span>);put_str(filename);put_str(<span class="hljs-string">&quot;\n&quot;</span>);<br>   put_str(<span class="hljs-string">&quot;line:0x&quot;</span>);put_int(line);put_str(<span class="hljs-string">&quot;\n&quot;</span>);<br>   put_str(<span class="hljs-string">&quot;function:&quot;</span>);put_str((<span class="hljs-type">char</span>*)func);put_str(<span class="hljs-string">&quot;\n&quot;</span>);<br>   put_str(<span class="hljs-string">&quot;condition:&quot;</span>);put_str((<span class="hljs-type">char</span>*)condition);put_str(<span class="hljs-string">&quot;\n&quot;</span>);<br>   <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="kernelmainc修改"><a class="markdownIt-Anchor" href="#kernelmainc修改"></a> kernel/main.c修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;init.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;debug.h&quot;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>   	put_str(<span class="hljs-string">&quot;I am kernel\n&quot;</span>);<br>   	init_all();<br><span class="hljs-comment">//	asm volatile(&quot;sti&quot;); //临时开中断</span><br>    ASSERT(<span class="hljs-number">1</span>==<span class="hljs-number">2</span>);<br>	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="makefile创建"><a class="markdownIt-Anchor" href="#makefile创建"></a> makefile创建</h3>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs clean">BUILD_DIR = ./build<br>ENTRY_POINT = <span class="hljs-number">0xc0001500</span><br>AS = nasm<br>CC = gcc<br>LD = ld<br>LIB = -I lib/ -I lib/kernel/ -I lib/user/ -I kernel/ -I device/ <br>ASFLAGS = -f elf<br>CFLAGS = -Wall -m32 -fno-stack-protector $(LIB) -c -fno-builtin -W -Wstrict-prototypes -Wmissing-prototypes<br>LDFLAGS =  -m elf_i386 -Ttext $(ENTRY_POINT) -e main -Map $(BUILD_DIR)/kernel.map<br>OBJS = $(BUILD_DIR)/main.o $(BUILD_DIR)/init.o $(BUILD_DIR)/interrupt.o \<br>      $(BUILD_DIR)/timer.o $(BUILD_DIR)/kernel.o $(BUILD_DIR)/print.o \<br>      $(BUILD_DIR)/debug.o <br>##############     c代码编译     ###############<br>$(BUILD_DIR)/main.o: kernel/main.c lib/kernel/print.h \<br>        lib/kernel/stdint.h kernel/init.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br><br>$(BUILD_DIR)/init.o: kernel/init.c kernel/init.h lib/kernel/print.h \<br>        lib/kernel/stdint.h kernel/interrupt.h device/timer.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br><br>$(BUILD_DIR)/interrupt.o: kernel/interrupt.c kernel/interrupt.h \<br>        lib/kernel/stdint.h kernel/global.h lib/kernel/io.h lib/kernel/print.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br><br>$(BUILD_DIR)/timer.o: device/timer.c device/timer.h lib/kernel/stdint.h \<br>        lib/kernel/io.h lib/kernel/print.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br><br>$(BUILD_DIR)/debug.o: kernel/debug.c kernel/debug.h \<br>        lib/kernel/print.h lib/kernel/stdint.h kernel/interrupt.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br><br><br>##############    汇编代码编译    ###############<br>$(BUILD_DIR)/kernel.o: kernel/kernel.S<br>	$(AS) $(ASFLAGS) $&lt; -o $@<br><br>$(BUILD_DIR)/print.o: lib/kernel/print.S<br>	$(AS) $(ASFLAGS) $&lt; -o $@<br><br>##############    链接所有目标文件    #############<br>$(BUILD_DIR)/kernel.bin: $(OBJS)<br>	$(LD) $(LDFLAGS) $^ -o $@<br><br>.PHONY : mk_dir hd clean all<br><br>mk_dir:<br>	<span class="hljs-keyword">if</span> [ ! -d $(BUILD_DIR) ]; then mkdir $(BUILD_DIR); fi<br><br>hd:<br>	dd <span class="hljs-keyword">if</span>=$(BUILD_DIR)/kernel.bin \<br>           <span class="hljs-keyword">of</span>=hd60M.img \<br>           bs=<span class="hljs-number">512</span> count=<span class="hljs-number">200</span> seek=<span class="hljs-number">9</span> conv=notrunc<br><br>clean:<br>	cd $(BUILD_DIR) &amp;&amp; rm -f  .<span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">build: $(BUILD_DIR)/kernel.bin</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">all: mk_dir build hd</span><br></code></pre></td></tr></table></figure>
<p>注意在写makefile时修改好路径，以后就直接一句make all就编译链接完了。</p>
<h2 id="实现字符串操作函数"><a class="markdownIt-Anchor" href="#实现字符串操作函数"></a> 实现字符串操作函数</h2>
<h3 id="libstringh创建"><a class="markdownIt-Anchor" href="#libstringh创建"></a> lib/string.h创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __LIB_STRING_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LIB_STRING_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NULL ((void*)0)</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">memset</span><span class="hljs-params">(<span class="hljs-type">void</span>* dst_, <span class="hljs-type">uint8_t</span> value, <span class="hljs-type">uint32_t</span> size)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">memcpy</span><span class="hljs-params">(<span class="hljs-type">void</span>* dst_, <span class="hljs-type">const</span> <span class="hljs-type">void</span>* src_, <span class="hljs-type">uint32_t</span> size)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">memcmp</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span>* a_, <span class="hljs-type">const</span> <span class="hljs-type">void</span>* b_, <span class="hljs-type">uint32_t</span> size)</span>;<br><span class="hljs-type">char</span>* <span class="hljs-title function_">strcpy</span><span class="hljs-params">(<span class="hljs-type">char</span>* dst_, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* src_)</span>;<br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">strlen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* str)</span>;<br><span class="hljs-type">int8_t</span> <span class="hljs-title function_">strcmp</span> <span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *a, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *b)</span>; <br><span class="hljs-type">char</span>* <span class="hljs-title function_">strchr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-built_in">string</span>, <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span> ch)</span>;<br><span class="hljs-type">char</span>* <span class="hljs-title function_">strrchr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-built_in">string</span>, <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span> ch)</span>;<br><span class="hljs-type">char</span>* <span class="hljs-title function_">strcat</span><span class="hljs-params">(<span class="hljs-type">char</span>* dst_, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* src_)</span>;<br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">strchrs</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* filename, <span class="hljs-type">uint8_t</span> ch)</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
<h3 id="libstringc创建"><a class="markdownIt-Anchor" href="#libstringc创建"></a> lib/string.c创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;string.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;global.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;debug.h&quot;</span></span><br><br><span class="hljs-comment">/* 将dst_起始的size个字节置为value */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">memset</span><span class="hljs-params">(<span class="hljs-type">void</span>* dst_, <span class="hljs-type">uint8_t</span> value, <span class="hljs-type">uint32_t</span> size)</span> &#123;<br>   ASSERT(dst_ != <span class="hljs-literal">NULL</span>);<br>   <span class="hljs-type">uint8_t</span>* dst = (<span class="hljs-type">uint8_t</span>*)dst_;<br>   <span class="hljs-keyword">while</span> (size-- &gt; <span class="hljs-number">0</span>)<br>      *dst++ = value;<br>&#125;<br><br><span class="hljs-comment">/* 将src_起始的size个字节复制到dst_ */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">memcpy</span><span class="hljs-params">(<span class="hljs-type">void</span>* dst_, <span class="hljs-type">const</span> <span class="hljs-type">void</span>* src_, <span class="hljs-type">uint32_t</span> size)</span> &#123;<br>   ASSERT(dst_ != <span class="hljs-literal">NULL</span> &amp;&amp; src_ != <span class="hljs-literal">NULL</span>);<br>   <span class="hljs-type">uint8_t</span>* dst = dst_;<br>   <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* src = src_;<br>   <span class="hljs-keyword">while</span> (size-- &gt; <span class="hljs-number">0</span>)<br>      *dst++ = *src++;<br>&#125;<br><br><span class="hljs-comment">/* 连续比较以地址a_和地址b_开头的size个字节,若相等则返回0,若a_大于b_返回+1,否则返回-1 */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">memcmp</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span>* a_, <span class="hljs-type">const</span> <span class="hljs-type">void</span>* b_, <span class="hljs-type">uint32_t</span> size)</span> &#123;<br>   <span class="hljs-type">const</span> <span class="hljs-type">char</span>* a = a_;<br>   <span class="hljs-type">const</span> <span class="hljs-type">char</span>* b = b_;<br>   ASSERT(a != <span class="hljs-literal">NULL</span> || b != <span class="hljs-literal">NULL</span>);<br>   <span class="hljs-keyword">while</span> (size-- &gt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">if</span>(*a != *b) &#123;<br>	 <span class="hljs-keyword">return</span> *a &gt; *b ? <span class="hljs-number">1</span> : <span class="hljs-number">-1</span>; <br>      &#125;<br>      a++;<br>      b++;<br>   &#125;<br>   <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/* 将字符串从src_复制到dst_ */</span><br><span class="hljs-type">char</span>* <span class="hljs-title function_">strcpy</span><span class="hljs-params">(<span class="hljs-type">char</span>* dst_, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* src_)</span> &#123;<br>   ASSERT(dst_ != <span class="hljs-literal">NULL</span> &amp;&amp; src_ != <span class="hljs-literal">NULL</span>);<br>   <span class="hljs-type">char</span>* r = dst_;		       <span class="hljs-comment">// 用来返回目的字符串起始地址</span><br>   <span class="hljs-keyword">while</span>((*dst_++ = *src_++));<br>   <span class="hljs-keyword">return</span> r;<br>&#125;<br><br><span class="hljs-comment">/* 返回字符串长度 */</span><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">strlen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* str)</span> &#123;<br>   ASSERT(str != <span class="hljs-literal">NULL</span>);<br>   <span class="hljs-type">const</span> <span class="hljs-type">char</span>* p = str;<br>   <span class="hljs-keyword">while</span>(*p++);<br>   <span class="hljs-keyword">return</span> (p - str - <span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-comment">/* 比较两个字符串,若a_中的字符大于b_中的字符返回1,相等时返回0,否则返回-1. */</span><br><span class="hljs-type">int8_t</span> <span class="hljs-title function_">strcmp</span> <span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* a, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* b)</span> &#123;<br>   ASSERT(a != <span class="hljs-literal">NULL</span> &amp;&amp; b != <span class="hljs-literal">NULL</span>);<br>   <span class="hljs-keyword">while</span> (*a != <span class="hljs-number">0</span> &amp;&amp; *a == *b) &#123;<br>      a++;<br>      b++;<br>   &#125;<br><span class="hljs-comment">/* 如果*a小于*b就返回-1,否则就属于*a大于等于*b的情况。在后面的布尔表达式&quot;*a &gt; *b&quot;中,</span><br><span class="hljs-comment"> * 若*a大于*b,表达式就等于1,否则就表达式不成立,也就是布尔值为0,恰恰表示*a等于*b */</span><br>   <span class="hljs-keyword">return</span> *a &lt; *b ? <span class="hljs-number">-1</span> : *a &gt; *b;<br>&#125;<br><br><span class="hljs-comment">/* 从左到右查找字符串str中首次出现字符ch的地址(不是下标,是地址) */</span><br><span class="hljs-type">char</span>* <span class="hljs-title function_">strchr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* str, <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span> ch)</span> &#123;<br>   ASSERT(str != <span class="hljs-literal">NULL</span>);<br>   <span class="hljs-keyword">while</span> (*str != <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">if</span> (*str == ch) &#123;<br>	 <span class="hljs-keyword">return</span> (<span class="hljs-type">char</span>*)str;	    <span class="hljs-comment">// 需要强制转化成和返回值类型一样,否则编译器会报const属性丢失,下同.</span><br>      &#125;<br>      str++;<br>   &#125;<br>   <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-comment">/* 从后往前查找字符串str中首次出现字符ch的地址(不是下标,是地址) */</span><br><span class="hljs-type">char</span>* <span class="hljs-title function_">strrchr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* str, <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span> ch)</span> &#123;<br>   ASSERT(str != <span class="hljs-literal">NULL</span>);<br>   <span class="hljs-type">const</span> <span class="hljs-type">char</span>* last_char = <span class="hljs-literal">NULL</span>;<br>   <span class="hljs-comment">/* 从头到尾遍历一次,若存在ch字符,last_char总是该字符最后一次出现在串中的地址(不是下标,是地址)*/</span><br>   <span class="hljs-keyword">while</span> (*str != <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">if</span> (*str == ch) &#123;<br>	 last_char = str;<br>      &#125;<br>      str++;<br>   &#125;<br>   <span class="hljs-keyword">return</span> (<span class="hljs-type">char</span>*)last_char;<br>&#125;<br><br><span class="hljs-comment">/* 将字符串src_拼接到dst_后,将回拼接的串地址 */</span><br><span class="hljs-type">char</span>* <span class="hljs-title function_">strcat</span><span class="hljs-params">(<span class="hljs-type">char</span>* dst_, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* src_)</span> &#123;<br>   ASSERT(dst_ != <span class="hljs-literal">NULL</span> &amp;&amp; src_ != <span class="hljs-literal">NULL</span>);<br>   <span class="hljs-type">char</span>* str = dst_;<br>   <span class="hljs-keyword">while</span> (*str++);<br>   --str;      <span class="hljs-comment">// 别看错了，--str是独立的一句，并不是while的循环体</span><br>   <span class="hljs-keyword">while</span>((*str++ = *src_++));	 <span class="hljs-comment">// 当*str被赋值为0时,此时表达式不成立,正好添加了字符串结尾的0.</span><br>   <span class="hljs-keyword">return</span> dst_;<br>&#125;<br><br><span class="hljs-comment">/* 在字符串str中查找指定字符ch出现的次数 */</span><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">strchrs</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* str, <span class="hljs-type">uint8_t</span> ch)</span> &#123;<br>   ASSERT(str != <span class="hljs-literal">NULL</span>);<br>   <span class="hljs-type">uint32_t</span> ch_cnt = <span class="hljs-number">0</span>;<br>   <span class="hljs-type">const</span> <span class="hljs-type">char</span>* p = str;<br>   <span class="hljs-keyword">while</span>(*p != <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">if</span> (*p == ch) &#123;<br>	 ch_cnt++;<br>      &#125;<br>      p++;<br>   &#125;<br>   <span class="hljs-keyword">return</span> ch_cnt;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="位图bitmap及其函数实现"><a class="markdownIt-Anchor" href="#位图bitmap及其函数实现"></a> 位图bitmap及其函数实现</h2>
<h3 id="libkernelbitmaph创建"><a class="markdownIt-Anchor" href="#libkernelbitmaph创建"></a> lib/kernel/bitmap.h创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __LIB_KERNEL_BITMAP_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LIB_KERNEL_BITMAP_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;global.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BITMAP_MASK 1</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bitmap</span> &#123;</span><br>   <span class="hljs-type">uint32_t</span> btmp_bytes_len;<br><span class="hljs-comment">/* 在遍历位图时,整体上以字节为单位,细节上是以位为单位,所以此处位图的指针必须是单字节 */</span><br>   <span class="hljs-type">uint8_t</span>* bits;<br>&#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">bitmap_init</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bitmap* btmp)</span>;<br><span class="hljs-type">bool</span> <span class="hljs-title function_">bitmap_scan_test</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bitmap* btmp, <span class="hljs-type">uint32_t</span> bit_idx)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">bitmap_scan</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bitmap* btmp, <span class="hljs-type">uint32_t</span> cnt)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">bitmap_set</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bitmap* btmp, <span class="hljs-type">uint32_t</span> bit_idx, <span class="hljs-type">int8_t</span> value)</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
<h3 id="libkernelbitmapc创建"><a class="markdownIt-Anchor" href="#libkernelbitmapc创建"></a> lib/kernel/bitmap.c创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;bitmap.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;string.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;interrupt.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;debug.h&quot;</span></span><br><br><span class="hljs-comment">/* 将位图btmp初始化 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">bitmap_init</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bitmap* btmp)</span> &#123;<br>   <span class="hljs-built_in">memset</span>(btmp-&gt;bits, <span class="hljs-number">0</span>, btmp-&gt;btmp_bytes_len);   <br>&#125;<br><br><span class="hljs-comment">/* 判断bit_idx位是否为1,若为1则返回true，否则返回false */</span><br><span class="hljs-type">bool</span> <span class="hljs-title function_">bitmap_scan_test</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bitmap* btmp, <span class="hljs-type">uint32_t</span> bit_idx)</span> &#123;<br>   <span class="hljs-type">uint32_t</span> byte_idx = bit_idx / <span class="hljs-number">8</span>;    <span class="hljs-comment">// 向下取整用于索引数组下标</span><br>   <span class="hljs-type">uint32_t</span> bit_odd  = bit_idx % <span class="hljs-number">8</span>;    <span class="hljs-comment">// 取余用于索引数组内的位</span><br>   <span class="hljs-keyword">return</span> (btmp-&gt;bits[byte_idx] &amp; (BITMAP_MASK &lt;&lt; bit_odd));<br>&#125;<br><br><span class="hljs-comment">/* 在位图中申请连续cnt个位,返回其起始位下标 */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">bitmap_scan</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bitmap* btmp, <span class="hljs-type">uint32_t</span> cnt)</span> &#123;<br>   <span class="hljs-type">uint32_t</span> idx_byte = <span class="hljs-number">0</span>;	 <span class="hljs-comment">// 用于记录空闲位所在的字节</span><br><span class="hljs-comment">/* 先逐字节比较,蛮力法 */</span><br>   <span class="hljs-keyword">while</span> (( <span class="hljs-number">0xff</span> == btmp-&gt;bits[idx_byte]) &amp;&amp; (idx_byte &lt; btmp-&gt;btmp_bytes_len)) &#123;<br><span class="hljs-comment">/* 1表示该位已分配,所以若为0xff,则表示该字节内已无空闲位,向下一字节继续找 */</span><br>      idx_byte++;<br>   &#125;<br><br>   ASSERT(idx_byte &lt; btmp-&gt;btmp_bytes_len);<br>   <span class="hljs-keyword">if</span> (idx_byte == btmp-&gt;btmp_bytes_len) &#123;  <span class="hljs-comment">// 若该内存池找不到可用空间		</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>   &#125;<br><br> <span class="hljs-comment">/* 若在位图数组范围内的某字节内找到了空闲位，</span><br><span class="hljs-comment">  * 在该字节内逐位比对,返回空闲位的索引。*/</span><br>   <span class="hljs-type">int</span> idx_bit = <span class="hljs-number">0</span>;<br> <span class="hljs-comment">/* 和btmp-&gt;bits[idx_byte]这个字节逐位对比 */</span><br>   <span class="hljs-keyword">while</span> ((<span class="hljs-type">uint8_t</span>)(BITMAP_MASK &lt;&lt; idx_bit) &amp; btmp-&gt;bits[idx_byte]) &#123; <br>	 idx_bit++;<br>   &#125;<br>	 <br>   <span class="hljs-type">int</span> bit_idx_start = idx_byte * <span class="hljs-number">8</span> + idx_bit;    <span class="hljs-comment">// 空闲位在位图内的下标</span><br>   <span class="hljs-keyword">if</span> (cnt == <span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-keyword">return</span> bit_idx_start;<br>   &#125;<br><br>   <span class="hljs-type">uint32_t</span> bit_left = (btmp-&gt;btmp_bytes_len * <span class="hljs-number">8</span> - bit_idx_start - <span class="hljs-number">1</span>);   <span class="hljs-comment">// 记录还有多少位可以判断（原来无减一）</span><br>   <span class="hljs-type">uint32_t</span> next_bit = bit_idx_start + <span class="hljs-number">1</span>;<br>   <span class="hljs-type">uint32_t</span> count = <span class="hljs-number">1</span>;	      <span class="hljs-comment">// 用于记录找到的空闲位的个数</span><br><br>   bit_idx_start = <span class="hljs-number">-1</span>;	      <span class="hljs-comment">// 先将其置为-1,若找不到连续的位就直接返回</span><br>   <span class="hljs-keyword">while</span> (bit_left-- &gt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">if</span> (!(bitmap_scan_test(btmp, next_bit))) &#123;	 <span class="hljs-comment">// 若next_bit为0</span><br>	 count++;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>	 count = <span class="hljs-number">0</span>;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (count == cnt) &#123;	    <span class="hljs-comment">// 若找到连续的cnt个空位</span><br>	 bit_idx_start = next_bit - cnt + <span class="hljs-number">1</span>;<br>	 <span class="hljs-keyword">break</span>;<br>      &#125;<br>      next_bit++;          <br>   &#125;<br>   <span class="hljs-keyword">return</span> bit_idx_start;<br>&#125;<br><br><span class="hljs-comment">/* 将位图btmp的bit_idx位设置为value */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">bitmap_set</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bitmap* btmp, <span class="hljs-type">uint32_t</span> bit_idx, <span class="hljs-type">int8_t</span> value)</span> &#123;<br>   ASSERT((value == <span class="hljs-number">0</span>) || (value == <span class="hljs-number">1</span>));<br>   <span class="hljs-type">uint32_t</span> byte_idx = bit_idx / <span class="hljs-number">8</span>;    <span class="hljs-comment">// 向下取整用于索引数组下标</span><br>   <span class="hljs-type">uint32_t</span> bit_odd  = bit_idx % <span class="hljs-number">8</span>;    <span class="hljs-comment">// 取余用于索引数组内的位</span><br><br><span class="hljs-comment">/* 一般都会用个0x1这样的数对字节中的位操作,</span><br><span class="hljs-comment"> * 将1任意移动后再取反,或者先取反再移位,可用来对位置0操作。*/</span><br>   <span class="hljs-keyword">if</span> (value) &#123;		      <span class="hljs-comment">// 如果value为1</span><br>      btmp-&gt;bits[byte_idx] |= (BITMAP_MASK &lt;&lt; bit_odd);<br>   &#125; <span class="hljs-keyword">else</span> &#123;		      <span class="hljs-comment">// 若为0</span><br>      btmp-&gt;bits[byte_idx] &amp;= ~(BITMAP_MASK &lt;&lt; bit_odd);<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="内存管理系统"><a class="markdownIt-Anchor" href="#内存管理系统"></a> 内存管理系统</h2>
<p>通过分页实验已经很清楚，虚拟地址——实地址的映射规则依赖的是页表。对于所有进程和内核来说，都有自己独立的虚拟内存池，独立的页表。这就是为什么每个进程都有自己的独立的4GB，因为即使两个进程访问同一个虚拟地址，不同的页表会得到不同的物理地址映射。</p>
<h3 id="kernelmemoryh创建"><a class="markdownIt-Anchor" href="#kernelmemoryh创建"></a> kernel/memory.h创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __KERNEL_MEMORY_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __KERNEL_MEMORY_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;bitmap.h&quot;</span></span><br><br><span class="hljs-comment">/* 内存池标记,用于判断用哪个内存池 */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">pool_flags</span> &#123;</span><br>  PF_KERNEL = <span class="hljs-number">1</span>,    <span class="hljs-comment">// 内核内存池</span><br>  PF_USER = <span class="hljs-number">2</span>	     <span class="hljs-comment">// 用户内存池</span><br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>	 PG_P_1	  1	<span class="hljs-comment">// 页表项或页目录项存在属性位</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>	 PG_P_0	  0	<span class="hljs-comment">// 页表项或页目录项存在属性位</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>	 PG_RW_R  0	<span class="hljs-comment">// R/W 属性位值, 读/执行</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>	 PG_RW_W  2	<span class="hljs-comment">// R/W 属性位值, 读/写/执行</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>	 PG_US_S  0	<span class="hljs-comment">// U/S 属性位值, 系统级</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>	 PG_US_U  4	<span class="hljs-comment">// U/S 属性位值, 用户级</span></span><br><br><span class="hljs-comment">/* 用于虚拟地址管理 */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtual_addr</span> &#123;</span><br><span class="hljs-comment">/* 虚拟地址用到的位图结构，用于记录哪些虚拟地址被占用了。以页为单位。*/</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bitmap</span> <span class="hljs-title">vaddr_bitmap</span>;</span><br><span class="hljs-comment">/* 管理的虚拟地址 */</span><br>  <span class="hljs-type">uint32_t</span> vaddr_start;<br>&#125;;<br><br><span class="hljs-keyword">extern</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pool</span> <span class="hljs-title">kernel_pool</span>, <span class="hljs-title">user_pool</span>;</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">mem_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">void</span>* <span class="hljs-title function_">get_kernel_pages</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> pg_cnt)</span>;<br><span class="hljs-type">void</span>* <span class="hljs-title function_">malloc_page</span><span class="hljs-params">(<span class="hljs-keyword">enum</span> pool_flags pf, <span class="hljs-type">uint32_t</span> pg_cnt)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">malloc_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">uint32_t</span>* <span class="hljs-title function_">pte_ptr</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> vaddr)</span>;<br><span class="hljs-type">uint32_t</span>* <span class="hljs-title function_">pde_ptr</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> vaddr)</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
<h3 id="kernelglobalh新增"><a class="markdownIt-Anchor" href="#kernelglobalh新增"></a> kernel/global.h新增</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> NULL ((void*)0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> bool int</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> true 1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> false 0</span><br></code></pre></td></tr></table></figure>
<h3 id="kernelmemoryc创建"><a class="markdownIt-Anchor" href="#kernelmemoryc创建"></a> kernel/memory.c创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;memory.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;bitmap.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;global.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;debug.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;string.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;interrupt.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PG_SIZE 4096</span><br><br><span class="hljs-comment">/***************  位图地址 ********************</span><br><span class="hljs-comment">* 因为0xc009f000是内核主线程栈顶，0xc009e000是内核主线程的pcb.</span><br><span class="hljs-comment">* 一个页框大小的位图可表示128M内存, 位图位置安排在地址0xc009a000,</span><br><span class="hljs-comment">* 这样本系统最大支持4个页框的位图,即512M内存 */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MEM_BITMAP_BASE 0xc009a000</span><br><span class="hljs-comment">/*************************************/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PDE_IDX(addr) ((addr &amp; 0xffc00000) &gt;&gt; 22)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTE_IDX(addr) ((addr &amp; 0x003ff000) &gt;&gt; 12)</span><br><br><span class="hljs-comment">/* 0xc0000000是内核从虚拟地址3G起. 0x100000意指跨过低端1M内存,使虚拟地址在逻辑上连续 */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> K_HEAP_START 0xc0100000</span><br><br><span class="hljs-comment">/* 内存池结构,生成两个实例用于管理内核内存池和用户内存池 */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pool</span> &#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bitmap</span> <span class="hljs-title">pool_bitmap</span>;</span>	 <span class="hljs-comment">// 本内存池用到的位图结构,用于管理物理内存</span><br>  <span class="hljs-type">uint32_t</span> phy_addr_start;	 <span class="hljs-comment">// 本内存池所管理物理内存的起始地址</span><br>  <span class="hljs-type">uint32_t</span> pool_size;		 <span class="hljs-comment">// 本内存池字节容量</span><br>&#125;;<br><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pool</span> <span class="hljs-title">kernel_pool</span>, <span class="hljs-title">user_pool</span>;</span>      <span class="hljs-comment">// 生成内核内存池和用户内存池</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtual_addr</span> <span class="hljs-title">kernel_vaddr</span>;</span>	 <span class="hljs-comment">// 此结构是用来给内核分配虚拟地址</span><br><br><span class="hljs-comment">/* 在pf表示的虚拟内存池中申请pg_cnt个虚拟页,</span><br><span class="hljs-comment">* 成功则返回虚拟页的起始地址, 失败则返回NULL */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span>* <span class="hljs-title function_">vaddr_get</span><span class="hljs-params">(<span class="hljs-keyword">enum</span> pool_flags pf, <span class="hljs-type">uint32_t</span> pg_cnt)</span> &#123;<br>  <span class="hljs-type">int</span> vaddr_start = <span class="hljs-number">0</span>, bit_idx_start = <span class="hljs-number">-1</span>;<br>  <span class="hljs-type">uint32_t</span> cnt = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> (pf == PF_KERNEL) &#123;     <span class="hljs-comment">// 内核内存池</span><br>     bit_idx_start  = bitmap_scan(&amp;kernel_vaddr.vaddr_bitmap, pg_cnt);<br>     <span class="hljs-keyword">if</span> (bit_idx_start == <span class="hljs-number">-1</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>     &#125;<br>     <span class="hljs-keyword">while</span>(cnt &lt; pg_cnt) &#123;<br>    bitmap_set(&amp;kernel_vaddr.vaddr_bitmap, bit_idx_start + cnt++, <span class="hljs-number">1</span>);<br>     &#125;<br>     vaddr_start = kernel_vaddr.vaddr_start + bit_idx_start * PG_SIZE;<br>  &#125; <span class="hljs-keyword">else</span> &#123;	     <span class="hljs-comment">// 用户内存池	</span><br>     <span class="hljs-comment">//将来实现用户进程再补充</span><br>    	 &#125;<br>  <br>  <span class="hljs-keyword">return</span> (<span class="hljs-type">void</span>*)vaddr_start;<br>&#125;<br><br><span class="hljs-comment">/* 得到虚拟地址vaddr对应的pte指针*/</span><br><span class="hljs-type">uint32_t</span>* <span class="hljs-title function_">pte_ptr</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> vaddr)</span> &#123;<br>  <span class="hljs-comment">/* 先访问到页表自己 + \</span><br><span class="hljs-comment">   * 再用页目录项pde(页目录内页表的索引)做为pte的索引访问到页表 + \</span><br><span class="hljs-comment">   * 再用pte的索引做为页内偏移*/</span><br>  <span class="hljs-type">uint32_t</span>* pte = (<span class="hljs-type">uint32_t</span>*)(<span class="hljs-number">0xffc00000</span> + \<br>    ((vaddr &amp; <span class="hljs-number">0xffc00000</span>) &gt;&gt; <span class="hljs-number">10</span>) + \<br>    PTE_IDX(vaddr) * <span class="hljs-number">4</span>);<br>  <span class="hljs-keyword">return</span> pte;<br>&#125;<br><br><span class="hljs-comment">/* 得到虚拟地址vaddr对应的pde的指针 */</span><br><span class="hljs-type">uint32_t</span>* <span class="hljs-title function_">pde_ptr</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> vaddr)</span> &#123;<br>  <span class="hljs-comment">/* 0xfffff是用来访问到页表本身所在的地址 */</span><br>  <span class="hljs-type">uint32_t</span>* pde = (<span class="hljs-type">uint32_t</span>*)((<span class="hljs-number">0xfffff000</span>) + PDE_IDX(vaddr) * <span class="hljs-number">4</span>);<br>  <span class="hljs-keyword">return</span> pde;<br>&#125;<br><br><span class="hljs-comment">/* 在m_pool指向的物理内存池中分配1个物理页,</span><br><span class="hljs-comment">* 成功则返回页框的物理地址,失败则返回NULL */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span>* <span class="hljs-title function_">palloc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pool* m_pool)</span> &#123;<br>  <span class="hljs-comment">/* 扫描或设置位图要保证原子操作 */</span><br>  <span class="hljs-type">int</span> bit_idx = bitmap_scan(&amp;m_pool-&gt;pool_bitmap, <span class="hljs-number">1</span>);    <span class="hljs-comment">// 找一个物理页面</span><br>  <span class="hljs-keyword">if</span> (bit_idx == <span class="hljs-number">-1</span> ) &#123;<br>     <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>  &#125;<br>  bitmap_set(&amp;m_pool-&gt;pool_bitmap, bit_idx, <span class="hljs-number">1</span>);	<span class="hljs-comment">// 将此位bit_idx置1</span><br>  <span class="hljs-type">uint32_t</span> page_phyaddr = ((bit_idx * PG_SIZE) + m_pool-&gt;phy_addr_start);<br>  <span class="hljs-keyword">return</span> (<span class="hljs-type">void</span>*)page_phyaddr;<br>&#125;<br><br><span class="hljs-comment">/* 页表中添加虚拟地址_vaddr与物理地址_page_phyaddr的映射 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">page_table_add</span><span class="hljs-params">(<span class="hljs-type">void</span>* _vaddr, <span class="hljs-type">void</span>* _page_phyaddr)</span> &#123;<br>  <span class="hljs-type">uint32_t</span> vaddr = (<span class="hljs-type">uint32_t</span>)_vaddr, page_phyaddr = (<span class="hljs-type">uint32_t</span>)_page_phyaddr;<br>  <span class="hljs-type">uint32_t</span>* pde = pde_ptr(vaddr);<br>  <span class="hljs-type">uint32_t</span>* pte = pte_ptr(vaddr);<br><br><span class="hljs-comment">/************************   注意   *************************</span><br><span class="hljs-comment">* 执行*pte,会访问到pde。所以确保pde创建完成后才能执行*pte,</span><br><span class="hljs-comment">* 否则会引发page_fault。因此在pde未创建时,</span><br><span class="hljs-comment">* *pte只能出现在下面最外层else语句块中的*pde后面。</span><br><span class="hljs-comment">* *********************************************************/</span><br>  <span class="hljs-comment">/* 先在页目录内判断目录项的P位，若为1,则表示该表已存在 */</span><br>  <span class="hljs-keyword">if</span> (*pde &amp; <span class="hljs-number">0x00000001</span>) &#123;<br>     ASSERT(!(*pte &amp; <span class="hljs-number">0x00000001</span>));<br><br>     <span class="hljs-keyword">if</span> (!(*pte &amp; <span class="hljs-number">0x00000001</span>)) &#123;   <span class="hljs-comment">// 只要是创建页表,pte就应该不存在,多判断一下放心</span><br>    *pte = (page_phyaddr | PG_US_U | PG_RW_W | PG_P_1);    <span class="hljs-comment">// US=1,RW=1,P=1</span><br>     &#125; <span class="hljs-keyword">else</span> &#123;	  <span class="hljs-comment">// 调试模式下不会执行到此,上面的ASSERT会先执行.关闭调试时下面的PANIC会起作用</span><br>    PANIC(<span class="hljs-string">&quot;pte repeat&quot;</span>);<br>     &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;	   <span class="hljs-comment">// 页目录项不存在,所以要先创建页目录项再创建页表项.</span><br>     <span class="hljs-comment">/* 页表中用到的页框一律从内核空间分配 */</span><br>     <span class="hljs-type">uint32_t</span> pde_phyaddr = (<span class="hljs-type">uint32_t</span>)palloc(&amp;kernel_pool);<br>     *pde = (pde_phyaddr | PG_US_U | PG_RW_W | PG_P_1);<br><br><span class="hljs-comment">/*******************   必须将页表所在的页清0   *********************</span><br><span class="hljs-comment">* 必须把分配到的物理页地址pde_phyaddr对应的物理内存清0,</span><br><span class="hljs-comment">* 避免里面的陈旧数据变成了页表中的页表项,从而让页表混乱.</span><br><span class="hljs-comment">* pte的高20位会映射到pde所指向的页表的物理起始地址.*/</span><br>     <span class="hljs-built_in">memset</span>((<span class="hljs-type">void</span>*)((<span class="hljs-type">int</span>)pte &amp; <span class="hljs-number">0xfffff000</span>), <span class="hljs-number">0</span>, PG_SIZE); <br><span class="hljs-comment">/************************************************************/</span><br>     ASSERT(!(*pte &amp; <span class="hljs-number">0x00000001</span>));<br>     *pte = (page_phyaddr | PG_US_U | PG_RW_W | PG_P_1);      <span class="hljs-comment">// US=1,RW=1,P=1</span><br>  &#125;<br>&#125;<br><br><span class="hljs-comment">/* 分配pg_cnt个页空间,成功则返回起始虚拟地址,失败时返回NULL */</span><br><span class="hljs-type">void</span>* <span class="hljs-title function_">malloc_page</span><span class="hljs-params">(<span class="hljs-keyword">enum</span> pool_flags pf, <span class="hljs-type">uint32_t</span> pg_cnt)</span> &#123;<br>  ASSERT(pg_cnt &gt; <span class="hljs-number">0</span> &amp;&amp; pg_cnt &lt; <span class="hljs-number">3840</span>);<br><span class="hljs-comment">/***********   malloc_page的原理是三个动作的合成:   ***********</span><br><span class="hljs-comment">     1通过vaddr_get在虚拟内存池中申请虚拟地址</span><br><span class="hljs-comment">     2通过palloc在物理内存池中申请物理页</span><br><span class="hljs-comment">     3通过page_table_add将以上两步得到的虚拟地址和物理地址在页表中完成映射</span><br><span class="hljs-comment">***************************************************************/</span><br>  <span class="hljs-type">void</span>* vaddr_start = vaddr_get(pf, pg_cnt);<br>  <span class="hljs-keyword">if</span> (vaddr_start == <span class="hljs-literal">NULL</span>) &#123;<br>     <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>  &#125;<br>  <span class="hljs-type">uint32_t</span> vaddr = (<span class="hljs-type">uint32_t</span>)vaddr_start, cnt = pg_cnt;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pool</span>* <span class="hljs-title">mem_pool</span> =</span> pf &amp; PF_KERNEL ? &amp;kernel_pool : &amp;user_pool;<br><br><span class="hljs-comment">/* 因为虚拟地址是连续的,但物理地址可以是不连续的,所以逐个做映射*/</span><br>  <span class="hljs-keyword">while</span> (cnt-- &gt; <span class="hljs-number">0</span>) &#123;<br>     <span class="hljs-type">void</span>* page_phyaddr = palloc(mem_pool);<br><br><span class="hljs-comment">/* 失败时要将曾经已申请的虚拟地址和物理页全部回滚，</span><br><span class="hljs-comment">* 在将来完成内存回收时再补充 */</span><br>     <span class="hljs-keyword">if</span> (page_phyaddr == <span class="hljs-literal">NULL</span>) &#123;  <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>     &#125;<br>     page_table_add((<span class="hljs-type">void</span>*)vaddr, page_phyaddr); <span class="hljs-comment">// 在页表中做映射 </span><br>     vaddr += PG_SIZE;		 <span class="hljs-comment">// 下一个虚拟页</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> vaddr_start;<br>&#125;<br><br><span class="hljs-comment">/* 从内核物理内存池中申请pg_cnt页内存,</span><br><span class="hljs-comment">* 成功则返回其虚拟地址,失败则返回NULL */</span><br><span class="hljs-type">void</span>* <span class="hljs-title function_">get_kernel_pages</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> pg_cnt)</span> &#123;<br>  <span class="hljs-type">void</span>* vaddr =  malloc_page(PF_KERNEL, pg_cnt);<br>  <span class="hljs-keyword">if</span> (vaddr != <span class="hljs-literal">NULL</span>) &#123;	   <span class="hljs-comment">// 若分配的地址不为空,将页框清0后返回</span><br>     <span class="hljs-built_in">memset</span>(vaddr, <span class="hljs-number">0</span>, pg_cnt * PG_SIZE);<br>  &#125;<br>  <span class="hljs-keyword">return</span> vaddr;<br>&#125;<br><br><br><span class="hljs-comment">/* 初始化内存池 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">mem_pool_init</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> all_mem)</span> &#123;<br>  put_str(<span class="hljs-string">&quot;   mem_pool_init start\n&quot;</span>);<br>  <span class="hljs-type">uint32_t</span> page_table_size = PG_SIZE * <span class="hljs-number">256</span>;	  <span class="hljs-comment">// 页表大小= 1页的页目录表+第0和第768个页目录项指向同一个页表+</span><br>                                                 <span class="hljs-comment">// 第769~1022个页目录项共指向254个页表,共256个页框</span><br>  <span class="hljs-type">uint32_t</span> used_mem = page_table_size + <span class="hljs-number">0x100000</span>;	  <span class="hljs-comment">// 0x100000为低端1M内存</span><br>  <span class="hljs-type">uint32_t</span> free_mem = all_mem - used_mem;<br>  <span class="hljs-type">uint16_t</span> all_free_pages = free_mem / PG_SIZE;		  <span class="hljs-comment">// 1页为4k,不管总内存是不是4k的倍数,</span><br>   						  <span class="hljs-comment">// 对于以页为单位的内存分配策略，不足1页的内存不用考虑了。</span><br>  <span class="hljs-type">uint16_t</span> kernel_free_pages = all_free_pages / <span class="hljs-number">2</span>;<br>  <span class="hljs-type">uint16_t</span> user_free_pages = all_free_pages - kernel_free_pages;<br><br><span class="hljs-comment">/* 为简化位图操作，余数不处理，坏处是这样做会丢内存。</span><br><span class="hljs-comment">好处是不用做内存的越界检查,因为位图表示的内存少于实际物理内存*/</span><br>  <span class="hljs-type">uint32_t</span> kbm_length = kernel_free_pages / <span class="hljs-number">8</span>;			  <span class="hljs-comment">// Kernel BitMap的长度,位图中的一位表示一页,以字节为单位</span><br>  <span class="hljs-type">uint32_t</span> ubm_length = user_free_pages / <span class="hljs-number">8</span>;			  <span class="hljs-comment">// User BitMap的长度.</span><br><br>  <span class="hljs-type">uint32_t</span> kp_start = used_mem;				  <span class="hljs-comment">// Kernel Pool start,内核内存池的起始地址</span><br>  <span class="hljs-type">uint32_t</span> up_start = kp_start + kernel_free_pages * PG_SIZE;	  <span class="hljs-comment">// User Pool start,用户内存池的起始地址</span><br><br>  kernel_pool.phy_addr_start = kp_start;<br>  user_pool.phy_addr_start   = up_start;<br><br>  kernel_pool.pool_size = kernel_free_pages * PG_SIZE;<br>  user_pool.pool_size	 = user_free_pages * PG_SIZE;<br><br>  kernel_pool.pool_bitmap.btmp_bytes_len = kbm_length;<br>  user_pool.pool_bitmap.btmp_bytes_len	  = ubm_length;<br><br><span class="hljs-comment">/*********    内核内存池和用户内存池位图   ***********</span><br><span class="hljs-comment">*   位图是全局的数据，长度不固定。</span><br><span class="hljs-comment">*   全局或静态的数组需要在编译时知道其长度，</span><br><span class="hljs-comment">*   而我们需要根据总内存大小算出需要多少字节。</span><br><span class="hljs-comment">*   所以改为指定一块内存来生成位图.</span><br><span class="hljs-comment">*   ************************************************/</span><br><span class="hljs-comment">// 内核使用的最高地址是0xc009f000,这是主线程的栈地址.(内核的大小预计为70K左右)</span><br><span class="hljs-comment">// 32M内存占用的位图是2k.内核内存池的位图先定在MEM_BITMAP_BASE(0xc009a000)处.</span><br>  kernel_pool.pool_bitmap.bits = (<span class="hljs-type">void</span>*)MEM_BITMAP_BASE;<br>   						       <br><span class="hljs-comment">/* 用户内存池的位图紧跟在内核内存池位图之后 */</span><br>  user_pool.pool_bitmap.bits = (<span class="hljs-type">void</span>*)(MEM_BITMAP_BASE + kbm_length);<br>  <span class="hljs-comment">/******************** 输出内存池信息 **********************/</span><br>  put_str(<span class="hljs-string">&quot;      kernel_pool_bitmap_start:&quot;</span>);put_int((<span class="hljs-type">int</span>)kernel_pool.pool_bitmap.bits);<br>  put_str(<span class="hljs-string">&quot; kernel_pool_phy_addr_start:&quot;</span>);put_int(kernel_pool.phy_addr_start);<br>  put_str(<span class="hljs-string">&quot;\n&quot;</span>);<br>  put_str(<span class="hljs-string">&quot;      user_pool_bitmap_start:&quot;</span>);put_int((<span class="hljs-type">int</span>)user_pool.pool_bitmap.bits);<br>  put_str(<span class="hljs-string">&quot; user_pool_phy_addr_start:&quot;</span>);put_int(user_pool.phy_addr_start);<br>  put_str(<span class="hljs-string">&quot;\n&quot;</span>);<br><br>  <span class="hljs-comment">/* 将位图置0*/</span><br>  bitmap_init(&amp;kernel_pool.pool_bitmap);<br>  bitmap_init(&amp;user_pool.pool_bitmap);<br><br>  <span class="hljs-comment">/* 下面初始化内核虚拟地址的位图,按实际物理内存大小生成数组。*/</span><br>  kernel_vaddr.vaddr_bitmap.btmp_bytes_len = kbm_length;      <span class="hljs-comment">// 用于维护内核堆的虚拟地址,所以要和内核内存池大小一致</span><br><br> <span class="hljs-comment">/* 位图的数组指向一块未使用的内存,目前定位在内核内存池和用户内存池之外*/</span><br>  kernel_vaddr.vaddr_bitmap.bits = (<span class="hljs-type">void</span>*)(MEM_BITMAP_BASE + kbm_length + ubm_length);<br><br>  kernel_vaddr.vaddr_start = K_HEAP_START;<br>  bitmap_init(&amp;kernel_vaddr.vaddr_bitmap);<br>  put_str(<span class="hljs-string">&quot;   mem_pool_init done\n&quot;</span>);<br>&#125;<br><br><br><span class="hljs-comment">/* 内存管理部分初始化入口 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">mem_init</span><span class="hljs-params">()</span> &#123;<br>  put_str(<span class="hljs-string">&quot;mem_init start\n&quot;</span>);<br>  <span class="hljs-type">uint32_t</span> mem_bytes_total = (*(<span class="hljs-type">uint32_t</span>*)(<span class="hljs-number">0xb00</span>));<br>  mem_pool_init(mem_bytes_total);	  <span class="hljs-comment">// 初始化内存池</span><br>  put_str(<span class="hljs-string">&quot;mem_init done\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="kernelmainc修改-2"><a class="markdownIt-Anchor" href="#kernelmainc修改-2"></a> kernel/main.c修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;init.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;memory.h&quot;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>   	put_str(<span class="hljs-string">&quot;I am kernel\n&quot;</span>);<br>   	init_all();<br>   <br>   	<span class="hljs-type">void</span>* addr = get_kernel_pages(<span class="hljs-number">3</span>);<br>   	put_str(<span class="hljs-string">&quot;\n get_kernel_page start vaddr is&quot;</span>);<br>   	put_int((<span class="hljs-type">uint32_t</span>)addr);<br>   	put_str(<span class="hljs-string">&quot;\n&quot;</span>);<br>   <br>   	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br>   	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="kernelinitc新增"><a class="markdownIt-Anchor" href="#kernelinitc新增"></a> kernel/init.c新增</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">mem_init();	     <span class="hljs-comment">// 初始化内存管理系统</span><br></code></pre></td></tr></table></figure>
<h2 id="makefile"><a class="markdownIt-Anchor" href="#makefile"></a> makefile</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs shell">BUILD_DIR = ./build<br>ENTRY_POINT = 0xc0001500<br>AS = nasm<br>CC = gcc<br>LD = ld<br>LIB = -I lib/ -I lib/kernel/ -I lib/user/ -I kernel/ -I device/ <br>ASFLAGS = -f elf<br>CFLAGS = -Wall -m32 -fno-stack-protector $(LIB) -c -fno-builtin -W -Wstrict-prototypes -Wmissing-prototypes<br>LDFLAGS =  -m elf_i386 -Ttext $(ENTRY_POINT) -e main -Map $(BUILD_DIR)/kernel.map<br>OBJS = $(BUILD_DIR)/main.o $(BUILD_DIR)/init.o $(BUILD_DIR)/interrupt.o \<br>      $(BUILD_DIR)/timer.o $(BUILD_DIR)/kernel.o $(BUILD_DIR)/print.o \<br>      $(BUILD_DIR)/debug.o $(BUILD_DIR)/string.o $(BUILD_DIR)/memory.o \<br>      $(BUILD_DIR)/bitmap.o<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#############     c代码编译     ###############</span></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/main.o: kernel/main.c lib/kernel/print.h \</span><br><span class="language-bash">        lib/stdint.h kernel/init.h lib/string.h kernel/memory.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/init.o: kernel/init.c kernel/init.h lib/kernel/print.h \</span><br><span class="language-bash">        lib/stdint.h kernel/interrupt.h device/timer.h kernel/memory.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/interrupt.o: kernel/interrupt.c kernel/interrupt.h \</span><br><span class="language-bash">        lib/stdint.h kernel/global.h lib/kernel/io.h lib/kernel/print.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/timer.o: device/timer.c device/timer.h lib/stdint.h\</span><br><span class="language-bash">        lib/kernel/io.h lib/kernel/print.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/debug.o: kernel/debug.c kernel/debug.h \</span><br><span class="language-bash">        lib/kernel/print.h lib/stdint.h kernel/interrupt.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/string.o: lib/string.c lib/string.h \</span><br><span class="language-bash">	kernel/debug.h kernel/global.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/memory.o: kernel/memory.c kernel/memory.h \</span><br><span class="language-bash">	lib/stdint.h lib/kernel/bitmap.h kernel/debug.h lib/string.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/bitmap.o: lib/kernel/bitmap.c lib/kernel/bitmap.h \</span><br><span class="language-bash">	lib/string.h kernel/interrupt.h lib/kernel/print.h kernel/debug.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#############    汇编代码编译    ###############</span></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/kernel.o: kernel/kernel.S</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(AS) $(ASFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/print.o: lib/kernel/print.S</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(AS) $(ASFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#############    链接所有目标文件    #############</span></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/kernel.bin: $(OBJS)</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(LD) $(LDFLAGS) $^ -o <span class="hljs-variable">$@</span></span><br><br>.PHONY : mk_dir hd clean all<br><br>mk_dir:<br>	if [ ! -d $(BUILD_DIR) ]; then mkdir $(BUILD_DIR); fi<br><br>hd:<br>	dd if=$(BUILD_DIR)/kernel.bin \<br>           of=/home/podest/bochs/hd60M.img \<br>           bs=512 count=200 seek=9 conv=notrunc<br><br>clean:<br>	cd $(BUILD_DIR) &amp;&amp; rm -f  ./*<br><br>build: $(BUILD_DIR)/kernel.bin<br><br>all: mk_dir build hd<br></code></pre></td></tr></table></figure>
<p>makefile相当于一种脚本语言文件，必须遵循make定义的语法<br />
而make相当于脚本解析器<br />
make和makefile的本质是，make通过解析makefile文件，找出哪些文件有变化，根据依赖关系找出受变化影响的文件，然后将找出所有的文件执行事先在makefile定义好的命令规则。</p>
<h2 id="实验结果"><a class="markdownIt-Anchor" href="#实验结果"></a> 实验结果</h2>
<p><img src="/img/os/os8.1.png" srcset="/img/loading.gif" lazyload alt="图为bochs运行界面" /></p>
<h2 id="写在后面"><a class="markdownIt-Anchor" href="#写在后面"></a> 写在后面</h2>
<p>继续前进，现在逐渐进入了操作系统真正有趣的地方了。</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a>
                    
                      <a class="hover-with-bg" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E7%9C%9F%E8%B1%A1%E8%BF%98%E5%8E%9F/">真象还原</a>
                    
                  </div>
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/07/24/os(9)/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">第九章 实现内核线程 启动多线程调度</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/07/19/os(a)/">
                        <span class="hidden-mobile">第一到七章流程整理</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <div style="font-size: 0.85rem"> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>





  

  
    <!-- KaTeX -->
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0/dist/katex.min.css" />
  











<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
