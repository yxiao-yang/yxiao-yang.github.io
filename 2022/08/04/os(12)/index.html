

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/app.png">
  <link rel="icon" href="/img/app.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="第十二章 实现系统调用 新增printf函数和堆内存管理  写在前面 没什么好说的，抓紧出发。  实现系统调用  实现步骤  用中断门实现系统调用，效仿Linux用0x80号中断作为系统调用的入口。 在IDT中安装0x80号中断对应的描述符，在该描述符中注册系统调用对应的中断处理例程。 建立系统调用子功能表syscall_table，利用eax寄存器中的子功能号在该表中索引相应的处理函数。 用宏">
<meta property="og:type" content="article">
<meta property="og:title" content="第十二章 实现系统调用 新增printf函数和堆内存管理">
<meta property="og:url" content="http://example.com/2022/08/04/os(12)/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="第十二章 实现系统调用 新增printf函数和堆内存管理  写在前面 没什么好说的，抓紧出发。  实现系统调用  实现步骤  用中断门实现系统调用，效仿Linux用0x80号中断作为系统调用的入口。 在IDT中安装0x80号中断对应的描述符，在该描述符中注册系统调用对应的中断处理例程。 建立系统调用子功能表syscall_table，利用eax寄存器中的子功能号在该表中索引相应的处理函数。 用宏">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/os/os12.1.png">
<meta property="og:image" content="http://example.com/img/os/os12.2.png">
<meta property="article:published_time" content="2022-08-04T02:14:50.230Z">
<meta property="article:modified_time" content="2022-08-04T05:28:22.348Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/os/os12.1.png">
  
  
  <title>第十二章 实现系统调用 新增printf函数和堆内存管理 - Hexo</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":50,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>羊</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/bg2.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="第十二章 实现系统调用 新增printf函数和堆内存管理">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-08-04 10:14" pubdate>
        2022年8月4日 上午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      39k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      326 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">第十二章 实现系统调用 新增printf函数和堆内存管理</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：7 小时前
                
              </p>
            
            <div class="markdown-body">
              <h1 id="第十二章-实现系统调用-新增printf函数和堆内存管理"><a class="markdownIt-Anchor" href="#第十二章-实现系统调用-新增printf函数和堆内存管理"></a> 第十二章 实现系统调用 新增printf函数和堆内存管理</h1>
<h2 id="写在前面"><a class="markdownIt-Anchor" href="#写在前面"></a> 写在前面</h2>
<p>没什么好说的，抓紧出发。</p>
<h2 id="实现系统调用"><a class="markdownIt-Anchor" href="#实现系统调用"></a> 实现系统调用</h2>
<h3 id="实现步骤"><a class="markdownIt-Anchor" href="#实现步骤"></a> 实现步骤</h3>
<ol>
<li>用中断门实现系统调用，效仿Linux用0x80号中断作为系统调用的入口。</li>
<li>在IDT中安装0x80号中断对应的描述符，在该描述符中注册系统调用对应的中断处理例程。</li>
<li>建立系统调用子功能表syscall_table，利用eax寄存器中的子功能号在该表中索引相应的处理函数。</li>
<li>用宏实现用户空间系统调用接口_syscall，最大支持3个参数的系统调用，故只需要完成_syscall[0-3]。寄存器传递参数。eax为子功能号，ebx保存第1个参数，ecx保存第2个参数，edx保存第3个参数。</li>
</ol>
<h3 id="kernelkernelh创建"><a class="markdownIt-Anchor" href="#kernelkernelh创建"></a> kernel/kernel.h创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __KERNEL_KERNEL_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __KERNEL_KERNEL_H</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">syscall_handler</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
<h3 id="kernelinterruptc修改"><a class="markdownIt-Anchor" href="#kernelinterruptc修改"></a> kernel/interrupt.c修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;interrupt.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;global.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;io.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIC_M_CTRL 0x20	       <span class="hljs-comment">// 这里用的可编程中断控制器是8259A,主片的控制端口是0x20</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIC_M_DATA 0x21	       <span class="hljs-comment">// 主片的数据端口是0x21</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIC_S_CTRL 0xa0	       <span class="hljs-comment">// 从片的控制端口是0xa0</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIC_S_DATA 0xa1	       <span class="hljs-comment">// 从片的数据端口是0xa1</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IDT_DESC_CNT 0x81      <span class="hljs-comment">// 目前总共支持的中断数</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EFLAGS_IF   0x00000200       <span class="hljs-comment">// eflags寄存器中的if位为1</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> GET_EFLAGS(EFLAG_VAR) asm volatile(<span class="hljs-string">&quot;pushfl; popl %0&quot;</span> : <span class="hljs-string">&quot;=g&quot;</span> (EFLAG_VAR))</span><br><br><span class="hljs-comment">/*中断门描述符结构体*/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">gate_desc</span> </span><br><span class="hljs-class">&#123;</span><br>   <span class="hljs-type">uint16_t</span>    func_offset_low_word;<br>   <span class="hljs-type">uint16_t</span>    selector;<br>   <span class="hljs-type">uint8_t</span>     dcount;   <span class="hljs-comment">//此项为双字计数字段，是门描述符中的第4字节。此项固定值，不用考虑</span><br>   <span class="hljs-type">uint8_t</span>     attribute;<br>   <span class="hljs-type">uint16_t</span>    func_offset_high_word;<br>&#125;;<br><br><span class="hljs-comment">// 静态函数声明,非必须</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">make_idt_desc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> gate_desc* p_gdesc, <span class="hljs-type">uint8_t</span> attr, intr_handler function)</span>;<br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">gate_desc</span> <span class="hljs-title">idt</span>[<span class="hljs-title">IDT_DESC_CNT</span>];</span>   <span class="hljs-comment">// idt是中断描述符表,本质上就是个中断门描述符数组</span><br><br><br><span class="hljs-type">char</span>* intr_name[IDT_DESC_CNT];		     <span class="hljs-comment">// 用于保存异常的名字</span><br><br><br><span class="hljs-comment">/********    定义中断处理程序数组    ********</span><br><span class="hljs-comment"> * 在kernel.S中定义的intrXXentry只是中断处理程序的入口,</span><br><span class="hljs-comment"> * 最终调用的是ide_table中的处理程序*/</span><br>intr_handler idt_table[IDT_DESC_CNT];<br><br><span class="hljs-comment">/********************************************/</span><br><span class="hljs-keyword">extern</span> intr_handler intr_entry_table[IDT_DESC_CNT];	    <span class="hljs-comment">// 声明引用定义在kernel.S中的中断处理函数入口数组</span><br><span class="hljs-keyword">extern</span> <span class="hljs-type">uint32_t</span> <span class="hljs-title function_">syscall_handler</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><br><br><br><br><span class="hljs-comment">/* 初始化可编程中断控制器8259A */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">pic_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> <br>&#123;<br>   <span class="hljs-comment">/* 初始化主片 */</span><br>   outb (PIC_M_CTRL, <span class="hljs-number">0x11</span>);   <span class="hljs-comment">// ICW1: 边沿触发,级联8259, 需要ICW4.</span><br>   outb (PIC_M_DATA, <span class="hljs-number">0x20</span>);   <span class="hljs-comment">// ICW2: 起始中断向量号为0x20,也就是IR[0-7] 为 0x20 ~ 0x27.</span><br>   outb (PIC_M_DATA, <span class="hljs-number">0x04</span>);   <span class="hljs-comment">// ICW3: IR2接从片. </span><br>   outb (PIC_M_DATA, <span class="hljs-number">0x01</span>);   <span class="hljs-comment">// ICW4: 8086模式, 正常EOI</span><br><br>   <span class="hljs-comment">/* 初始化从片 */</span><br>   outb (PIC_S_CTRL, <span class="hljs-number">0x11</span>);    <span class="hljs-comment">// ICW1: 边沿触发,级联8259, 需要ICW4.</span><br>   outb (PIC_S_DATA, <span class="hljs-number">0x28</span>);    <span class="hljs-comment">// ICW2: 起始中断向量号为0x28,也就是IR[8-15] 为 0x28 ~ 0x2F.</span><br>   outb (PIC_S_DATA, <span class="hljs-number">0x02</span>);    <span class="hljs-comment">// ICW3: 设置从片连接到主片的IR2引脚</span><br>   outb (PIC_S_DATA, <span class="hljs-number">0x01</span>);    <span class="hljs-comment">// ICW4: 8086模式, 正常EOI</span><br>   <br>   <span class="hljs-comment">//outb (PIC_M_DATA, 0xfe);</span><br>   <span class="hljs-comment">//outb (PIC_S_DATA, 0xff);</span><br><br>   <span class="hljs-comment">//outb (PIC_M_DATA, 0xfd);</span><br>   <span class="hljs-comment">//outb (PIC_S_DATA, 0xff);</span><br><br>   outb (PIC_M_DATA, <span class="hljs-number">0xfc</span>);<br>   outb (PIC_S_DATA, <span class="hljs-number">0xff</span>);<br><br>   put_str(<span class="hljs-string">&quot;   pic_init done\n&quot;</span>);<br>&#125;<br><br><br><span class="hljs-comment">/* 创建中断门描述符 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">make_idt_desc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> gate_desc* p_gdesc, <span class="hljs-type">uint8_t</span> attr, intr_handler function)</span> <br>&#123; <br>   p_gdesc-&gt;func_offset_low_word = (<span class="hljs-type">uint32_t</span>)function &amp; <span class="hljs-number">0x0000FFFF</span>;<br>   p_gdesc-&gt;selector = SELECTOR_K_CODE;<br>   p_gdesc-&gt;dcount = <span class="hljs-number">0</span>;<br>   p_gdesc-&gt;attribute = attr;<br>   p_gdesc-&gt;func_offset_high_word = ((<span class="hljs-type">uint32_t</span>)function &amp; <span class="hljs-number">0xFFFF0000</span>) &gt;&gt; <span class="hljs-number">16</span>;<br>&#125;<br><br><br><span class="hljs-comment">/*初始化中断描述符表*/</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">idt_desc_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> <br>&#123;<br>   <span class="hljs-type">int</span> i, lastindex = IDT_DESC_CNT - <span class="hljs-number">1</span>;<br>   <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; IDT_DESC_CNT; i++) <br>   &#123;<br>      make_idt_desc(&amp;idt[i], IDT_DESC_ATTR_DPL0, intr_entry_table[i]); <br>   &#125;<br><span class="hljs-comment">/* 单独处理系统调用,系统调用对应的中断门dpl为3,</span><br><span class="hljs-comment"> * 中断处理程序为单独的syscall_handler */</span><br>   make_idt_desc(&amp;idt[lastindex], IDT_DESC_ATTR_DPL3, syscall_handler);<br>   put_str(<span class="hljs-string">&quot;   idt_desc_init done\n&quot;</span>);<br>&#125;<br><br><br><span class="hljs-comment">/* 通用的中断处理函数,一般用在异常出现时的处理 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">general_intr_handler</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> vec_nr)</span> <br>&#123;<br>   <span class="hljs-keyword">if</span> (vec_nr == <span class="hljs-number">0x27</span> || vec_nr == <span class="hljs-number">0x2f</span>)     <span class="hljs-comment">// 0x2f是从片8259A上的最后一个irq引脚，保留</span><br>   &#123;<br>      <span class="hljs-keyword">return</span>;		<span class="hljs-comment">//IRQ7和IRQ15会产生伪中断(spurious interrupt),无须处理。</span><br>   &#125;<br>   put_str(<span class="hljs-string">&quot;int vector : 0x&quot;</span>);<br>   put_int(vec_nr);<br>   put_char(<span class="hljs-string">&#x27;\n&#x27;</span>);	<br>&#125;<br><br><br><span class="hljs-comment">/* 完成一般中断处理函数注册及异常名称注册 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">exception_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;			    <span class="hljs-comment">// 完成一般中断处理函数注册及异常名称注册</span><br>   <span class="hljs-type">int</span> i;<br>   <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; IDT_DESC_CNT; i++) <br>   &#123;<br><span class="hljs-comment">/* idt_table数组中的函数是在进入中断后根据中断向量号调用的,</span><br><span class="hljs-comment"> * 见kernel/kernel.S的call [idt_table + %1*4] */</span><br>      idt_table[i] = general_intr_handler;		    <span class="hljs-comment">// 默认为general_intr_handler。</span><br>							    <span class="hljs-comment">// 以后会由register_handler来注册具体处理函数。</span><br>      intr_name[i] = <span class="hljs-string">&quot;unknown&quot;</span>;				    <span class="hljs-comment">// 先统一赋值为unknown </span><br>   &#125;<br>   intr_name[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;#DE Divide Error&quot;</span>;<br>   intr_name[<span class="hljs-number">1</span>] = <span class="hljs-string">&quot;#DB Debug Exception&quot;</span>;<br>   intr_name[<span class="hljs-number">2</span>] = <span class="hljs-string">&quot;NMI Interrupt&quot;</span>;<br>   intr_name[<span class="hljs-number">3</span>] = <span class="hljs-string">&quot;#BP Breakpoint Exception&quot;</span>;<br>   intr_name[<span class="hljs-number">4</span>] = <span class="hljs-string">&quot;#OF Overflow Exception&quot;</span>;<br>   intr_name[<span class="hljs-number">5</span>] = <span class="hljs-string">&quot;#BR BOUND Range Exceeded Exception&quot;</span>;<br>   intr_name[<span class="hljs-number">6</span>] = <span class="hljs-string">&quot;#UD Invalid Opcode Exception&quot;</span>;<br>   intr_name[<span class="hljs-number">7</span>] = <span class="hljs-string">&quot;#NM Device Not Available Exception&quot;</span>;<br>   intr_name[<span class="hljs-number">8</span>] = <span class="hljs-string">&quot;#DF Double Fault Exception&quot;</span>;<br>   intr_name[<span class="hljs-number">9</span>] = <span class="hljs-string">&quot;Coprocessor Segment Overrun&quot;</span>;<br>   intr_name[<span class="hljs-number">10</span>] = <span class="hljs-string">&quot;#TS Invalid TSS Exception&quot;</span>;<br>   intr_name[<span class="hljs-number">11</span>] = <span class="hljs-string">&quot;#NP Segment Not Present&quot;</span>;<br>   intr_name[<span class="hljs-number">12</span>] = <span class="hljs-string">&quot;#SS Stack Fault Exception&quot;</span>;<br>   intr_name[<span class="hljs-number">13</span>] = <span class="hljs-string">&quot;#GP General Protection Exception&quot;</span>;<br>   intr_name[<span class="hljs-number">14</span>] = <span class="hljs-string">&quot;#PF Page-Fault Exception&quot;</span>;<br>   <span class="hljs-comment">// intr_name[15] 第15项是intel保留项，未使用</span><br>   intr_name[<span class="hljs-number">16</span>] = <span class="hljs-string">&quot;#MF x87 FPU Floating-Point Error&quot;</span>;<br>   intr_name[<span class="hljs-number">17</span>] = <span class="hljs-string">&quot;#AC Alignment Check Exception&quot;</span>;<br>   intr_name[<span class="hljs-number">18</span>] = <span class="hljs-string">&quot;#MC Machine-Check Exception&quot;</span>;<br>   intr_name[<span class="hljs-number">19</span>] = <span class="hljs-string">&quot;#XF SIMD Floating-Point Exception&quot;</span>;<br><br>&#125;<br><br><br><span class="hljs-comment">/*完成有关中断的所有初始化工作*/</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">idt_init</span><span class="hljs-params">()</span> <br>&#123;<br>   put_str(<span class="hljs-string">&quot;idt_init start\n&quot;</span>);<br>   idt_desc_init();	   <span class="hljs-comment">// 初始化中断描述符表</span><br>   exception_init();	   <span class="hljs-comment">// 异常名初始化并注册通常的中断处理函数</span><br>   pic_init();		   <span class="hljs-comment">// 初始化8259A</span><br><br>   <span class="hljs-comment">/* 加载idt */</span><br>   <span class="hljs-type">uint64_t</span> idt_operand = ((<span class="hljs-keyword">sizeof</span>(idt) - <span class="hljs-number">1</span>) | ((<span class="hljs-type">uint64_t</span>)(<span class="hljs-type">uint32_t</span>)idt &lt;&lt; <span class="hljs-number">16</span>));<br>   <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span><span class="hljs-params">(<span class="hljs-string">&quot;lidt %0&quot;</span> : : <span class="hljs-string">&quot;m&quot;</span> (idt_operand))</span>;<br>   put_str(<span class="hljs-string">&quot;idt_init done\n&quot;</span>);<br>&#125;<br><br><br><span class="hljs-comment">/* 开中断并返回开中断前的状态*/</span><br><span class="hljs-keyword">enum</span> intr_status <span class="hljs-title function_">intr_enable</span><span class="hljs-params">()</span> <br>&#123;<br>   <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">intr_status</span> <span class="hljs-title">old_status</span>;</span><br>   <span class="hljs-keyword">if</span> (INTR_ON == intr_get_status()) <br>   &#123;<br>      old_status = INTR_ON;<br>      <span class="hljs-keyword">return</span> old_status;<br>   &#125; <br>   <span class="hljs-keyword">else</span> <br>   &#123;<br>      old_status = INTR_OFF;<br>      <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span><span class="hljs-params">(<span class="hljs-string">&quot;sti&quot;</span>)</span>;	 <span class="hljs-comment">// 开中断,sti指令将IF位置1</span><br>      <span class="hljs-keyword">return</span> old_status;<br>   &#125;<br>&#125;<br><br><br><span class="hljs-comment">/* 关中断,并且返回关中断前的状态 */</span><br><span class="hljs-keyword">enum</span> intr_status <span class="hljs-title function_">intr_disable</span><span class="hljs-params">()</span> <br>&#123;     <br>   <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">intr_status</span> <span class="hljs-title">old_status</span>;</span><br>   <span class="hljs-keyword">if</span> (INTR_ON == intr_get_status()) <br>   &#123;<br>      old_status = INTR_ON;<br>      <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span><span class="hljs-params">(<span class="hljs-string">&quot;cli&quot;</span> : : : <span class="hljs-string">&quot;memory&quot;</span>)</span>; <span class="hljs-comment">// 关中断,cli指令将IF位置0</span><br>      <span class="hljs-keyword">return</span> old_status;<br>   &#125; <br>   <span class="hljs-keyword">else</span> <br>   &#123;<br>      old_status = INTR_OFF;<br>      <span class="hljs-keyword">return</span> old_status;<br>   &#125;<br>&#125;<br><br><br><span class="hljs-comment">/* 将中断状态设置为status */</span><br><span class="hljs-keyword">enum</span> intr_status <span class="hljs-title function_">intr_set_status</span><span class="hljs-params">(<span class="hljs-keyword">enum</span> intr_status status)</span> <br>&#123;<br>   <span class="hljs-keyword">return</span> status &amp; INTR_ON ? intr_enable() : intr_disable();<br>&#125;<br><br><br><span class="hljs-comment">/* 获取当前中断状态 */</span><br><span class="hljs-keyword">enum</span> intr_status <span class="hljs-title function_">intr_get_status</span><span class="hljs-params">()</span> <br>&#123;<br>   <span class="hljs-type">uint32_t</span> eflags = <span class="hljs-number">0</span>; <br>   GET_EFLAGS(eflags);<br>   <span class="hljs-keyword">return</span> (EFLAGS_IF &amp; eflags) ? INTR_ON : INTR_OFF;<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">register_handler</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> vector_no, intr_handler function)</span>;<br><br><br><span class="hljs-comment">/* 在中断处理程序数组第vector_no个元素中注册安装中断处理程序function */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">register_handler</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> vector_no, intr_handler function)</span> <br>&#123;<br><span class="hljs-comment">/* idt_table数组中的函数是在进入中断后根据中断向量号调用的,</span><br><span class="hljs-comment"> * 见kernel/kernel.S的call [idt_table + %1*4] */</span><br>   idt_table[vector_no] = function; <br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="libusersyscallh创建"><a class="markdownIt-Anchor" href="#libusersyscallh创建"></a> lib/user/syscall.h创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __LIB_USER_SYSCALL_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LIB_USER_SYSCALL_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">SYSCALL_NR</span> </span><br><span class="hljs-class">&#123;</span><br>   SYS_GETPID,<br>&#125;;<br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">getpid</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
<h3 id="libusersyscallc创建"><a class="markdownIt-Anchor" href="#libusersyscallc创建"></a> lib/user/syscall.c创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;syscall.h&quot;</span></span><br><br><span class="hljs-comment">/* 无参数的系统调用 */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _syscall0(NUMBER) (&#123;				       \</span><br><span class="hljs-meta">   int retval;					               \</span><br><span class="hljs-meta">   asm volatile (					       \</span><br><span class="hljs-meta">   <span class="hljs-string">&quot;int $0x80&quot;</span>						       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;=a&quot;</span> (retval)					       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;a&quot;</span> (NUMBER)					       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;memory&quot;</span>						       \</span><br><span class="hljs-meta">   );							       \</span><br><span class="hljs-meta">   retval;						       \</span><br><span class="hljs-meta">&#125;)</span><br><br><br><span class="hljs-comment">/* 一个参数的系统调用 */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _syscall1(NUMBER, ARG1) (&#123;			       \</span><br><span class="hljs-meta">   int retval;					               \</span><br><span class="hljs-meta">   asm volatile (					       \</span><br><span class="hljs-meta">   <span class="hljs-string">&quot;int $0x80&quot;</span>						       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;=a&quot;</span> (retval)					       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;a&quot;</span> (NUMBER), <span class="hljs-string">&quot;b&quot;</span> (ARG1)				       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;memory&quot;</span>						       \</span><br><span class="hljs-meta">   );							       \</span><br><span class="hljs-meta">   retval;						       \</span><br><span class="hljs-meta">&#125;)</span><br><br><span class="hljs-comment">/* 两个参数的系统调用 */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _syscall2(NUMBER, ARG1, ARG2) (&#123;		       \</span><br><span class="hljs-meta">   int retval;						       \</span><br><span class="hljs-meta">   asm volatile (					       \</span><br><span class="hljs-meta">   <span class="hljs-string">&quot;int $0x80&quot;</span>						       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;=a&quot;</span> (retval)					       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;a&quot;</span> (NUMBER), <span class="hljs-string">&quot;b&quot;</span> (ARG1), <span class="hljs-string">&quot;c&quot;</span> (ARG2)		       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;memory&quot;</span>						       \</span><br><span class="hljs-meta">   );							       \</span><br><span class="hljs-meta">   retval;						       \</span><br><span class="hljs-meta">&#125;)</span><br><br><span class="hljs-comment">/* 三个参数的系统调用 */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _syscall3(NUMBER, ARG1, ARG2, ARG3) (&#123;		       \</span><br><span class="hljs-meta">   int retval;						       \</span><br><span class="hljs-meta">   asm volatile (					       \</span><br><span class="hljs-meta">      <span class="hljs-string">&quot;int $0x80&quot;</span>					       \</span><br><span class="hljs-meta">      : <span class="hljs-string">&quot;=a&quot;</span> (retval)					       \</span><br><span class="hljs-meta">      : <span class="hljs-string">&quot;a&quot;</span> (NUMBER), <span class="hljs-string">&quot;b&quot;</span> (ARG1), <span class="hljs-string">&quot;c&quot;</span> (ARG2), <span class="hljs-string">&quot;d&quot;</span> (ARG3)       \</span><br><span class="hljs-meta">      : <span class="hljs-string">&quot;memory&quot;</span>					       \</span><br><span class="hljs-meta">   );							       \</span><br><span class="hljs-meta">   retval;						       \</span><br><span class="hljs-meta">&#125;)</span><br><br><span class="hljs-comment">/* 返回当前任务pid */</span><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">getpid</span><span class="hljs-params">()</span> &#123;<br>   <span class="hljs-keyword">return</span> _syscall0(SYS_GETPID);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="kernelkernels修改"><a class="markdownIt-Anchor" href="#kernelkernels修改"></a> kernel/kernel.S修改</h3>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">[<span class="hljs-meta">bits</span> <span class="hljs-number">32</span>]<br><span class="hljs-meta">%define</span> ERROR_CODE <span class="hljs-keyword">nop</span>		 <span class="hljs-comment">; 若在相关的异常中cpu已经自动压入了错误码,为保持栈中格式统一,这里不做操作.</span><br><span class="hljs-meta">%define</span> <span class="hljs-meta">ZERO</span> <span class="hljs-keyword">push</span> <span class="hljs-number">0</span>		 <span class="hljs-comment">; 若在相关的异常中cpu没有压入错误码,为了统一栈中格式,就手工压入一个0</span><br><br><span class="hljs-meta">extern</span> put_str<span class="hljs-comment">;</span><br><span class="hljs-meta">extern</span> idt_table<span class="hljs-comment">;</span><br><span class="hljs-meta">extern</span> syscall_table<span class="hljs-comment">;</span><br><br><span class="hljs-meta">section</span> .data<br><span class="hljs-meta">global</span> intr_entry_table<br><span class="hljs-symbol">intr_entry_table:</span><br><br>%macro VECTOR <span class="hljs-number">2</span><br><span class="hljs-meta">section</span> .text<br>intr<span class="hljs-subst">%1</span>entry:		 <span class="hljs-comment">; 每个中断处理程序都要压入中断向量号,所以一个中断类型一个中断处理程序，自己知道自己的中断向量号是多少</span><br><br>   <span class="hljs-subst">%2</span>				 <span class="hljs-comment">; 中断若有错误码会压在eip后面 </span><br><span class="hljs-comment">; 以下是保存上下文环境</span><br>   <span class="hljs-keyword">push</span> <span class="hljs-built_in">ds</span><br>   <span class="hljs-keyword">push</span> <span class="hljs-built_in">es</span><br>   <span class="hljs-keyword">push</span> <span class="hljs-built_in">fs</span><br>   <span class="hljs-keyword">push</span> <span class="hljs-built_in">gs</span><br>   <span class="hljs-keyword">pushad</span>			 <span class="hljs-comment">; PUSHAD指令压入32位寄存器,其入栈顺序是: EAX,ECX,EDX,EBX,ESP,EBP,ESI,EDI</span><br><br>   <span class="hljs-comment">; 如果是从片上进入的中断,除了往从片上发送EOI外,还要往主片上发送EOI </span><br>   <span class="hljs-keyword">mov</span> <span class="hljs-built_in">al</span>,<span class="hljs-number">0x20</span>                   <span class="hljs-comment">; 中断结束命令EOI</span><br>   <span class="hljs-keyword">out</span> <span class="hljs-number">0xa0</span>,<span class="hljs-built_in">al</span>                   <span class="hljs-comment">; 向从片发送</span><br>   <span class="hljs-keyword">out</span> <span class="hljs-number">0x20</span>,<span class="hljs-built_in">al</span>                   <span class="hljs-comment">; 向主片发送</span><br><br>   <span class="hljs-keyword">push</span> <span class="hljs-subst">%1</span>			 <span class="hljs-comment">; 不管idt_table中的目标程序是否需要参数,都一律压入中断向量号,调试时很方便</span><br>   <span class="hljs-keyword">call</span> [idt_table + <span class="hljs-subst">%1</span>*<span class="hljs-number">4</span>]       <span class="hljs-comment">; 调用idt_table中的C版本中断处理函数</span><br>   <span class="hljs-keyword">jmp</span> intr_exit<br>	<br><span class="hljs-meta">section</span> .data<br>   <span class="hljs-built_in">dd</span>    intr<span class="hljs-subst">%1</span>entry	 <span class="hljs-comment">; 存储各个中断入口程序的地址，形成intr_entry_table数组</span><br>%endmacro<br><br><span class="hljs-meta">section</span> .text<br><span class="hljs-meta">global</span> intr_exit<br><span class="hljs-symbol">intr_exit:</span>	     <br><span class="hljs-comment">; 以下是恢复上下文环境</span><br>   <span class="hljs-keyword">add</span> <span class="hljs-built_in">esp</span>, <span class="hljs-number">4</span>			   <span class="hljs-comment">; 跳过中断号</span><br>   <span class="hljs-keyword">popad</span><br>   <span class="hljs-keyword">pop</span> <span class="hljs-built_in">gs</span><br>   <span class="hljs-keyword">pop</span> <span class="hljs-built_in">fs</span><br>   <span class="hljs-keyword">pop</span> <span class="hljs-built_in">es</span><br>   <span class="hljs-keyword">pop</span> <span class="hljs-built_in">ds</span><br>   <span class="hljs-keyword">add</span> <span class="hljs-built_in">esp</span>, <span class="hljs-number">4</span>			   <span class="hljs-comment">; 跳过error_code</span><br>   <span class="hljs-keyword">iretd</span><br><br><span class="hljs-comment">;;;;;;;;;;;;;;;;   0x80号中断   ;;;;;;;;;;;;;;;;</span><br><span class="hljs-meta">section</span> .text<br><span class="hljs-meta">global</span> syscall_handler<br><span class="hljs-symbol">syscall_handler:</span><br><span class="hljs-comment">;1 保存上下文环境</span><br>   <span class="hljs-keyword">push</span> <span class="hljs-number">0</span>			    <span class="hljs-comment">; 压入0, 使栈中格式统一</span><br><br>   <span class="hljs-keyword">push</span> <span class="hljs-built_in">ds</span><br>   <span class="hljs-keyword">push</span> <span class="hljs-built_in">es</span><br>   <span class="hljs-keyword">push</span> <span class="hljs-built_in">fs</span><br>   <span class="hljs-keyword">push</span> <span class="hljs-built_in">gs</span><br>   <span class="hljs-keyword">pushad</span>			    <span class="hljs-comment">; PUSHAD指令压入32位寄存器，其入栈顺序是:</span><br>				    <span class="hljs-comment">; EAX,ECX,EDX,EBX,ESP,EBP,ESI,EDI </span><br>				 <br>   <span class="hljs-keyword">push</span> <span class="hljs-number">0x80</span>			    <span class="hljs-comment">; 此位置压入0x80也是为了保持统一的栈格式</span><br><br><span class="hljs-comment">;2 为系统调用子功能传入参数</span><br>   <span class="hljs-keyword">push</span> <span class="hljs-built_in">edx</span>			    <span class="hljs-comment">; 系统调用中第3个参数</span><br>   <span class="hljs-keyword">push</span> <span class="hljs-built_in">ecx</span>			    <span class="hljs-comment">; 系统调用中第2个参数</span><br>   <span class="hljs-keyword">push</span> <span class="hljs-built_in">ebx</span>			    <span class="hljs-comment">; 系统调用中第1个参数</span><br><br><span class="hljs-comment">;3 调用子功能处理函数</span><br>   <span class="hljs-keyword">call</span> [syscall_table + <span class="hljs-built_in">eax</span>*<span class="hljs-number">4</span>]	    <span class="hljs-comment">; 编译器会在栈中根据C函数声明匹配正确数量的参数</span><br>   <span class="hljs-keyword">add</span> <span class="hljs-built_in">esp</span>, <span class="hljs-number">12</span>			    <span class="hljs-comment">; 跨过上面的三个参数</span><br><br><span class="hljs-comment">;4 将call调用后的返回值存入待当前内核栈中eax的位置</span><br>   <span class="hljs-keyword">mov</span> [<span class="hljs-built_in">esp</span> + <span class="hljs-number">8</span>*<span class="hljs-number">4</span>], <span class="hljs-built_in">eax</span>	<br>   <span class="hljs-keyword">jmp</span> intr_exit		    <span class="hljs-comment">; intr_exit返回,恢复上下文</span><br><br><br>VECTOR <span class="hljs-number">0x00</span>,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x01</span>,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x02</span>,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x03</span>,<span class="hljs-meta">ZERO</span> <br>VECTOR <span class="hljs-number">0x04</span>,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x05</span>,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x06</span>,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x07</span>,<span class="hljs-meta">ZERO</span> <br>VECTOR <span class="hljs-number">0x08</span>,ERROR_CODE<br>VECTOR <span class="hljs-number">0x09</span>,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x0a</span>,ERROR_CODE<br>VECTOR <span class="hljs-number">0x0b</span>,ERROR_CODE <br>VECTOR <span class="hljs-number">0x0c</span>,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x0d</span>,ERROR_CODE<br>VECTOR <span class="hljs-number">0x0e</span>,ERROR_CODE<br>VECTOR <span class="hljs-number">0x0f</span>,<span class="hljs-meta">ZERO</span> <br>VECTOR <span class="hljs-number">0x10</span>,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x11</span>,ERROR_CODE<br>VECTOR <span class="hljs-number">0x12</span>,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x13</span>,<span class="hljs-meta">ZERO</span> <br>VECTOR <span class="hljs-number">0x14</span>,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x15</span>,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x16</span>,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x17</span>,<span class="hljs-meta">ZERO</span> <br>VECTOR <span class="hljs-number">0x18</span>,ERROR_CODE<br>VECTOR <span class="hljs-number">0x19</span>,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x1a</span>,ERROR_CODE<br>VECTOR <span class="hljs-number">0x1b</span>,ERROR_CODE <br>VECTOR <span class="hljs-number">0x1c</span>,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x1d</span>,ERROR_CODE<br>VECTOR <span class="hljs-number">0x1e</span>,ERROR_CODE<br>VECTOR <span class="hljs-number">0x1f</span>,<span class="hljs-meta">ZERO</span> <br>VECTOR <span class="hljs-number">0x20</span>,<span class="hljs-meta">ZERO</span>	<span class="hljs-comment">;时钟中断对应的入口</span><br><br>VECTOR <span class="hljs-number">0x21</span>,<span class="hljs-meta">ZERO</span>	<span class="hljs-comment">;键盘中断对应的入口</span><br>VECTOR <span class="hljs-number">0x22</span>,<span class="hljs-meta">ZERO</span>	<span class="hljs-comment">;级联用的</span><br>VECTOR <span class="hljs-number">0x23</span>,<span class="hljs-meta">ZERO</span>	<span class="hljs-comment">;串口2对应的入口</span><br>VECTOR <span class="hljs-number">0x24</span>,<span class="hljs-meta">ZERO</span>	<span class="hljs-comment">;串口1对应的入口</span><br>VECTOR <span class="hljs-number">0x25</span>,<span class="hljs-meta">ZERO</span>	<span class="hljs-comment">;并口2对应的入口</span><br>VECTOR <span class="hljs-number">0x26</span>,<span class="hljs-meta">ZERO</span>	<span class="hljs-comment">;软盘对应的入口</span><br>VECTOR <span class="hljs-number">0x27</span>,<span class="hljs-meta">ZERO</span>	<span class="hljs-comment">;并口1对应的入口</span><br>VECTOR <span class="hljs-number">0x28</span>,<span class="hljs-meta">ZERO</span>	<span class="hljs-comment">;实时时钟对应的入口</span><br>VECTOR <span class="hljs-number">0x29</span>,<span class="hljs-meta">ZERO</span>	<span class="hljs-comment">;重定向</span><br>VECTOR <span class="hljs-number">0x2a</span>,<span class="hljs-meta">ZERO</span>	<span class="hljs-comment">;保留</span><br>VECTOR <span class="hljs-number">0x2b</span>,<span class="hljs-meta">ZERO</span>	<span class="hljs-comment">;保留</span><br>VECTOR <span class="hljs-number">0x2c</span>,<span class="hljs-meta">ZERO</span>	<span class="hljs-comment">;ps/2鼠标</span><br>VECTOR <span class="hljs-number">0x2d</span>,<span class="hljs-meta">ZERO</span>	<span class="hljs-comment">;fpu浮点单元异常</span><br>VECTOR <span class="hljs-number">0x2e</span>,<span class="hljs-meta">ZERO</span>	<span class="hljs-comment">;硬盘</span><br>VECTOR <span class="hljs-number">0x2f</span>,<span class="hljs-meta">ZERO</span>	<span class="hljs-comment">;保留</span><br><br>VECTOR <span class="hljs-number">0x30</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x31</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x32</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x33</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x34</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x35</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x36</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x37</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x38</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x39</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x3A</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x3B</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x3C</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x3D</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x3E</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x3F</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x40</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x41</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x42</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x43</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x44</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x45</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x46</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x47</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x48</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x49</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x4A</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x4B</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x4C</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x4D</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x4E</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x4F</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x50</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x51</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x52</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x53</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x54</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x55</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x56</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x57</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x58</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x59</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x5A</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x5B</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x5C</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x5D</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x5E</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x5F</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x61</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x62</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x63</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x64</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x65</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x66</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x67</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x68</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x69</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x6A</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x6B</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x6C</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x6D</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x6E</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x6F</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x70</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x71</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x72</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x73</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x74</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x75</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x76</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x77</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x78</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x79</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x7A</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x7B</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x7C</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x7D</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x7E</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x7F</span> ,<span class="hljs-meta">ZERO</span><br>VECTOR <span class="hljs-number">0x80</span> ,<span class="hljs-meta">ZERO</span><br></code></pre></td></tr></table></figure>
<h3 id="userprogsyscall-inith创建"><a class="markdownIt-Anchor" href="#userprogsyscall-inith创建"></a> userprog/syscall-init.h创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __USERPROG_SYSCALLINIT_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __USERPROG_SYSCALLINIT_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><span class="hljs-type">void</span> <span class="hljs-title function_">syscall_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">sys_getpid</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
<h3 id="userprogsyscall-initc创建"><a class="markdownIt-Anchor" href="#userprogsyscall-initc创建"></a> userprog/syscall-init.c创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;syscall-init.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../lib/user/syscall.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;interrupt.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../thread/thread.h&quot;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> syscall_nr 32 </span><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span>* syscall;<br>syscall syscall_table[syscall_nr];<br><br><span class="hljs-comment">/* 返回当前任务的pid */</span><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">sys_getpid</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>   <span class="hljs-keyword">return</span> running_thread()-&gt;pid;<br>&#125;<br><br><span class="hljs-comment">/* 初始化系统调用 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">syscall_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>   put_str(<span class="hljs-string">&quot;syscall_init start\n&quot;</span>);<br>   syscall_table[SYS_GETPID]	    = sys_getpid;<br>   put_str(<span class="hljs-string">&quot;syscall_init done\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="threadthreadh修改"><a class="markdownIt-Anchor" href="#threadthreadh修改"></a> thread/thread.h修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __THREAD_THREAD_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __THREAD_THREAD_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;list.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;bitmap.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;memory.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TASK_NAME_LEN 16</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_FILES_OPEN_PER_PROC 8</span><br><span class="hljs-comment">/* 自定义通用函数类型,它将在很多线程函数中做为形参类型 */</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span> <span class="hljs-title function_">thread_func</span><span class="hljs-params">(<span class="hljs-type">void</span>*)</span>;<br><span class="hljs-keyword">typedef</span> <span class="hljs-type">int16_t</span> <span class="hljs-type">pid_t</span>;<br><br><span class="hljs-comment">/* 进程或线程的状态 */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">task_status</span> </span><br><span class="hljs-class">&#123;</span><br>   TASK_RUNNING,<br>   TASK_READY,<br>   TASK_BLOCKED,<br>   TASK_WAITING,<br>   TASK_HANGING,<br>   TASK_DIED<br>&#125;;<br><br><span class="hljs-comment">/***********   中断栈intr_stack   ***********</span><br><span class="hljs-comment"> * 此结构用于中断发生时保护程序(线程或进程)的上下文环境:</span><br><span class="hljs-comment"> * 进程或线程被外部中断或软中断打断时,会按照此结构压入上下文</span><br><span class="hljs-comment"> * 寄存器,  intr_exit中的出栈操作是此结构的逆操作</span><br><span class="hljs-comment"> * 此栈在线程自己的内核栈中位置固定,所在页的最顶端</span><br><span class="hljs-comment">********************************************/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">intr_stack</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint32_t</span> vec_no;	 <span class="hljs-comment">// kernel.S 宏VECTOR中push %1压入的中断号</span><br>    <span class="hljs-type">uint32_t</span> edi;<br>    <span class="hljs-type">uint32_t</span> esi;<br>    <span class="hljs-type">uint32_t</span> ebp;<br>    <span class="hljs-type">uint32_t</span> esp_dummy;	 <span class="hljs-comment">// 虽然pushad把esp也压入,但esp是不断变化的,所以会被popad忽略</span><br>    <span class="hljs-type">uint32_t</span> ebx;<br>    <span class="hljs-type">uint32_t</span> edx;<br>    <span class="hljs-type">uint32_t</span> ecx;<br>    <span class="hljs-type">uint32_t</span> eax;<br>    <span class="hljs-type">uint32_t</span> gs;<br>    <span class="hljs-type">uint32_t</span> fs;<br>    <span class="hljs-type">uint32_t</span> es;<br>    <span class="hljs-type">uint32_t</span> ds;<br><br><span class="hljs-comment">/* 以下由cpu从低特权级进入高特权级时压入 */</span><br>    <span class="hljs-type">uint32_t</span> err_code;		 <span class="hljs-comment">// err_code会被压入在eip之后</span><br>    <span class="hljs-type">void</span> (*eip) (<span class="hljs-type">void</span>);<br>    <span class="hljs-type">uint32_t</span> cs;<br>    <span class="hljs-type">uint32_t</span> eflags;<br>    <span class="hljs-type">void</span>* esp;<br>    <span class="hljs-type">uint32_t</span> ss;<br>&#125;;<br><br><span class="hljs-comment">/***********  线程栈thread_stack  ***********</span><br><span class="hljs-comment"> * 线程自己的栈,用于存储线程中待执行的函数</span><br><span class="hljs-comment"> * 此结构在线程自己的内核栈中位置不固定,</span><br><span class="hljs-comment"> * 用在switch_to时保存线程环境。</span><br><span class="hljs-comment"> * 实际位置取决于实际运行情况。</span><br><span class="hljs-comment"> ******************************************/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">thread_stack</span> </span><br><span class="hljs-class">&#123;</span><br>   <span class="hljs-type">uint32_t</span> ebp;<br>   <span class="hljs-type">uint32_t</span> ebx;<br>   <span class="hljs-type">uint32_t</span> edi;<br>   <span class="hljs-type">uint32_t</span> esi;<br><br><span class="hljs-comment">/* 线程第一次执行时,eip指向待调用的函数kernel_thread </span><br><span class="hljs-comment">其它时候,eip是指向switch_to的返回地址*/</span><br>   <span class="hljs-type">void</span> (*eip) (thread_func* func, <span class="hljs-type">void</span>* func_arg);<br><br><span class="hljs-comment">/*****   以下仅供第一次被调度上cpu时使用   ****/</span><br><br><span class="hljs-comment">/* 参数unused_ret只为占位置充数为返回地址 */</span><br>   <span class="hljs-type">void</span> (*unused_retaddr);<br>   thread_func* function;   <span class="hljs-comment">// 由Kernel_thread所调用的函数名</span><br>   <span class="hljs-type">void</span>* func_arg;    <span class="hljs-comment">// 由Kernel_thread所调用的函数所需的参数</span><br>&#125;;<br><br><span class="hljs-comment">/* 进程或线程的pcb,程序控制块 */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> </span><br><span class="hljs-class">&#123;</span><br>   <span class="hljs-type">uint32_t</span>* self_kstack;	 <span class="hljs-comment">// 各内核线程都用自己的内核栈</span><br>   <span class="hljs-type">pid_t</span> pid;<br>   <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">task_status</span> <span class="hljs-title">status</span>;</span><br>   <span class="hljs-type">char</span> name[TASK_NAME_LEN];<br>   <span class="hljs-type">uint8_t</span> priority;<br>   <span class="hljs-type">uint8_t</span> ticks;	   <span class="hljs-comment">// 每次在处理器上执行的时间嘀嗒数</span><br><span class="hljs-comment">/* 此任务自上cpu运行后至今占用了多少cpu嘀嗒数,</span><br><span class="hljs-comment"> * 也就是此任务执行了多久*/</span><br>   <span class="hljs-type">uint32_t</span> elapsed_ticks;<br><span class="hljs-comment">/* general_tag的作用是用于线程在一般的队列中的结点 */</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_elem</span> <span class="hljs-title">general_tag</span>;</span>				    <br><span class="hljs-comment">/* all_list_tag的作用是用于线程队列thread_all_list中的结点 */</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_elem</span> <span class="hljs-title">all_list_tag</span>;</span><br>   <span class="hljs-type">uint32_t</span>* pgdir;              <span class="hljs-comment">// 进程自己页表的虚拟地址</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtual_addr</span> <span class="hljs-title">userprog_vaddr</span>;</span>   <span class="hljs-comment">// 用户进程的虚拟地址 </span><br>   <span class="hljs-type">uint32_t</span> stack_magic;	 <span class="hljs-comment">// 用这串数字做栈的边界标记,用于检测栈的溢出</span><br>&#125;;<br><br><span class="hljs-keyword">extern</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list</span> <span class="hljs-title">thread_ready_list</span>;</span><br><span class="hljs-keyword">extern</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list</span> <span class="hljs-title">thread_all_list</span>;</span><br><br><span class="hljs-keyword">struct</span> task_struct* <span class="hljs-title function_">running_thread</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">kernel_thread</span><span class="hljs-params">(thread_func* function,<span class="hljs-type">void</span>* func_arg)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">thread_create</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct* pthread,thread_func function,<span class="hljs-type">void</span>* func_arg)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">init_thread</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct* pthread,<span class="hljs-type">char</span>* name,<span class="hljs-type">int</span> prio)</span>;<br><span class="hljs-keyword">struct</span> task_struct* <span class="hljs-title function_">thread_start</span><span class="hljs-params">(<span class="hljs-type">char</span>* name,<span class="hljs-type">int</span> prio,thread_func function,<span class="hljs-type">void</span>* func_arg)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">make_main_thread</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">schedule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">thread_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">thread_block</span><span class="hljs-params">(<span class="hljs-keyword">enum</span> task_status stat)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">thread_unblock</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct* pthread)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">pid_t</span> <span class="hljs-title function_">allocate_pid</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
<h3 id="threadthreadc修改"><a class="markdownIt-Anchor" href="#threadthreadc修改"></a> thread/thread.c修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;thread.h&quot;</span>   <span class="hljs-comment">//函数声明 各种结构体</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span>   <span class="hljs-comment">//前缀</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;string.h&quot;</span>   <span class="hljs-comment">//memset</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;global.h&quot;</span>   <span class="hljs-comment">//不清楚</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;memory.h&quot;</span>   <span class="hljs-comment">//分配页需要</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;debug.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;interrupt.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../userprog/process.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../thread/sync.h&quot;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PG_SIZE 4096</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span>* <span class="hljs-title">main_thread</span>;</span>    <span class="hljs-comment">// 主线程PCB</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list</span> <span class="hljs-title">thread_ready_list</span>;</span>	    <span class="hljs-comment">// 就绪队列</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list</span> <span class="hljs-title">thread_all_list</span>;</span>	    <span class="hljs-comment">// 所有任务队列</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_elem</span>* <span class="hljs-title">thread_tag</span>;</span><span class="hljs-comment">// 用于保存队列中的线程结点</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">lock</span> <span class="hljs-title">pid_lock</span>;</span><br><br><span class="hljs-comment">/* 获取当前线程pcb指针 */</span><br><span class="hljs-keyword">struct</span> task_struct* <span class="hljs-title function_">running_thread</span><span class="hljs-params">()</span> <br>&#123;<br>   	<span class="hljs-type">uint32_t</span> esp; <br>	<span class="hljs-keyword">asm</span> (<span class="hljs-string">&quot;mov %%esp, %0&quot;</span> : <span class="hljs-string">&quot;=g&quot;</span> (esp));<br>	<span class="hljs-comment">/* 取esp整数部分即pcb起始地址 */</span><br>	<span class="hljs-keyword">return</span> (<span class="hljs-keyword">struct</span> task_struct*)(esp &amp; <span class="hljs-number">0xfffff000</span>);<br>&#125;<br><br><br><span class="hljs-comment">/* 由kernel_thread去执行function(func_arg) */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">kernel_thread</span><span class="hljs-params">(thread_func* function, <span class="hljs-type">void</span>* func_arg)</span> <br>&#123;<br><span class="hljs-comment">/* 执行function前要开中断,避免后面的时钟中断被屏蔽,而无法调度其它线程 */</span><br>	intr_enable();<br>	function(func_arg); <br>&#125;<br><br><br><span class="hljs-comment">/* 初始化线程栈thread_stack,将待执行的函数和参数放到thread_stack中相应的位置 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">thread_create</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct* pthread, thread_func function, <span class="hljs-type">void</span>* func_arg)</span> <br>&#123;<br>	<span class="hljs-comment">/* 先预留中断使用栈的空间,可见thread.h中定义的结构 */</span><br>	pthread-&gt;self_kstack -= <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> intr_stack);<br><br>	<span class="hljs-comment">/* 再留出线程栈空间,可见thread.h中定义 */</span><br>	pthread-&gt;self_kstack -= <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> thread_stack);<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">thread_stack</span>* <span class="hljs-title">kthread_stack</span> =</span> (<span class="hljs-keyword">struct</span> thread_stack*)pthread-&gt;self_kstack;<br>	kthread_stack-&gt;eip = kernel_thread;<br>	kthread_stack-&gt;function = function;<br>	kthread_stack-&gt;func_arg = func_arg;<br>	kthread_stack-&gt;ebp = kthread_stack-&gt;ebx = kthread_stack-&gt;esi = kthread_stack-&gt;edi = <span class="hljs-number">0</span>;<br>&#125;<br><br><br><span class="hljs-comment">/* 初始化线程基本信息 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">init_thread</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct* pthread, <span class="hljs-type">char</span>* name, <span class="hljs-type">int</span> prio)</span> <br>&#123;<br>	<span class="hljs-built_in">memset</span>(pthread, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(*pthread));<br>   	pthread-&gt;pid = allocate_pid();<br>   	<span class="hljs-built_in">strcpy</span>(pthread-&gt;name, name);<br><br>	<span class="hljs-keyword">if</span> (pthread == main_thread) <br>	&#123;<br>	<span class="hljs-comment">/* 由于把main函数也封装成一个线程,并且它一直是运行的,故将其直接设为TASK_RUNNING */</span><br>		pthread-&gt;status = TASK_RUNNING;<br>	&#125; <br>	<span class="hljs-keyword">else</span> <br>	&#123;<br>		pthread-&gt;status = TASK_READY;<br>	&#125;<br><br>	<span class="hljs-comment">/* self_kstack是线程自己在内核态下使用的栈顶地址 */</span><br>	pthread-&gt;self_kstack = (<span class="hljs-type">uint32_t</span>*)((<span class="hljs-type">uint32_t</span>)pthread + PG_SIZE);<br>	pthread-&gt;priority = prio;<br>	pthread-&gt;ticks = prio;<br>	pthread-&gt;elapsed_ticks = <span class="hljs-number">0</span>;<br>	pthread-&gt;pgdir = <span class="hljs-literal">NULL</span>;<br>	pthread-&gt;stack_magic = <span class="hljs-number">0x19870916</span>;	  <span class="hljs-comment">// 自定义的魔数</span><br>&#125;<br><br><br><span class="hljs-comment">/* 创建一优先级为prio的线程,线程名为name,线程所执行的函数是function(func_arg) */</span><br><span class="hljs-keyword">struct</span> task_struct* <span class="hljs-title function_">thread_start</span><span class="hljs-params">(<span class="hljs-type">char</span>* name, <span class="hljs-type">int</span> prio, thread_func function, <span class="hljs-type">void</span>* func_arg)</span> <br>&#123;<br><span class="hljs-comment">/* pcb都位于内核空间,包括用户进程的pcb也是在内核空间 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span>* <span class="hljs-title">thread</span> =</span> get_kernel_pages(<span class="hljs-number">1</span>);<br>	init_thread(thread, name, prio);<br>	thread_create(thread, function, func_arg);<br><br>	<span class="hljs-comment">/* 确保之前不在队列中 */</span><br>	ASSERT(!elem_find(&amp;thread_ready_list, &amp;thread-&gt;general_tag));<br>	<span class="hljs-comment">/* 加入就绪线程队列 */</span><br>	list_append(&amp;thread_ready_list, &amp;thread-&gt;general_tag);<br><br>	<span class="hljs-comment">/* 确保之前不在队列中 */</span><br>	ASSERT(!elem_find(&amp;thread_all_list, &amp;thread-&gt;all_list_tag));<br>	<span class="hljs-comment">/* 加入全部线程队列 */</span><br>	list_append(&amp;thread_all_list, &amp;thread-&gt;all_list_tag);<br><br>	<span class="hljs-keyword">return</span> thread;<br>&#125;<br><br><br><span class="hljs-comment">/* 将kernel中的main函数完善为主线程 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">make_main_thread</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> <br>&#123;<br><span class="hljs-comment">/* 因为main线程早已运行,咱们在loader.S中进入内核时的mov esp,0xc009f000,</span><br><span class="hljs-comment">就是为其预留了tcb,地址为0xc009e000,因此不需要通过get_kernel_page另分配一页*/</span><br>	main_thread = running_thread();<br>	init_thread(main_thread, <span class="hljs-string">&quot;main&quot;</span>, <span class="hljs-number">31</span>);<br><br><span class="hljs-comment">/* main函数是当前线程,当前线程不在thread_ready_list中,</span><br><span class="hljs-comment"> * 所以只将其加在thread_all_list中. */</span><br>	ASSERT(!elem_find(&amp;thread_all_list, &amp;main_thread-&gt;all_list_tag));<br>	list_append(&amp;thread_all_list, &amp;main_thread-&gt;all_list_tag);<br>&#125;<br><br><br><span class="hljs-comment">/* 实现任务调度 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">schedule</span><span class="hljs-params">()</span> <br>&#123;<br>	ASSERT(intr_get_status() == INTR_OFF);<br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span>* <span class="hljs-title">cur</span> =</span> running_thread(); <br>	<span class="hljs-keyword">if</span> (cur-&gt;status == TASK_RUNNING) 		<span class="hljs-comment">// 若此线程只是cpu时间片到了,将其加入到就绪队列尾</span><br>	&#123; <br>		ASSERT(!elem_find(&amp;thread_ready_list, &amp;cur-&gt;general_tag));<br>		list_append(&amp;thread_ready_list, &amp;cur-&gt;general_tag);<br>		cur-&gt;ticks = cur-&gt;priority;     <span class="hljs-comment">// 重新将当前线程的ticks再重置为其priority;</span><br>		cur-&gt;status = TASK_READY;<br>	&#125; <br>	<span class="hljs-keyword">else</span> <br>	&#123; <br>		<span class="hljs-comment">/* 若此线程需要某事件发生后才能继续上cpu运行,</span><br><span class="hljs-comment">		不需要将其加入队列,因为当前线程不在就绪队列中。*/</span><br>	&#125;<br><br><br>	ASSERT(!list_empty(&amp;thread_ready_list));<br>	thread_tag = <span class="hljs-literal">NULL</span>;	  <span class="hljs-comment">// thread_tag清空</span><br>	<span class="hljs-comment">/* 将thread_ready_list队列中的第一个就绪线程弹出,准备将其调度上cpu. */</span><br>	thread_tag = list_pop(&amp;thread_ready_list);   <br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span>* <span class="hljs-title">next</span> =</span> elem2entry(<span class="hljs-keyword">struct</span> task_struct, general_tag, thread_tag);<br>	next-&gt;status = TASK_RUNNING;<br><br>	process_activate(next);<br>	switch_to(cur, next);<br>&#125;<br><br><br><span class="hljs-comment">/* 初始化线程环境 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">thread_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> <br>&#123;<br>	put_str(<span class="hljs-string">&quot;thread_init start\n&quot;</span>);<br><br>	list_init(&amp;thread_ready_list);<br>	list_init(&amp;thread_all_list);<br>	lock_init(&amp;pid_lock);<br><span class="hljs-comment">/* 将当前main函数创建为线程 */</span><br>	make_main_thread();<br>	put_str(<span class="hljs-string">&quot;thread_init done\n&quot;</span>);<br>&#125;<br><br><br><span class="hljs-comment">/* 当前线程将自己阻塞,标志其状态为stat. */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">thread_block</span><span class="hljs-params">(<span class="hljs-keyword">enum</span> task_status stat)</span> <br>&#123;<br><span class="hljs-comment">/* stat取值为TASK_BLOCKED,TASK_WAITING,TASK_HANGING,也就是只有这三种状态才不会被调度*/</span><br>	ASSERT(((stat == TASK_BLOCKED) || (stat == TASK_WAITING) || (stat == TASK_HANGING)));<br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">intr_status</span> <span class="hljs-title">old_status</span> =</span> intr_disable();<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span>* <span class="hljs-title">cur_thread</span> =</span> running_thread();<br>	cur_thread-&gt;status = stat; <span class="hljs-comment">// 置其状态为stat </span><br>	schedule();		      <span class="hljs-comment">// 将当前线程换下处理器</span><br><span class="hljs-comment">/* 待当前线程被解除阻塞后才继续运行下面的intr_set_status */</span><br>   	intr_set_status(old_status);<br>&#125;<br><br><br><span class="hljs-comment">/* 将线程pthread解除阻塞 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">thread_unblock</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct* pthread)</span> <br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">intr_status</span> <span class="hljs-title">old_status</span> =</span> intr_disable();<br>	ASSERT(((pthread-&gt;status == TASK_BLOCKED) || (pthread-&gt;status == TASK_WAITING) || (pthread-&gt;status == TASK_HANGING)));<br>	<span class="hljs-keyword">if</span> (pthread-&gt;status != TASK_READY) <br>	&#123;<br>		ASSERT(!elem_find(&amp;thread_ready_list, &amp;pthread-&gt;general_tag));<br>		<span class="hljs-keyword">if</span> (elem_find(&amp;thread_ready_list, &amp;pthread-&gt;general_tag)) <br>		&#123;<br>			PANIC(<span class="hljs-string">&quot;thread_unblock: blocked thread in ready_list\n&quot;</span>);<br>		&#125;<br>		list_push(&amp;thread_ready_list, &amp;pthread-&gt;general_tag);    <span class="hljs-comment">// 放到队列的最前面,使其尽快得到调度</span><br>		pthread-&gt;status = TASK_READY;<br>	&#125; <br>	intr_set_status(old_status);<br>&#125;<br><br><br><span class="hljs-comment">/* 分配pid */</span><br><span class="hljs-type">static</span> <span class="hljs-type">pid_t</span> <span class="hljs-title function_">allocate_pid</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> <br>&#123;<br>   <span class="hljs-type">static</span> <span class="hljs-type">pid_t</span> next_pid = <span class="hljs-number">0</span>;<br>   lock_acquire(&amp;pid_lock);	<br>   next_pid++;<br>   lock_release(&amp;pid_lock);<br>   <span class="hljs-keyword">return</span> next_pid;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="kernelinitc修改"><a class="markdownIt-Anchor" href="#kernelinitc修改"></a> kernel/init.c修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;init.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;interrupt.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../device/timer.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;memory.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../thread/thread.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../device/console.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../device/keyboard.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../userprog/tss.h&quot;</span></span><br><br><span class="hljs-comment">/*负责初始化所有模块 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">init_all</span><span class="hljs-params">()</span> <br>&#123;<br>   	put_str(<span class="hljs-string">&quot;init_all\n&quot;</span>);<br>	idt_init();	     <span class="hljs-comment">// 初始化中断</span><br>	mem_init();<br>	timer_init();<br>	thread_init();<br>	console_init();<br>	keyboard_init();<br>	tss_init();<br>	syscall_init();<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="kernelmainc修改"><a class="markdownIt-Anchor" href="#kernelmainc修改"></a> kernel/main.c修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;init.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;debug.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;string.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;memory.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../thread/thread.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;interrupt.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../device/console.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../device/ioqueue.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../device/keyboard.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../userprog/process.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../lib/user/syscall.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../userprog/syscall-init.h&quot;</span></span><br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">k_thread_a</span><span class="hljs-params">(<span class="hljs-type">void</span>* )</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">k_thread_b</span><span class="hljs-params">(<span class="hljs-type">void</span>* )</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">u_prog_a</span> <span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">u_prog_b</span> <span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><br><span class="hljs-type">int</span> prog_a_pid = <span class="hljs-number">0</span>, prog_b_pid=<span class="hljs-number">0</span>;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>   put_str(<span class="hljs-string">&quot;I am kernel\n&quot;</span>);<br>   init_all();<br>	<br>	process_execute(u_prog_a, <span class="hljs-string">&quot;user_prog_a&quot;</span>);<br>	process_execute(u_prog_b, <span class="hljs-string">&quot;user_prog_b&quot;</span>);<br>	<br>   intr_enable();<br>   console_put_str(<span class="hljs-string">&quot; main_pid:0x&quot;</span>);<br>   console_put_int(sys_getpid());<br>   console_put_char(<span class="hljs-string">&#x27;\n&#x27;</span>);<br>  <br>	thread_start(<span class="hljs-string">&quot;k_thread_a&quot;</span>, <span class="hljs-number">31</span>, k_thread_a, <span class="hljs-string">&quot;argA &quot;</span>);<br>	thread_start(<span class="hljs-string">&quot;k_thread_b&quot;</span>, <span class="hljs-number">8</span>, k_thread_b, <span class="hljs-string">&quot;argB &quot;</span>);<br>	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br>   <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">k_thread_a</span><span class="hljs-params">(<span class="hljs-type">void</span>* arg)</span>&#123;<br>	<span class="hljs-type">char</span>* para = arg;<br>	console_put_str(<span class="hljs-string">&quot; thread_a_pid:0x&quot;</span>);<br>   console_put_int(sys_getpid());<br>   console_put_char(<span class="hljs-string">&#x27;\n&#x27;</span>);<br>	console_put_str(<span class="hljs-string">&quot; prog_a_pid:0x&quot;</span>);<br>   console_put_int(prog_a_pid);<br>   console_put_char(<span class="hljs-string">&#x27;\n&#x27;</span>);<br>	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">k_thread_b</span><span class="hljs-params">(<span class="hljs-type">void</span>* arg)</span>&#123;<br>	<span class="hljs-type">char</span>* para = arg;<br>	console_put_str(<span class="hljs-string">&quot; thread_b_pid:0x&quot;</span>);<br>   console_put_int(sys_getpid());<br>   console_put_char(<span class="hljs-string">&#x27;\n&#x27;</span>);<br>	console_put_str(<span class="hljs-string">&quot; prog_b_pid:0x&quot;</span>);<br>   console_put_int(prog_b_pid);<br>   console_put_char(<span class="hljs-string">&#x27;\n&#x27;</span>);<br>   <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">u_prog_a</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>	prog_a_pid = getpid();<br>	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">u_prog_b</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>	prog_b_pid = getpid();<br>	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="makefile修改"><a class="markdownIt-Anchor" href="#makefile修改"></a> makefile修改</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><code class="hljs shell">BUILD_DIR = ./build<br>ENTRY_POINT = 0xc0001500<br>AS = nasm<br>CC = gcc<br>LD = ld<br>LIB = -I lib/ -I lib/kernel/ -I lib/user/ -I kernel/ -I device/ <br>ASFLAGS = -f elf<br>CFLAGS = -Wall -m32 -fno-stack-protector $(LIB) -c -fno-builtin -W -Wstrict-prototypes -Wmissing-prototypes<br>LDFLAGS =  -m elf_i386 -Ttext $(ENTRY_POINT) -e main -Map $(BUILD_DIR)/kernel.map<br>OBJS = $(BUILD_DIR)/main.o $(BUILD_DIR)/init.o $(BUILD_DIR)/interrupt.o \<br>      $(BUILD_DIR)/timer.o $(BUILD_DIR)/kernel.o $(BUILD_DIR)/print.o $(BUILD_DIR)/switch.o \<br>      $(BUILD_DIR)/debug.o $(BUILD_DIR)/string.o $(BUILD_DIR)/memory.o \<br>      $(BUILD_DIR)/bitmap.o $(BUILD_DIR)/thread.o $(BUILD_DIR)/list.o \<br>      $(BUILD_DIR)/sync.o $(BUILD_DIR)/console.o $(BUILD_DIR)/keyboard.o \<br>      $(BUILD_DIR)/ioqueue.o $(BUILD_DIR)/tss.o $(BUILD_DIR)/process.o \<br>      $(BUILD_DIR)/syscall-init.o $(BUILD_DIR)/syscall.o<br>      <br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#############     c代码编译     ###############</span></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/main.o: kernel/main.c lib/kernel/print.h \</span><br><span class="language-bash">        lib/stdint.h kernel/init.h lib/string.h kernel/memory.h \</span><br><span class="language-bash">        thread/thread.h kernel/interrupt.h device/console.h \</span><br><span class="language-bash">        device/keyboard.h device/ioqueue.h userprog/process.h \</span><br><span class="language-bash">        lib/user/syscall.h userprog/syscall-init.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/init.o: kernel/init.c kernel/init.h lib/kernel/print.h \</span><br><span class="language-bash">        lib/stdint.h kernel/interrupt.h device/timer.h kernel/memory.h \</span><br><span class="language-bash">        thread/thread.h device/console.h device/keyboard.h userprog/tss.h \</span><br><span class="language-bash">        userprog/syscall-init.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/interrupt.o: kernel/interrupt.c kernel/interrupt.h \</span><br><span class="language-bash">        lib/stdint.h kernel/global.h lib/kernel/io.h lib/kernel/print.h \</span><br><span class="language-bash">        kernel/kernel.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/timer.o: device/timer.c device/timer.h lib/kernel/io.h lib/kernel/print.h \</span><br><span class="language-bash">        kernel/interrupt.h thread/thread.h kernel/debug.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/debug.o: kernel/debug.c kernel/debug.h \</span><br><span class="language-bash">        lib/kernel/print.h lib/stdint.h kernel/interrupt.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/string.o: lib/string.c lib/string.h \</span><br><span class="language-bash">	kernel/debug.h kernel/global.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/memory.o: kernel/memory.c kernel/memory.h \</span><br><span class="language-bash">	lib/stdint.h lib/kernel/bitmap.h kernel/debug.h lib/string.h \</span><br><span class="language-bash">	thread/sync.h thread/thread.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/bitmap.o: lib/kernel/bitmap.c lib/kernel/bitmap.h kernel/global.h \</span><br><span class="language-bash">	lib/string.h kernel/interrupt.h lib/kernel/print.h kernel/debug.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/thread.o: thread/thread.c thread/thread.h \</span><br><span class="language-bash">	lib/stdint.h lib/string.h kernel/global.h kernel/memory.h \</span><br><span class="language-bash">	kernel/debug.h kernel/interrupt.h lib/kernel/print.h \</span><br><span class="language-bash">	userprog/process.h thread/sync.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/list.o: lib/kernel/list.c lib/kernel/list.h \</span><br><span class="language-bash">	kernel/interrupt.h lib/stdint.h kernel/debug.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/sync.o: thread/sync.c thread/sync.h \</span><br><span class="language-bash">	lib/stdint.h thread/thread.h kernel/debug.h kernel/interrupt.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/console.o: device/console.c device/console.h \</span><br><span class="language-bash">	lib/kernel/print.h thread/sync.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/keyboard.o: device/keyboard.c device/keyboard.h \</span><br><span class="language-bash">	lib/kernel/print.h lib/kernel/io.h kernel/interrupt.h \</span><br><span class="language-bash">	kernel/global.h lib/stdint.h device/ioqueue.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/ioqueue.o: device/ioqueue.c device/ioqueue.h \</span><br><span class="language-bash">	kernel/interrupt.h kernel/global.h kernel/debug.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/tss.o: userprog/tss.c userprog/tss.h \</span><br><span class="language-bash">	kernel/global.h thread/thread.h lib/kernel/print.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/process.o: userprog/process.c userprog/process.h \</span><br><span class="language-bash">	lib/string.h kernel/global.h kernel/memory.h lib/kernel/print.h \</span><br><span class="language-bash">	thread/thread.h kernel/interrupt.h kernel/debug.h device/console.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/syscall-init.o: userprog/syscall-init.c userprog/syscall-init.h \</span><br><span class="language-bash">	lib/user/syscall.h lib/stdint.h lib/kernel/print.h kernel/interrupt.h thread/thread.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/syscall.o: lib/user/syscall.c lib/user/syscall.h</span> <br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#############    汇编代码编译    ###############</span></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/kernel.o: kernel/kernel.S</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(AS) $(ASFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/print.o: lib/kernel/print.S</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(AS) $(ASFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/switch.o: thread/switch.S</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(AS) $(ASFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#############    链接所有目标文件    #############</span></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/kernel.bin: $(OBJS)</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(LD) $(LDFLAGS) $^ -o <span class="hljs-variable">$@</span></span><br><br>.PHONY : mk_dir hd clean all<br><br>mk_dir:<br>	if [ ! -d $(BUILD_DIR) ]; then mkdir $(BUILD_DIR); fi<br><br>hd:<br>	dd if=$(BUILD_DIR)/kernel.bin \<br>           of=/home/podest/bochs/hd60M.img \<br>           bs=512 count=200 seek=9 conv=notrunc<br><br>clean:<br>	cd $(BUILD_DIR) &amp;&amp; rm -f  ./*<br><br>build: $(BUILD_DIR)/kernel.bin<br><br>all: mk_dir build hd<br></code></pre></td></tr></table></figure>
<h3 id="运行结果"><a class="markdownIt-Anchor" href="#运行结果"></a> 运行结果</h3>
<p><img src="/img/os/os12.1.png" srcset="/img/loading.gif" lazyload alt="图为bochs运行界面" /></p>
<h2 id="实现printf函数"><a class="markdownIt-Anchor" href="#实现printf函数"></a> 实现printf函数</h2>
<h3 id="userprogsyscall-inith修改"><a class="markdownIt-Anchor" href="#userprogsyscall-inith修改"></a> userprog/syscall-init.h修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __USERPROG_SYSCALLINIT_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __USERPROG_SYSCALLINIT_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><span class="hljs-type">void</span> <span class="hljs-title function_">syscall_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">sys_write</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span>;<br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">sys_getpid</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
<h3 id="userprogsyscall-initc修改"><a class="markdownIt-Anchor" href="#userprogsyscall-initc修改"></a> userprog/syscall-init.c修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;syscall-init.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../lib/user/syscall.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;interrupt.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../thread/thread.h&quot;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> syscall_nr 32 </span><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span>* syscall;<br>syscall syscall_table[syscall_nr];<br><br><span class="hljs-comment">/* 返回当前任务的pid */</span><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">sys_getpid</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>   <span class="hljs-keyword">return</span> running_thread()-&gt;pid;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">sys_write</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span><br>&#123;<br>    console_put_str(str);<br>&#125;<br><br><span class="hljs-comment">/* 初始化系统调用 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">syscall_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>   put_str(<span class="hljs-string">&quot;syscall_init start\n&quot;</span>);<br>   syscall_table[SYS_GETPID] = sys_getpid;<br>   syscall_table[SYS_WRITE] = sys_write;<br>   put_str(<span class="hljs-string">&quot;syscall_init done\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="libusersyscallh修改"><a class="markdownIt-Anchor" href="#libusersyscallh修改"></a> lib/user/syscall.h修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __LIB_USER_SYSCALL_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LIB_USER_SYSCALL_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">SYSCALL_NR</span> </span><br><span class="hljs-class">&#123;</span><br>   SYS_GETPID,<br>   SYS_WRITE<br>&#125;;<br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">getpid</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">write</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
<h3 id="libusersyscallc修改"><a class="markdownIt-Anchor" href="#libusersyscallc修改"></a> lib/user/syscall.c修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;syscall.h&quot;</span></span><br><br><span class="hljs-comment">/* 无参数的系统调用 */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _syscall0(NUMBER) (&#123;				       \</span><br><span class="hljs-meta">   int retval;					               \</span><br><span class="hljs-meta">   asm volatile (					       \</span><br><span class="hljs-meta">   <span class="hljs-string">&quot;int $0x80&quot;</span>						       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;=a&quot;</span> (retval)					       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;a&quot;</span> (NUMBER)					       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;memory&quot;</span>						       \</span><br><span class="hljs-meta">   );							       \</span><br><span class="hljs-meta">   retval;						       \</span><br><span class="hljs-meta">&#125;)</span><br><br><br><span class="hljs-comment">/* 一个参数的系统调用 */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _syscall1(NUMBER, ARG1) (&#123;			       \</span><br><span class="hljs-meta">   int retval;					               \</span><br><span class="hljs-meta">   asm volatile (					       \</span><br><span class="hljs-meta">   <span class="hljs-string">&quot;int $0x80&quot;</span>						       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;=a&quot;</span> (retval)					       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;a&quot;</span> (NUMBER), <span class="hljs-string">&quot;b&quot;</span> (ARG1)				       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;memory&quot;</span>						       \</span><br><span class="hljs-meta">   );							       \</span><br><span class="hljs-meta">   retval;						       \</span><br><span class="hljs-meta">&#125;)</span><br><br><span class="hljs-comment">/* 两个参数的系统调用 */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _syscall2(NUMBER, ARG1, ARG2) (&#123;		       \</span><br><span class="hljs-meta">   int retval;						       \</span><br><span class="hljs-meta">   asm volatile (					       \</span><br><span class="hljs-meta">   <span class="hljs-string">&quot;int $0x80&quot;</span>						       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;=a&quot;</span> (retval)					       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;a&quot;</span> (NUMBER), <span class="hljs-string">&quot;b&quot;</span> (ARG1), <span class="hljs-string">&quot;c&quot;</span> (ARG2)		       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;memory&quot;</span>						       \</span><br><span class="hljs-meta">   );							       \</span><br><span class="hljs-meta">   retval;						       \</span><br><span class="hljs-meta">&#125;)</span><br><br><span class="hljs-comment">/* 三个参数的系统调用 */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _syscall3(NUMBER, ARG1, ARG2, ARG3) (&#123;		       \</span><br><span class="hljs-meta">   int retval;						       \</span><br><span class="hljs-meta">   asm volatile (					       \</span><br><span class="hljs-meta">      <span class="hljs-string">&quot;int $0x80&quot;</span>					       \</span><br><span class="hljs-meta">      : <span class="hljs-string">&quot;=a&quot;</span> (retval)					       \</span><br><span class="hljs-meta">      : <span class="hljs-string">&quot;a&quot;</span> (NUMBER), <span class="hljs-string">&quot;b&quot;</span> (ARG1), <span class="hljs-string">&quot;c&quot;</span> (ARG2), <span class="hljs-string">&quot;d&quot;</span> (ARG3)       \</span><br><span class="hljs-meta">      : <span class="hljs-string">&quot;memory&quot;</span>					       \</span><br><span class="hljs-meta">   );							       \</span><br><span class="hljs-meta">   retval;						       \</span><br><span class="hljs-meta">&#125;)</span><br><br><span class="hljs-comment">/* 返回当前任务pid */</span><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">getpid</span><span class="hljs-params">()</span> <br>&#123;<br>   <span class="hljs-keyword">return</span> _syscall0(SYS_GETPID);<br>&#125;<br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">write</span><span class="hljs-params">(<span class="hljs-type">char</span>* str)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> _syscall1(SYS_WRITE,str);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="libstdioh创建"><a class="markdownIt-Anchor" href="#libstdioh创建"></a> lib/stdio.h创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __LIB_STDIO_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LIB_STDIO_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">char</span>* va_list;<br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">printf</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* str, ...)</span>;<br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">vsprintf</span><span class="hljs-params">(<span class="hljs-type">char</span>* str, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* format, va_list ap)</span>;<br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">sprintf</span><span class="hljs-params">(<span class="hljs-type">char</span>* buf, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* format, ...)</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
<h3 id="libstdioc创建"><a class="markdownIt-Anchor" href="#libstdioc创建"></a> lib/stdio.c创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdio.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;string.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;syscall.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> va_start(ap, v) ap = (va_list)&amp;v  <span class="hljs-comment">// 把ap指向第一个固定参数v</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> va_arg(ap, t) *((t*)(ap += 4))	  <span class="hljs-comment">// ap指向下一个参数并返回其值</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> va_end(ap) ap = NULL		  <span class="hljs-comment">// 清除ap</span></span><br><br><span class="hljs-comment">/* 将整型转换成字符(integer to ascii) */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">itoa</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> value, <span class="hljs-type">char</span>** buf_ptr_addr, <span class="hljs-type">uint8_t</span> base)</span> &#123;<br>   <span class="hljs-type">uint32_t</span> m = value % base;	    <span class="hljs-comment">// 求模,最先掉下来的是最低位   </span><br>   <span class="hljs-type">uint32_t</span> i = value / base;	    <span class="hljs-comment">// 取整</span><br>   <span class="hljs-keyword">if</span> (i) &#123;			    <span class="hljs-comment">// 如果倍数不为0则递归调用。</span><br>      itoa(i, buf_ptr_addr, base);<br>   &#125;<br>   <span class="hljs-keyword">if</span> (m &lt; <span class="hljs-number">10</span>) &#123;      <span class="hljs-comment">// 如果余数是0~9</span><br>      *((*buf_ptr_addr)++) = m + <span class="hljs-string">&#x27;0&#x27;</span>;	  <span class="hljs-comment">// 将数字0~9转换为字符&#x27;0&#x27;~&#x27;9&#x27;</span><br>   &#125; <span class="hljs-keyword">else</span> &#123;	      <span class="hljs-comment">// 否则余数是A~F</span><br>      *((*buf_ptr_addr)++) = m - <span class="hljs-number">10</span> + <span class="hljs-string">&#x27;A&#x27;</span>; <span class="hljs-comment">// 将数字A~F转换为字符&#x27;A&#x27;~&#x27;F&#x27;</span><br>   &#125;<br>&#125;<br><br><span class="hljs-comment">/* 将参数ap按照格式format输出到字符串str,并返回替换后str长度 */</span><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">vsprintf</span><span class="hljs-params">(<span class="hljs-type">char</span>* str, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* format, va_list ap)</span> &#123;<br>   <span class="hljs-type">char</span>* buf_ptr = str;<br>   <span class="hljs-type">const</span> <span class="hljs-type">char</span>* index_ptr = format;<br>   <span class="hljs-type">char</span> index_char = *index_ptr;<br>   <span class="hljs-type">int32_t</span> arg_int;<br>   <span class="hljs-type">char</span>* arg_str;<br>   <span class="hljs-keyword">while</span>(index_char) &#123;<br>      <span class="hljs-keyword">if</span> (index_char != <span class="hljs-string">&#x27;%&#x27;</span>) &#123;<br>	 *(buf_ptr++) = index_char;<br>	 index_char = *(++index_ptr);<br>	 <span class="hljs-keyword">continue</span>;<br>      &#125;<br>      index_char = *(++index_ptr);	 <span class="hljs-comment">// 得到%后面的字符</span><br>      <span class="hljs-keyword">switch</span>(index_char) &#123;<br>	 <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;s&#x27;</span>:<br>	    arg_str = va_arg(ap, <span class="hljs-type">char</span>*);<br>	    <span class="hljs-built_in">strcpy</span>(buf_ptr, arg_str);<br>	    buf_ptr += <span class="hljs-built_in">strlen</span>(arg_str);<br>	    index_char = *(++index_ptr);<br>	    <span class="hljs-keyword">break</span>;<br><br>	 <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;c&#x27;</span>:<br>	    *(buf_ptr++) = va_arg(ap, <span class="hljs-type">char</span>);<br>	    index_char = *(++index_ptr);<br>	    <span class="hljs-keyword">break</span>;<br><br>	 <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;d&#x27;</span>:<br>	    arg_int = va_arg(ap, <span class="hljs-type">int</span>);<br>      <span class="hljs-comment">/* 若是负数, 将其转为正数后,再正数前面输出个负号&#x27;-&#x27;. */</span><br>	    <span class="hljs-keyword">if</span> (arg_int &lt; <span class="hljs-number">0</span>) &#123;<br>	       arg_int = <span class="hljs-number">0</span> - arg_int;<br>	       *buf_ptr++ = <span class="hljs-string">&#x27;-&#x27;</span>;<br>	    &#125;<br>	    itoa(arg_int, &amp;buf_ptr, <span class="hljs-number">10</span>); <br>	    index_char = *(++index_ptr);<br>	    <span class="hljs-keyword">break</span>;<br><br>	 <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;x&#x27;</span>:<br>	    arg_int = va_arg(ap, <span class="hljs-type">int</span>);<br>	    itoa(arg_int, &amp;buf_ptr, <span class="hljs-number">16</span>); <br>	    index_char = *(++index_ptr); <span class="hljs-comment">// 跳过格式字符并更新index_char</span><br>	    <span class="hljs-keyword">break</span>;<br>      &#125;<br>   &#125;<br>   <span class="hljs-keyword">return</span> <span class="hljs-built_in">strlen</span>(str);<br>&#125;<br><br><span class="hljs-comment">/* 同printf不同的地方就是字符串不是写到终端,而是写到buf中 */</span><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">sprintf</span><span class="hljs-params">(<span class="hljs-type">char</span>* buf, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* format, ...)</span> &#123;<br>   va_list args;<br>   <span class="hljs-type">uint32_t</span> retval;<br>   va_start(args, format);<br>   retval = <span class="hljs-built_in">vsprintf</span>(buf, format, args);<br>   va_end(args);<br>   <span class="hljs-keyword">return</span> retval;<br>&#125;<br><br><span class="hljs-comment">/* 格式化输出字符串format */</span><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">printf</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* format, ...)</span> &#123;<br>   va_list args;<br>   va_start(args, format);	       <span class="hljs-comment">// 使args指向format</span><br>   <span class="hljs-type">char</span> buf[<span class="hljs-number">1024</span>] = &#123;<span class="hljs-number">0</span>&#125;;	       <span class="hljs-comment">// 用于存储拼接后的字符串</span><br>   <span class="hljs-built_in">vsprintf</span>(buf, format, args);<br>   va_end(args);<br>   <span class="hljs-keyword">return</span> write(buf); <br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="kernelmainc修改-2"><a class="markdownIt-Anchor" href="#kernelmainc修改-2"></a> kernel/main.c修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;init.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;debug.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;string.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;memory.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../thread/thread.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;interrupt.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../device/console.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../device/ioqueue.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../device/keyboard.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../userprog/process.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../lib/user/syscall.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../userprog/syscall-init.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../lib/stdio.h&quot;</span></span><br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">k_thread_a</span><span class="hljs-params">(<span class="hljs-type">void</span>* )</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">k_thread_b</span><span class="hljs-params">(<span class="hljs-type">void</span>* )</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">u_prog_a</span> <span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">u_prog_b</span> <span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><br><span class="hljs-type">int</span> prog_a_pid = <span class="hljs-number">0</span>, prog_b_pid=<span class="hljs-number">0</span>;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>   put_str(<span class="hljs-string">&quot;I am kernel\n&quot;</span>);<br>   init_all();<br>	<br>	process_execute(u_prog_a, <span class="hljs-string">&quot;user_prog_a&quot;</span>);<br>	process_execute(u_prog_b, <span class="hljs-string">&quot;user_prog_b&quot;</span>);<br>	<br>   intr_enable();<br>   console_put_str(<span class="hljs-string">&quot; main_pid:0x&quot;</span>);<br>   console_put_int(sys_getpid());<br>   console_put_char(<span class="hljs-string">&#x27;\n&#x27;</span>);<br>  <br>	thread_start(<span class="hljs-string">&quot;k_thread_a&quot;</span>, <span class="hljs-number">31</span>, k_thread_a, <span class="hljs-string">&quot;argA &quot;</span>);<br>	thread_start(<span class="hljs-string">&quot;k_thread_b&quot;</span>, <span class="hljs-number">31</span>, k_thread_b, <span class="hljs-string">&quot;argB &quot;</span>);<br>	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br>   <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">k_thread_a</span><span class="hljs-params">(<span class="hljs-type">void</span>* arg)</span>&#123;<br>	<span class="hljs-type">char</span>* para = arg;<br>	console_put_str(<span class="hljs-string">&quot; thread_a_pid:0x&quot;</span>);<br>   console_put_int(sys_getpid());<br>   console_put_char(<span class="hljs-string">&#x27;\n&#x27;</span>);<br>	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">k_thread_b</span><span class="hljs-params">(<span class="hljs-type">void</span>* arg)</span>&#123;<br>	<span class="hljs-type">char</span>* para = arg;<br>	console_put_str(<span class="hljs-string">&quot; thread_b_pid:0x&quot;</span>);<br>   console_put_int(sys_getpid());<br>   console_put_char(<span class="hljs-string">&#x27;\n&#x27;</span>);<br>   <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">u_prog_a</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br><span class="hljs-type">char</span>* name = <span class="hljs-string">&quot;prog_a&quot;</span>;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; i am %s, my pid:%d%c&quot;</span>,name ,getpid(), <span class="hljs-string">&#x27;\n&#x27;</span>);<br>	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">u_prog_b</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br><span class="hljs-type">char</span>* name = <span class="hljs-string">&quot;prog_b&quot;</span>;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; i am %s, my pid:%d%c&quot;</span>,name ,getpid(), <span class="hljs-string">&#x27;\n&#x27;</span>);<br>	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="makefile修改-2"><a class="markdownIt-Anchor" href="#makefile修改-2"></a> makefile修改</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><code class="hljs shell">BUILD_DIR = ./build<br>ENTRY_POINT = 0xc0001500<br>AS = nasm<br>CC = gcc<br>LD = ld<br>LIB = -I lib/ -I lib/kernel/ -I lib/user/ -I kernel/ -I device/ <br>ASFLAGS = -f elf<br>CFLAGS = -Wall -m32 -fno-stack-protector $(LIB) -c -fno-builtin -W -Wstrict-prototypes -Wmissing-prototypes<br>LDFLAGS =  -m elf_i386 -Ttext $(ENTRY_POINT) -e main -Map $(BUILD_DIR)/kernel.map<br>OBJS = $(BUILD_DIR)/main.o $(BUILD_DIR)/init.o $(BUILD_DIR)/interrupt.o \<br>      $(BUILD_DIR)/timer.o $(BUILD_DIR)/kernel.o $(BUILD_DIR)/print.o $(BUILD_DIR)/switch.o \<br>      $(BUILD_DIR)/debug.o $(BUILD_DIR)/string.o $(BUILD_DIR)/memory.o \<br>      $(BUILD_DIR)/bitmap.o $(BUILD_DIR)/thread.o $(BUILD_DIR)/list.o \<br>      $(BUILD_DIR)/sync.o $(BUILD_DIR)/console.o $(BUILD_DIR)/keyboard.o \<br>      $(BUILD_DIR)/ioqueue.o $(BUILD_DIR)/tss.o $(BUILD_DIR)/process.o \<br>      $(BUILD_DIR)/syscall-init.o $(BUILD_DIR)/syscall.o $(BUILD_DIR)/stdio.o<br>      <br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#############     c代码编译     ###############</span></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/main.o: kernel/main.c lib/kernel/print.h \</span><br><span class="language-bash">        lib/stdint.h kernel/init.h lib/string.h kernel/memory.h \</span><br><span class="language-bash">        thread/thread.h kernel/interrupt.h device/console.h \</span><br><span class="language-bash">        device/keyboard.h device/ioqueue.h userprog/process.h \</span><br><span class="language-bash">        lib/user/syscall.h userprog/syscall-init.h lib/stdio.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/init.o: kernel/init.c kernel/init.h lib/kernel/print.h \</span><br><span class="language-bash">        lib/stdint.h kernel/interrupt.h device/timer.h kernel/memory.h \</span><br><span class="language-bash">        thread/thread.h device/console.h device/keyboard.h userprog/tss.h \</span><br><span class="language-bash">        userprog/syscall-init.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/interrupt.o: kernel/interrupt.c kernel/interrupt.h \</span><br><span class="language-bash">        lib/stdint.h kernel/global.h lib/kernel/io.h lib/kernel/print.h \</span><br><span class="language-bash">        kernel/kernel.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/timer.o: device/timer.c device/timer.h lib/kernel/io.h lib/kernel/print.h \</span><br><span class="language-bash">        kernel/interrupt.h thread/thread.h kernel/debug.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/debug.o: kernel/debug.c kernel/debug.h \</span><br><span class="language-bash">        lib/kernel/print.h lib/stdint.h kernel/interrupt.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/string.o: lib/string.c lib/string.h \</span><br><span class="language-bash">	kernel/debug.h kernel/global.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/memory.o: kernel/memory.c kernel/memory.h \</span><br><span class="language-bash">	lib/stdint.h lib/kernel/bitmap.h kernel/debug.h lib/string.h \</span><br><span class="language-bash">	thread/sync.h thread/thread.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/bitmap.o: lib/kernel/bitmap.c lib/kernel/bitmap.h kernel/global.h \</span><br><span class="language-bash">	lib/string.h kernel/interrupt.h lib/kernel/print.h kernel/debug.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/thread.o: thread/thread.c thread/thread.h \</span><br><span class="language-bash">	lib/stdint.h lib/string.h kernel/global.h kernel/memory.h \</span><br><span class="language-bash">	kernel/debug.h kernel/interrupt.h lib/kernel/print.h \</span><br><span class="language-bash">	userprog/process.h thread/sync.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/list.o: lib/kernel/list.c lib/kernel/list.h \</span><br><span class="language-bash">	kernel/interrupt.h lib/stdint.h kernel/debug.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/sync.o: thread/sync.c thread/sync.h \</span><br><span class="language-bash">	lib/stdint.h thread/thread.h kernel/debug.h kernel/interrupt.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/console.o: device/console.c device/console.h \</span><br><span class="language-bash">	lib/kernel/print.h thread/sync.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/keyboard.o: device/keyboard.c device/keyboard.h \</span><br><span class="language-bash">	lib/kernel/print.h lib/kernel/io.h kernel/interrupt.h \</span><br><span class="language-bash">	kernel/global.h lib/stdint.h device/ioqueue.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/ioqueue.o: device/ioqueue.c device/ioqueue.h \</span><br><span class="language-bash">	kernel/interrupt.h kernel/global.h kernel/debug.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/tss.o: userprog/tss.c userprog/tss.h \</span><br><span class="language-bash">	kernel/global.h thread/thread.h lib/kernel/print.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/process.o: userprog/process.c userprog/process.h \</span><br><span class="language-bash">	lib/string.h kernel/global.h kernel/memory.h lib/kernel/print.h \</span><br><span class="language-bash">	thread/thread.h kernel/interrupt.h kernel/debug.h device/console.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/syscall-init.o: userprog/syscall-init.c userprog/syscall-init.h \</span><br><span class="language-bash">	lib/user/syscall.h lib/stdint.h lib/kernel/print.h kernel/interrupt.h thread/thread.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/syscall.o: lib/user/syscall.c lib/user/syscall.h</span> <br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/stdio.o: lib/stdio.c lib/stdio.h lib/stdint.h lib/string.h lib/user/syscall.h</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(CC) $(CFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#############    汇编代码编译    ###############</span></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/kernel.o: kernel/kernel.S</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(AS) $(ASFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/print.o: lib/kernel/print.S</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(AS) $(ASFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/switch.o: thread/switch.S</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(AS) $(ASFLAGS) $&lt; -o <span class="hljs-variable">$@</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#############    链接所有目标文件    #############</span></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">(BUILD_DIR)/kernel.bin: $(OBJS)</span><br><span class="hljs-meta prompt_">	$</span><span class="language-bash">(LD) $(LDFLAGS) $^ -o <span class="hljs-variable">$@</span></span><br><br>.PHONY : mk_dir hd clean all<br><br>mk_dir:<br>	if [ ! -d $(BUILD_DIR) ]; then mkdir $(BUILD_DIR); fi<br><br>hd:<br>	dd if=$(BUILD_DIR)/kernel.bin \<br>           of=/home/podest/bochs/hd60M.img \<br>           bs=512 count=200 seek=9 conv=notrunc<br><br>clean:<br>	cd $(BUILD_DIR) &amp;&amp; rm -f  ./*<br><br>build: $(BUILD_DIR)/kernel.bin<br><br>all: mk_dir build hd<br></code></pre></td></tr></table></figure>
<h3 id="运行结果-2"><a class="markdownIt-Anchor" href="#运行结果-2"></a> 运行结果</h3>
<p><img src="/img/os/os12.2.png" srcset="/img/loading.gif" lazyload alt="图为bochs运行界面" /></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a>
                    
                      <a class="hover-with-bg" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E7%9C%9F%E8%B1%A1%E8%BF%98%E5%8E%9F/">真象还原</a>
                    
                  </div>
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/08/01/os(11)/">
                        <span class="hidden-mobile">第十一章 加入TSS 终于补齐进程调度</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <div style="font-size: 0.85rem"> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>





  

  
    <!-- KaTeX -->
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0/dist/katex.min.css" />
  











<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
