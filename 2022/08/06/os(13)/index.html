

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/app.png">
  <link rel="icon" href="/img/app.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="第十三章 创建从盘及分区表 编写硬盘驱动程序  写在前面 本章看似只有两节，但是内容依然不少。  创建从盘 磁盘分区表 没什么好说的，按照书上的步骤一步一步来就行，  分盘结果   bochsrc.disk修改 123456789101112131415161718megs : 32romimage: file&#x3D;&#x2F;home&#x2F;podest&#x2F;bochs&#x2F;share&#x2F;bochs&#x2F;BIOS-bochs-">
<meta property="og:type" content="article">
<meta property="og:title" content="第十三章 创建从盘及分区表 编写硬盘驱动程序">
<meta property="og:url" content="http://example.com/2022/08/06/os(13)/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="第十三章 创建从盘及分区表 编写硬盘驱动程序  写在前面 本章看似只有两节，但是内容依然不少。  创建从盘 磁盘分区表 没什么好说的，按照书上的步骤一步一步来就行，  分盘结果   bochsrc.disk修改 123456789101112131415161718megs : 32romimage: file&#x3D;&#x2F;home&#x2F;podest&#x2F;bochs&#x2F;share&#x2F;bochs&#x2F;BIOS-bochs-">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/os/os13.1.png">
<meta property="og:image" content="http://example.com/img/os/os13.2.png">
<meta property="article:published_time" content="2022-08-06T03:51:36.694Z">
<meta property="article:modified_time" content="2022-08-06T03:52:21.409Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/os/os13.1.png">
  
  
  <title>第十三章 创建从盘及分区表 编写硬盘驱动程序 - Hexo</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":50,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>羊</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/bg2.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="第十三章 创建从盘及分区表 编写硬盘驱动程序">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-08-06 11:51" pubdate>
        2022年8月6日 中午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      34k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      286 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">第十三章 创建从盘及分区表 编写硬盘驱动程序</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：1 个月前
                
              </p>
            
            <div class="markdown-body">
              <h1 id="第十三章-创建从盘及分区表-编写硬盘驱动程序"><a class="markdownIt-Anchor" href="#第十三章-创建从盘及分区表-编写硬盘驱动程序"></a> 第十三章 创建从盘及分区表 编写硬盘驱动程序</h1>
<h2 id="写在前面"><a class="markdownIt-Anchor" href="#写在前面"></a> 写在前面</h2>
<p>本章看似只有两节，但是内容依然不少。</p>
<h2 id="创建从盘-磁盘分区表"><a class="markdownIt-Anchor" href="#创建从盘-磁盘分区表"></a> 创建从盘 磁盘分区表</h2>
<p>没什么好说的，按照书上的步骤一步一步来就行，</p>
<h3 id="分盘结果"><a class="markdownIt-Anchor" href="#分盘结果"></a> 分盘结果</h3>
<p><img src="/img/os/os13.1.png" srcset="/img/loading.gif" lazyload alt="图为bochs运行界面" /></p>
<h3 id="bochsrcdisk修改"><a class="markdownIt-Anchor" href="#bochsrcdisk修改"></a> bochsrc.disk修改</h3>
<figure class="highlight routeros"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><pre><code class="hljs routeros">megs : 32<br><br>romimage: <span class="hljs-attribute">file</span>=/home/podest/bochs/share/bochs/BIOS-bochs-latest<br>vgaromimage: <span class="hljs-attribute">file</span>=/home/podest/bochs/share/bochs/VGABIOS-lgpl-latest<br><br>boot: disk<br><br>log: bochs.out<br><br>mouse:<span class="hljs-attribute">enabled</span>=0<br>keyboard:<span class="hljs-attribute">keymap</span>=/home/podest/bochs/share/bochs/keymaps/x11-pc-us.map<br><br>ata0:<span class="hljs-attribute">enabled</span>=1,ioaddr1=0x1f0,ioaddr2=0x3f0,irq=14<br><span class="hljs-comment">#新加入的代码</span><br>ata0-master: <span class="hljs-attribute">type</span>=disk, <span class="hljs-attribute">path</span>=<span class="hljs-string">&quot;hd60M.img&quot;</span>, <span class="hljs-attribute">mode</span>=flat,cylinders=121,heads=16,spt=63<br>ata0-slave:  <span class="hljs-attribute">type</span>=disk, <span class="hljs-attribute">path</span>=<span class="hljs-string">&quot;hd80M.img&quot;</span>, <span class="hljs-attribute">mode</span>=flat,cylinders=162,heads=16,spt=63<br><br><span class="hljs-comment">#gdbstub:enabled=1,port=1234,text_base=0,data_base=0,bss_base=0</span><br></code></pre></td></tr></table></figure>
<h2 id="编写硬盘驱动程序"><a class="markdownIt-Anchor" href="#编写硬盘驱动程序"></a> 编写硬盘驱动程序</h2>
<h3 id="threadthreadh修改"><a class="markdownIt-Anchor" href="#threadthreadh修改"></a> thread/thread.h修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __THREAD_THREAD_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __THREAD_THREAD_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;list.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;bitmap.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../kernel/memory.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TASK_NAME_LEN 16</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_FILES_OPEN_PER_PROC 8</span><br><span class="hljs-comment">/* 自定义通用函数类型,它将在很多线程函数中做为形参类型 */</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span> <span class="hljs-title function_">thread_func</span><span class="hljs-params">(<span class="hljs-type">void</span>*)</span>;<br><span class="hljs-keyword">typedef</span> <span class="hljs-type">int16_t</span> <span class="hljs-type">pid_t</span>;<br><br><span class="hljs-comment">/* 进程或线程的状态 */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">task_status</span> </span><br><span class="hljs-class">&#123;</span><br>   TASK_RUNNING,<br>   TASK_READY,<br>   TASK_BLOCKED,<br>   TASK_WAITING,<br>   TASK_HANGING,<br>   TASK_DIED<br>&#125;;<br><br><span class="hljs-comment">/***********   中断栈intr_stack   ***********</span><br><span class="hljs-comment"> * 此结构用于中断发生时保护程序(线程或进程)的上下文环境:</span><br><span class="hljs-comment"> * 进程或线程被外部中断或软中断打断时,会按照此结构压入上下文</span><br><span class="hljs-comment"> * 寄存器,  intr_exit中的出栈操作是此结构的逆操作</span><br><span class="hljs-comment"> * 此栈在线程自己的内核栈中位置固定,所在页的最顶端</span><br><span class="hljs-comment">********************************************/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">intr_stack</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint32_t</span> vec_no;	 <span class="hljs-comment">// kernel.S 宏VECTOR中push %1压入的中断号</span><br>    <span class="hljs-type">uint32_t</span> edi;<br>    <span class="hljs-type">uint32_t</span> esi;<br>    <span class="hljs-type">uint32_t</span> ebp;<br>    <span class="hljs-type">uint32_t</span> esp_dummy;	 <span class="hljs-comment">// 虽然pushad把esp也压入,但esp是不断变化的,所以会被popad忽略</span><br>    <span class="hljs-type">uint32_t</span> ebx;<br>    <span class="hljs-type">uint32_t</span> edx;<br>    <span class="hljs-type">uint32_t</span> ecx;<br>    <span class="hljs-type">uint32_t</span> eax;<br>    <span class="hljs-type">uint32_t</span> gs;<br>    <span class="hljs-type">uint32_t</span> fs;<br>    <span class="hljs-type">uint32_t</span> es;<br>    <span class="hljs-type">uint32_t</span> ds;<br><br><span class="hljs-comment">/* 以下由cpu从低特权级进入高特权级时压入 */</span><br>    <span class="hljs-type">uint32_t</span> err_code;		 <span class="hljs-comment">// err_code会被压入在eip之后</span><br>    <span class="hljs-type">void</span> (*eip) (<span class="hljs-type">void</span>);<br>    <span class="hljs-type">uint32_t</span> cs;<br>    <span class="hljs-type">uint32_t</span> eflags;<br>    <span class="hljs-type">void</span>* esp;<br>    <span class="hljs-type">uint32_t</span> ss;<br>&#125;;<br><br><span class="hljs-comment">/***********  线程栈thread_stack  ***********</span><br><span class="hljs-comment"> * 线程自己的栈,用于存储线程中待执行的函数</span><br><span class="hljs-comment"> * 此结构在线程自己的内核栈中位置不固定,</span><br><span class="hljs-comment"> * 用在switch_to时保存线程环境。</span><br><span class="hljs-comment"> * 实际位置取决于实际运行情况。</span><br><span class="hljs-comment"> ******************************************/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">thread_stack</span> </span><br><span class="hljs-class">&#123;</span><br>   <span class="hljs-type">uint32_t</span> ebp;<br>   <span class="hljs-type">uint32_t</span> ebx;<br>   <span class="hljs-type">uint32_t</span> edi;<br>   <span class="hljs-type">uint32_t</span> esi;<br><br><span class="hljs-comment">/* 线程第一次执行时,eip指向待调用的函数kernel_thread </span><br><span class="hljs-comment">其它时候,eip是指向switch_to的返回地址*/</span><br>   <span class="hljs-type">void</span> (*eip) (thread_func* func, <span class="hljs-type">void</span>* func_arg);<br><br><span class="hljs-comment">/*****   以下仅供第一次被调度上cpu时使用   ****/</span><br><br><span class="hljs-comment">/* 参数unused_ret只为占位置充数为返回地址 */</span><br>   <span class="hljs-type">void</span> (*unused_retaddr);<br>   thread_func* function;   <span class="hljs-comment">// 由Kernel_thread所调用的函数名</span><br>   <span class="hljs-type">void</span>* func_arg;    <span class="hljs-comment">// 由Kernel_thread所调用的函数所需的参数</span><br>&#125;;<br><br><span class="hljs-comment">/* 进程或线程的pcb,程序控制块 */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> </span><br><span class="hljs-class">&#123;</span><br>   <span class="hljs-type">uint32_t</span>* self_kstack;	 <span class="hljs-comment">// 各内核线程都用自己的内核栈</span><br>   <span class="hljs-type">pid_t</span> pid;<br>   <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">task_status</span> <span class="hljs-title">status</span>;</span><br>   <span class="hljs-type">char</span> name[TASK_NAME_LEN];<br>   <span class="hljs-type">uint8_t</span> priority;<br>   <span class="hljs-type">uint8_t</span> ticks;	   <span class="hljs-comment">// 每次在处理器上执行的时间嘀嗒数</span><br><span class="hljs-comment">/* 此任务自上cpu运行后至今占用了多少cpu嘀嗒数,</span><br><span class="hljs-comment"> * 也就是此任务执行了多久*/</span><br>   <span class="hljs-type">uint32_t</span> elapsed_ticks;<br><span class="hljs-comment">/* general_tag的作用是用于线程在一般的队列中的结点 */</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_elem</span> <span class="hljs-title">general_tag</span>;</span>				    <br><span class="hljs-comment">/* all_list_tag的作用是用于线程队列thread_all_list中的结点 */</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_elem</span> <span class="hljs-title">all_list_tag</span>;</span><br>   <span class="hljs-type">uint32_t</span>* pgdir;              <span class="hljs-comment">// 进程自己页表的虚拟地址</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtual_addr</span> <span class="hljs-title">userprog_vaddr</span>;</span>   <span class="hljs-comment">// 用户进程的虚拟地址 </span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mem_block_desc</span> <span class="hljs-title">u_block_desc</span>[<span class="hljs-title">DESC_CNT</span>];</span>   <span class="hljs-comment">// 用户进程内存块描述符</span><br>   <span class="hljs-type">uint32_t</span> stack_magic;	 <span class="hljs-comment">// 用这串数字做栈的边界标记,用于检测栈的溢出</span><br>&#125;;<br><br><span class="hljs-keyword">extern</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list</span> <span class="hljs-title">thread_ready_list</span>;</span><br><span class="hljs-keyword">extern</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list</span> <span class="hljs-title">thread_all_list</span>;</span><br><br><span class="hljs-keyword">struct</span> task_struct* <span class="hljs-title function_">running_thread</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">kernel_thread</span><span class="hljs-params">(thread_func* function,<span class="hljs-type">void</span>* func_arg)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">thread_create</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct* pthread,thread_func function,<span class="hljs-type">void</span>* func_arg)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">init_thread</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct* pthread,<span class="hljs-type">char</span>* name,<span class="hljs-type">int</span> prio)</span>;<br><span class="hljs-keyword">struct</span> task_struct* <span class="hljs-title function_">thread_start</span><span class="hljs-params">(<span class="hljs-type">char</span>* name,<span class="hljs-type">int</span> prio,thread_func function,<span class="hljs-type">void</span>* func_arg)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">make_main_thread</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">schedule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">thread_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">thread_block</span><span class="hljs-params">(<span class="hljs-keyword">enum</span> task_status stat)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">thread_unblock</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct* pthread)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">pid_t</span> <span class="hljs-title function_">allocate_pid</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">thread_yield</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">idle</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
<h3 id="threadthreadc修改"><a class="markdownIt-Anchor" href="#threadthreadc修改"></a> thread/thread.c修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;thread.h&quot;</span>   <span class="hljs-comment">//函数声明 各种结构体</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span>   <span class="hljs-comment">//前缀</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;string.h&quot;</span>   <span class="hljs-comment">//memset</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;global.h&quot;</span>   <span class="hljs-comment">//不清楚</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;memory.h&quot;</span>   <span class="hljs-comment">//分配页需要</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;debug.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;interrupt.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../userprog/process.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../thread/sync.h&quot;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PG_SIZE 4096</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span>* <span class="hljs-title">main_thread</span>;</span>    <span class="hljs-comment">// 主线程PCB</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span>* <span class="hljs-title">idle_thread</span>;</span>    <span class="hljs-comment">// idle线程</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list</span> <span class="hljs-title">thread_ready_list</span>;</span>	    <span class="hljs-comment">// 就绪队列</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list</span> <span class="hljs-title">thread_all_list</span>;</span>	    <span class="hljs-comment">// 所有任务队列</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_elem</span>* <span class="hljs-title">thread_tag</span>;</span><span class="hljs-comment">// 用于保存队列中的线程结点</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">lock</span> <span class="hljs-title">pid_lock</span>;</span><br><br><br><span class="hljs-comment">/* 获取当前线程pcb指针 */</span><br><span class="hljs-keyword">struct</span> task_struct* <span class="hljs-title function_">running_thread</span><span class="hljs-params">()</span> <br>&#123;<br>   	<span class="hljs-type">uint32_t</span> esp; <br>	<span class="hljs-keyword">asm</span> (<span class="hljs-string">&quot;mov %%esp, %0&quot;</span> : <span class="hljs-string">&quot;=g&quot;</span> (esp));<br>	<span class="hljs-comment">/* 取esp整数部分即pcb起始地址 */</span><br>	<span class="hljs-keyword">return</span> (<span class="hljs-keyword">struct</span> task_struct*)(esp &amp; <span class="hljs-number">0xfffff000</span>);<br>&#125;<br><br><br><span class="hljs-comment">/* 由kernel_thread去执行function(func_arg) */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">kernel_thread</span><span class="hljs-params">(thread_func* function, <span class="hljs-type">void</span>* func_arg)</span> <br>&#123;<br><span class="hljs-comment">/* 执行function前要开中断,避免后面的时钟中断被屏蔽,而无法调度其它线程 */</span><br>	intr_enable();<br>	function(func_arg); <br>&#125;<br><br><br><span class="hljs-comment">/* 初始化线程栈thread_stack,将待执行的函数和参数放到thread_stack中相应的位置 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">thread_create</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct* pthread, thread_func function, <span class="hljs-type">void</span>* func_arg)</span> <br>&#123;<br>	<span class="hljs-comment">/* 先预留中断使用栈的空间,可见thread.h中定义的结构 */</span><br>	pthread-&gt;self_kstack -= <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> intr_stack);<br><br>	<span class="hljs-comment">/* 再留出线程栈空间,可见thread.h中定义 */</span><br>	pthread-&gt;self_kstack -= <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> thread_stack);<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">thread_stack</span>* <span class="hljs-title">kthread_stack</span> =</span> (<span class="hljs-keyword">struct</span> thread_stack*)pthread-&gt;self_kstack;<br>	kthread_stack-&gt;eip = kernel_thread;<br>	kthread_stack-&gt;function = function;<br>	kthread_stack-&gt;func_arg = func_arg;<br>	kthread_stack-&gt;ebp = kthread_stack-&gt;ebx = kthread_stack-&gt;esi = kthread_stack-&gt;edi = <span class="hljs-number">0</span>;<br>&#125;<br><br><br><span class="hljs-comment">/* 初始化线程基本信息 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">init_thread</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct* pthread, <span class="hljs-type">char</span>* name, <span class="hljs-type">int</span> prio)</span> <br>&#123;<br>	<span class="hljs-built_in">memset</span>(pthread, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(*pthread));<br>   	pthread-&gt;pid = allocate_pid();<br>   	<span class="hljs-built_in">strcpy</span>(pthread-&gt;name, name);<br><br>	<span class="hljs-keyword">if</span> (pthread == main_thread) <br>	&#123;<br>	<span class="hljs-comment">/* 由于把main函数也封装成一个线程,并且它一直是运行的,故将其直接设为TASK_RUNNING */</span><br>		pthread-&gt;status = TASK_RUNNING;<br>	&#125; <br>	<span class="hljs-keyword">else</span> <br>	&#123;<br>		pthread-&gt;status = TASK_READY;<br>	&#125;<br><br>	<span class="hljs-comment">/* self_kstack是线程自己在内核态下使用的栈顶地址 */</span><br>	pthread-&gt;self_kstack = (<span class="hljs-type">uint32_t</span>*)((<span class="hljs-type">uint32_t</span>)pthread + PG_SIZE);<br>	pthread-&gt;priority = prio;<br>	pthread-&gt;ticks = prio;<br>	pthread-&gt;elapsed_ticks = <span class="hljs-number">0</span>;<br>	pthread-&gt;pgdir = <span class="hljs-literal">NULL</span>;<br>	pthread-&gt;stack_magic = <span class="hljs-number">0x19870916</span>;	  <span class="hljs-comment">// 自定义的魔数</span><br>&#125;<br><br><br><span class="hljs-comment">/* 创建一优先级为prio的线程,线程名为name,线程所执行的函数是function(func_arg) */</span><br><span class="hljs-keyword">struct</span> task_struct* <span class="hljs-title function_">thread_start</span><span class="hljs-params">(<span class="hljs-type">char</span>* name, <span class="hljs-type">int</span> prio, thread_func function, <span class="hljs-type">void</span>* func_arg)</span> <br>&#123;<br><span class="hljs-comment">/* pcb都位于内核空间,包括用户进程的pcb也是在内核空间 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span>* <span class="hljs-title">thread</span> =</span> get_kernel_pages(<span class="hljs-number">1</span>);<br>	init_thread(thread, name, prio);<br>	thread_create(thread, function, func_arg);<br><br>	<span class="hljs-comment">/* 确保之前不在队列中 */</span><br>	ASSERT(!elem_find(&amp;thread_ready_list, &amp;thread-&gt;general_tag));<br>	<span class="hljs-comment">/* 加入就绪线程队列 */</span><br>	list_append(&amp;thread_ready_list, &amp;thread-&gt;general_tag);<br><br>	<span class="hljs-comment">/* 确保之前不在队列中 */</span><br>	ASSERT(!elem_find(&amp;thread_all_list, &amp;thread-&gt;all_list_tag));<br>	<span class="hljs-comment">/* 加入全部线程队列 */</span><br>	list_append(&amp;thread_all_list, &amp;thread-&gt;all_list_tag);<br><br>	<span class="hljs-keyword">return</span> thread;<br>&#125;<br><br><br><span class="hljs-comment">/* 将kernel中的main函数完善为主线程 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">make_main_thread</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> <br>&#123;<br><span class="hljs-comment">/* 因为main线程早已运行,咱们在loader.S中进入内核时的mov esp,0xc009f000,</span><br><span class="hljs-comment">就是为其预留了tcb,地址为0xc009e000,因此不需要通过get_kernel_page另分配一页*/</span><br>	main_thread = running_thread();<br>	init_thread(main_thread, <span class="hljs-string">&quot;main&quot;</span>, <span class="hljs-number">31</span>);<br><br><span class="hljs-comment">/* main函数是当前线程,当前线程不在thread_ready_list中,</span><br><span class="hljs-comment"> * 所以只将其加在thread_all_list中. */</span><br>	ASSERT(!elem_find(&amp;thread_all_list, &amp;main_thread-&gt;all_list_tag));<br>	list_append(&amp;thread_all_list, &amp;main_thread-&gt;all_list_tag);<br>&#125;<br><br><br><span class="hljs-comment">/* 实现任务调度 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">schedule</span><span class="hljs-params">()</span> <br>&#123;<br>	ASSERT(intr_get_status() == INTR_OFF);<br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span>* <span class="hljs-title">cur</span> =</span> running_thread(); <br>	<span class="hljs-keyword">if</span> (cur-&gt;status == TASK_RUNNING) 		<span class="hljs-comment">// 若此线程只是cpu时间片到了,将其加入到就绪队列尾</span><br>	&#123; <br>		ASSERT(!elem_find(&amp;thread_ready_list, &amp;cur-&gt;general_tag));<br>		list_append(&amp;thread_ready_list, &amp;cur-&gt;general_tag);<br>		cur-&gt;ticks = cur-&gt;priority;     <span class="hljs-comment">// 重新将当前线程的ticks再重置为其priority;</span><br>		cur-&gt;status = TASK_READY;<br>	&#125; <br>	<span class="hljs-keyword">else</span> <br>	&#123; <br>		<span class="hljs-comment">/* 若此线程需要某事件发生后才能继续上cpu运行,</span><br><span class="hljs-comment">		不需要将其加入队列,因为当前线程不在就绪队列中。*/</span><br>	&#125;<br><br>	<span class="hljs-comment">/* 如果就绪队列中没有可运行的任务,就唤醒idle */</span><br>	<span class="hljs-keyword">if</span> (list_empty(&amp;thread_ready_list)) <br>	&#123;<br>		thread_unblock(idle_thread);<br>	&#125;<br><br>	ASSERT(!list_empty(&amp;thread_ready_list));<br>	thread_tag = <span class="hljs-literal">NULL</span>;	  <span class="hljs-comment">// thread_tag清空</span><br>	<span class="hljs-comment">/* 将thread_ready_list队列中的第一个就绪线程弹出,准备将其调度上cpu. */</span><br>	thread_tag = list_pop(&amp;thread_ready_list);   <br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span>* <span class="hljs-title">next</span> =</span> elem2entry(<span class="hljs-keyword">struct</span> task_struct, general_tag, thread_tag);<br>	next-&gt;status = TASK_RUNNING;<br><br>	process_activate(next);<br>	switch_to(cur, next);<br>&#125;<br><br><br><span class="hljs-comment">/* 初始化线程环境 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">thread_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> <br>&#123;<br>	put_str(<span class="hljs-string">&quot;thread_init start\n&quot;</span>);<br><br>	list_init(&amp;thread_ready_list);<br>	list_init(&amp;thread_all_list);<br>	lock_init(&amp;pid_lock);<br>	<span class="hljs-comment">/* 将当前main函数创建为线程 */</span><br>	make_main_thread();<br>	<span class="hljs-comment">/* 创建idle线程 */</span><br>  	idle_thread = thread_start(<span class="hljs-string">&quot;idle&quot;</span>, <span class="hljs-number">10</span>, idle, <span class="hljs-literal">NULL</span>);<br>	put_str(<span class="hljs-string">&quot;thread_init done\n&quot;</span>);<br>&#125;<br><br><br><span class="hljs-comment">/* 当前线程将自己阻塞,标志其状态为stat. */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">thread_block</span><span class="hljs-params">(<span class="hljs-keyword">enum</span> task_status stat)</span> <br>&#123;<br><span class="hljs-comment">/* stat取值为TASK_BLOCKED,TASK_WAITING,TASK_HANGING,也就是只有这三种状态才不会被调度*/</span><br>	ASSERT(((stat == TASK_BLOCKED) || (stat == TASK_WAITING) || (stat == TASK_HANGING)));<br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">intr_status</span> <span class="hljs-title">old_status</span> =</span> intr_disable();<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span>* <span class="hljs-title">cur_thread</span> =</span> running_thread();<br>	cur_thread-&gt;status = stat; <span class="hljs-comment">// 置其状态为stat </span><br>	schedule();		      <span class="hljs-comment">// 将当前线程换下处理器</span><br><span class="hljs-comment">/* 待当前线程被解除阻塞后才继续运行下面的intr_set_status */</span><br>   	intr_set_status(old_status);<br>&#125;<br><br><br><span class="hljs-comment">/* 将线程pthread解除阻塞 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">thread_unblock</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct* pthread)</span> <br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">intr_status</span> <span class="hljs-title">old_status</span> =</span> intr_disable();<br>	ASSERT(((pthread-&gt;status == TASK_BLOCKED) || (pthread-&gt;status == TASK_WAITING) || (pthread-&gt;status == TASK_HANGING)));<br>	<span class="hljs-keyword">if</span> (pthread-&gt;status != TASK_READY) <br>	&#123;<br>		ASSERT(!elem_find(&amp;thread_ready_list, &amp;pthread-&gt;general_tag));<br>		<span class="hljs-keyword">if</span> (elem_find(&amp;thread_ready_list, &amp;pthread-&gt;general_tag)) <br>		&#123;<br>			PANIC(<span class="hljs-string">&quot;thread_unblock: blocked thread in ready_list\n&quot;</span>);<br>		&#125;<br>		list_push(&amp;thread_ready_list, &amp;pthread-&gt;general_tag);    <span class="hljs-comment">// 放到队列的最前面,使其尽快得到调度</span><br>		pthread-&gt;status = TASK_READY;<br>	&#125; <br>	intr_set_status(old_status);<br>&#125;<br><br><br><span class="hljs-comment">/* 分配pid */</span><br><span class="hljs-type">static</span> <span class="hljs-type">pid_t</span> <span class="hljs-title function_">allocate_pid</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> <br>&#123;<br>   <span class="hljs-type">static</span> <span class="hljs-type">pid_t</span> next_pid = <span class="hljs-number">0</span>;<br>   lock_acquire(&amp;pid_lock);	<br>   next_pid++;<br>   lock_release(&amp;pid_lock);<br>   <span class="hljs-keyword">return</span> next_pid;<br>&#125;<br><br><br><span class="hljs-comment">/* 系统空闲时运行的线程 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">idle</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) <br>	&#123;<br>		thread_block(TASK_BLOCKED);     <br>		<span class="hljs-comment">//执行hlt时必须要保证目前处在开中断的情况下</span><br>		<span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span> <span class="hljs-params">(<span class="hljs-string">&quot;sti; hlt&quot;</span> : : : <span class="hljs-string">&quot;memory&quot;</span>)</span>;<br>	&#125;<br>&#125;<br><br><br><span class="hljs-comment">/* 主动让出cpu,换其它线程运行 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">thread_yield</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> <br>&#123;<br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span>* <span class="hljs-title">cur</span> =</span> running_thread();   <br>   <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">intr_status</span> <span class="hljs-title">old_status</span> =</span> intr_disable();<br>   ASSERT(!elem_find(&amp;thread_ready_list, &amp;cur-&gt;general_tag));<br>   list_append(&amp;thread_ready_list, &amp;cur-&gt;general_tag);<br>   cur-&gt;status = TASK_READY;<br>   schedule();<br>   intr_set_status(old_status);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="kernelinterruptc修改"><a class="markdownIt-Anchor" href="#kernelinterruptc修改"></a> kernel/interrupt.c修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;interrupt.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;global.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;io.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIC_M_CTRL 0x20	       <span class="hljs-comment">// 这里用的可编程中断控制器是8259A,主片的控制端口是0x20</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIC_M_DATA 0x21	       <span class="hljs-comment">// 主片的数据端口是0x21</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIC_S_CTRL 0xa0	       <span class="hljs-comment">// 从片的控制端口是0xa0</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIC_S_DATA 0xa1	       <span class="hljs-comment">// 从片的数据端口是0xa1</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IDT_DESC_CNT 0x81      <span class="hljs-comment">// 目前总共支持的中断数</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EFLAGS_IF   0x00000200       <span class="hljs-comment">// eflags寄存器中的if位为1</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> GET_EFLAGS(EFLAG_VAR) asm volatile(<span class="hljs-string">&quot;pushfl; popl %0&quot;</span> : <span class="hljs-string">&quot;=g&quot;</span> (EFLAG_VAR))</span><br><br><span class="hljs-comment">/*中断门描述符结构体*/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">gate_desc</span> </span><br><span class="hljs-class">&#123;</span><br>   <span class="hljs-type">uint16_t</span>    func_offset_low_word;<br>   <span class="hljs-type">uint16_t</span>    selector;<br>   <span class="hljs-type">uint8_t</span>     dcount;   <span class="hljs-comment">//此项为双字计数字段，是门描述符中的第4字节。此项固定值，不用考虑</span><br>   <span class="hljs-type">uint8_t</span>     attribute;<br>   <span class="hljs-type">uint16_t</span>    func_offset_high_word;<br>&#125;;<br><br><span class="hljs-comment">// 静态函数声明,非必须</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">make_idt_desc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> gate_desc* p_gdesc, <span class="hljs-type">uint8_t</span> attr, intr_handler function)</span>;<br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">gate_desc</span> <span class="hljs-title">idt</span>[<span class="hljs-title">IDT_DESC_CNT</span>];</span>   <span class="hljs-comment">// idt是中断描述符表,本质上就是个中断门描述符数组</span><br><br><br><span class="hljs-type">char</span>* intr_name[IDT_DESC_CNT];		     <span class="hljs-comment">// 用于保存异常的名字</span><br><br><br><span class="hljs-comment">/********    定义中断处理程序数组    ********</span><br><span class="hljs-comment"> * 在kernel.S中定义的intrXXentry只是中断处理程序的入口,</span><br><span class="hljs-comment"> * 最终调用的是ide_table中的处理程序*/</span><br>intr_handler idt_table[IDT_DESC_CNT];<br><br><span class="hljs-comment">/********************************************/</span><br><span class="hljs-keyword">extern</span> intr_handler intr_entry_table[IDT_DESC_CNT];	    <span class="hljs-comment">// 声明引用定义在kernel.S中的中断处理函数入口数组</span><br><span class="hljs-keyword">extern</span> <span class="hljs-type">uint32_t</span> <span class="hljs-title function_">syscall_handler</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><br><br><br><br><span class="hljs-comment">/* 初始化可编程中断控制器8259A */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">pic_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> <br>&#123;<br>   <span class="hljs-comment">/* 初始化主片 */</span><br>   outb (PIC_M_CTRL, <span class="hljs-number">0x11</span>);   <span class="hljs-comment">// ICW1: 边沿触发,级联8259, 需要ICW4.</span><br>   outb (PIC_M_DATA, <span class="hljs-number">0x20</span>);   <span class="hljs-comment">// ICW2: 起始中断向量号为0x20,也就是IR[0-7] 为 0x20 ~ 0x27.</span><br>   outb (PIC_M_DATA, <span class="hljs-number">0x04</span>);   <span class="hljs-comment">// ICW3: IR2接从片. </span><br>   outb (PIC_M_DATA, <span class="hljs-number">0x01</span>);   <span class="hljs-comment">// ICW4: 8086模式, 正常EOI</span><br><br>   <span class="hljs-comment">/* 初始化从片 */</span><br>   outb (PIC_S_CTRL, <span class="hljs-number">0x11</span>);    <span class="hljs-comment">// ICW1: 边沿触发,级联8259, 需要ICW4.</span><br>   outb (PIC_S_DATA, <span class="hljs-number">0x28</span>);    <span class="hljs-comment">// ICW2: 起始中断向量号为0x28,也就是IR[8-15] 为 0x28 ~ 0x2F.</span><br>   outb (PIC_S_DATA, <span class="hljs-number">0x02</span>);    <span class="hljs-comment">// ICW3: 设置从片连接到主片的IR2引脚</span><br>   outb (PIC_S_DATA, <span class="hljs-number">0x01</span>);    <span class="hljs-comment">// ICW4: 8086模式, 正常EOI</span><br>   <br>   <span class="hljs-comment">//outb (PIC_M_DATA, 0xfe);</span><br>   <span class="hljs-comment">//outb (PIC_S_DATA, 0xff);</span><br><br>   <span class="hljs-comment">//outb (PIC_M_DATA, 0xfd);</span><br>   <span class="hljs-comment">//outb (PIC_S_DATA, 0xff);</span><br><br>   <span class="hljs-comment">//outb (PIC_M_DATA, 0xfc);</span><br>   <span class="hljs-comment">//outb (PIC_S_DATA, 0xff);</span><br><br>   outb (PIC_M_DATA, <span class="hljs-number">0xf8</span>);<br>   outb (PIC_S_DATA, <span class="hljs-number">0xbf</span>);<br><br>   put_str(<span class="hljs-string">&quot;   pic_init done\n&quot;</span>);<br>&#125;<br><br><br><span class="hljs-comment">/* 创建中断门描述符 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">make_idt_desc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> gate_desc* p_gdesc, <span class="hljs-type">uint8_t</span> attr, intr_handler function)</span> <br>&#123; <br>   p_gdesc-&gt;func_offset_low_word = (<span class="hljs-type">uint32_t</span>)function &amp; <span class="hljs-number">0x0000FFFF</span>;<br>   p_gdesc-&gt;selector = SELECTOR_K_CODE;<br>   p_gdesc-&gt;dcount = <span class="hljs-number">0</span>;<br>   p_gdesc-&gt;attribute = attr;<br>   p_gdesc-&gt;func_offset_high_word = ((<span class="hljs-type">uint32_t</span>)function &amp; <span class="hljs-number">0xFFFF0000</span>) &gt;&gt; <span class="hljs-number">16</span>;<br>&#125;<br><br><br><span class="hljs-comment">/*初始化中断描述符表*/</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">idt_desc_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> <br>&#123;<br>   <span class="hljs-type">int</span> i, lastindex = IDT_DESC_CNT - <span class="hljs-number">1</span>;<br>   <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; IDT_DESC_CNT; i++) <br>   &#123;<br>      make_idt_desc(&amp;idt[i], IDT_DESC_ATTR_DPL0, intr_entry_table[i]); <br>   &#125;<br><span class="hljs-comment">/* 单独处理系统调用,系统调用对应的中断门dpl为3,</span><br><span class="hljs-comment"> * 中断处理程序为单独的syscall_handler */</span><br>   make_idt_desc(&amp;idt[lastindex], IDT_DESC_ATTR_DPL3, syscall_handler);<br>   put_str(<span class="hljs-string">&quot;   idt_desc_init done\n&quot;</span>);<br>&#125;<br><br><br><span class="hljs-comment">/* 通用的中断处理函数,一般用在异常出现时的处理 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">general_intr_handler</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> vec_nr)</span> <br>&#123;<br>   <span class="hljs-keyword">if</span> (vec_nr == <span class="hljs-number">0x27</span> || vec_nr == <span class="hljs-number">0x2f</span>)     <span class="hljs-comment">// 0x2f是从片8259A上的最后一个irq引脚，保留</span><br>   &#123;<br>      <span class="hljs-keyword">return</span>;		<span class="hljs-comment">//IRQ7和IRQ15会产生伪中断(spurious interrupt),无须处理。</span><br>   &#125;<br>   put_str(<span class="hljs-string">&quot;int vector : 0x&quot;</span>);<br>   put_int(vec_nr);<br>   put_char(<span class="hljs-string">&#x27;\n&#x27;</span>);	<br>&#125;<br><br><br><span class="hljs-comment">/* 完成一般中断处理函数注册及异常名称注册 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">exception_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;			    <span class="hljs-comment">// 完成一般中断处理函数注册及异常名称注册</span><br>   <span class="hljs-type">int</span> i;<br>   <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; IDT_DESC_CNT; i++) <br>   &#123;<br><span class="hljs-comment">/* idt_table数组中的函数是在进入中断后根据中断向量号调用的,</span><br><span class="hljs-comment"> * 见kernel/kernel.S的call [idt_table + %1*4] */</span><br>      idt_table[i] = general_intr_handler;		    <span class="hljs-comment">// 默认为general_intr_handler。</span><br>							    <span class="hljs-comment">// 以后会由register_handler来注册具体处理函数。</span><br>      intr_name[i] = <span class="hljs-string">&quot;unknown&quot;</span>;				    <span class="hljs-comment">// 先统一赋值为unknown </span><br>   &#125;<br>   intr_name[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;#DE Divide Error&quot;</span>;<br>   intr_name[<span class="hljs-number">1</span>] = <span class="hljs-string">&quot;#DB Debug Exception&quot;</span>;<br>   intr_name[<span class="hljs-number">2</span>] = <span class="hljs-string">&quot;NMI Interrupt&quot;</span>;<br>   intr_name[<span class="hljs-number">3</span>] = <span class="hljs-string">&quot;#BP Breakpoint Exception&quot;</span>;<br>   intr_name[<span class="hljs-number">4</span>] = <span class="hljs-string">&quot;#OF Overflow Exception&quot;</span>;<br>   intr_name[<span class="hljs-number">5</span>] = <span class="hljs-string">&quot;#BR BOUND Range Exceeded Exception&quot;</span>;<br>   intr_name[<span class="hljs-number">6</span>] = <span class="hljs-string">&quot;#UD Invalid Opcode Exception&quot;</span>;<br>   intr_name[<span class="hljs-number">7</span>] = <span class="hljs-string">&quot;#NM Device Not Available Exception&quot;</span>;<br>   intr_name[<span class="hljs-number">8</span>] = <span class="hljs-string">&quot;#DF Double Fault Exception&quot;</span>;<br>   intr_name[<span class="hljs-number">9</span>] = <span class="hljs-string">&quot;Coprocessor Segment Overrun&quot;</span>;<br>   intr_name[<span class="hljs-number">10</span>] = <span class="hljs-string">&quot;#TS Invalid TSS Exception&quot;</span>;<br>   intr_name[<span class="hljs-number">11</span>] = <span class="hljs-string">&quot;#NP Segment Not Present&quot;</span>;<br>   intr_name[<span class="hljs-number">12</span>] = <span class="hljs-string">&quot;#SS Stack Fault Exception&quot;</span>;<br>   intr_name[<span class="hljs-number">13</span>] = <span class="hljs-string">&quot;#GP General Protection Exception&quot;</span>;<br>   intr_name[<span class="hljs-number">14</span>] = <span class="hljs-string">&quot;#PF Page-Fault Exception&quot;</span>;<br>   <span class="hljs-comment">// intr_name[15] 第15项是intel保留项，未使用</span><br>   intr_name[<span class="hljs-number">16</span>] = <span class="hljs-string">&quot;#MF x87 FPU Floating-Point Error&quot;</span>;<br>   intr_name[<span class="hljs-number">17</span>] = <span class="hljs-string">&quot;#AC Alignment Check Exception&quot;</span>;<br>   intr_name[<span class="hljs-number">18</span>] = <span class="hljs-string">&quot;#MC Machine-Check Exception&quot;</span>;<br>   intr_name[<span class="hljs-number">19</span>] = <span class="hljs-string">&quot;#XF SIMD Floating-Point Exception&quot;</span>;<br><br>&#125;<br><br><br><span class="hljs-comment">/*完成有关中断的所有初始化工作*/</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">idt_init</span><span class="hljs-params">()</span> <br>&#123;<br>   put_str(<span class="hljs-string">&quot;idt_init start\n&quot;</span>);<br>   idt_desc_init();	   <span class="hljs-comment">// 初始化中断描述符表</span><br>   exception_init();	   <span class="hljs-comment">// 异常名初始化并注册通常的中断处理函数</span><br>   pic_init();		   <span class="hljs-comment">// 初始化8259A</span><br><br>   <span class="hljs-comment">/* 加载idt */</span><br>   <span class="hljs-type">uint64_t</span> idt_operand = ((<span class="hljs-keyword">sizeof</span>(idt) - <span class="hljs-number">1</span>) | ((<span class="hljs-type">uint64_t</span>)(<span class="hljs-type">uint32_t</span>)idt &lt;&lt; <span class="hljs-number">16</span>));<br>   <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span><span class="hljs-params">(<span class="hljs-string">&quot;lidt %0&quot;</span> : : <span class="hljs-string">&quot;m&quot;</span> (idt_operand))</span>;<br>   put_str(<span class="hljs-string">&quot;idt_init done\n&quot;</span>);<br>&#125;<br><br><br><span class="hljs-comment">/* 开中断并返回开中断前的状态*/</span><br><span class="hljs-keyword">enum</span> intr_status <span class="hljs-title function_">intr_enable</span><span class="hljs-params">()</span> <br>&#123;<br>   <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">intr_status</span> <span class="hljs-title">old_status</span>;</span><br>   <span class="hljs-keyword">if</span> (INTR_ON == intr_get_status()) <br>   &#123;<br>      old_status = INTR_ON;<br>      <span class="hljs-keyword">return</span> old_status;<br>   &#125; <br>   <span class="hljs-keyword">else</span> <br>   &#123;<br>      old_status = INTR_OFF;<br>      <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span><span class="hljs-params">(<span class="hljs-string">&quot;sti&quot;</span>)</span>;	 <span class="hljs-comment">// 开中断,sti指令将IF位置1</span><br>      <span class="hljs-keyword">return</span> old_status;<br>   &#125;<br>&#125;<br><br><br><span class="hljs-comment">/* 关中断,并且返回关中断前的状态 */</span><br><span class="hljs-keyword">enum</span> intr_status <span class="hljs-title function_">intr_disable</span><span class="hljs-params">()</span> <br>&#123;     <br>   <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">intr_status</span> <span class="hljs-title">old_status</span>;</span><br>   <span class="hljs-keyword">if</span> (INTR_ON == intr_get_status()) <br>   &#123;<br>      old_status = INTR_ON;<br>      <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span><span class="hljs-params">(<span class="hljs-string">&quot;cli&quot;</span> : : : <span class="hljs-string">&quot;memory&quot;</span>)</span>; <span class="hljs-comment">// 关中断,cli指令将IF位置0</span><br>      <span class="hljs-keyword">return</span> old_status;<br>   &#125; <br>   <span class="hljs-keyword">else</span> <br>   &#123;<br>      old_status = INTR_OFF;<br>      <span class="hljs-keyword">return</span> old_status;<br>   &#125;<br>&#125;<br><br><br><span class="hljs-comment">/* 将中断状态设置为status */</span><br><span class="hljs-keyword">enum</span> intr_status <span class="hljs-title function_">intr_set_status</span><span class="hljs-params">(<span class="hljs-keyword">enum</span> intr_status status)</span> <br>&#123;<br>   <span class="hljs-keyword">return</span> status &amp; INTR_ON ? intr_enable() : intr_disable();<br>&#125;<br><br><br><span class="hljs-comment">/* 获取当前中断状态 */</span><br><span class="hljs-keyword">enum</span> intr_status <span class="hljs-title function_">intr_get_status</span><span class="hljs-params">()</span> <br>&#123;<br>   <span class="hljs-type">uint32_t</span> eflags = <span class="hljs-number">0</span>; <br>   GET_EFLAGS(eflags);<br>   <span class="hljs-keyword">return</span> (EFLAGS_IF &amp; eflags) ? INTR_ON : INTR_OFF;<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">register_handler</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> vector_no, intr_handler function)</span>;<br><br><br><span class="hljs-comment">/* 在中断处理程序数组第vector_no个元素中注册安装中断处理程序function */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">register_handler</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> vector_no, intr_handler function)</span> <br>&#123;<br><span class="hljs-comment">/* idt_table数组中的函数是在进入中断后根据中断向量号调用的,</span><br><span class="hljs-comment"> * 见kernel/kernel.S的call [idt_table + %1*4] */</span><br>   idt_table[vector_no] = function; <br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="libkernelstdio-kernelh创建"><a class="markdownIt-Anchor" href="#libkernelstdio-kernelh创建"></a> lib/kernel/stdio-kernel.h创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __LIB_KERNEL_STDIOSYS_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LIB_KERNEL_STDIOSYS_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><span class="hljs-type">void</span> <span class="hljs-title function_">printk</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* format, ...)</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
<h3 id="libkernelstdio-kernelc创建"><a class="markdownIt-Anchor" href="#libkernelstdio-kernelc创建"></a> lib/kernel/stdio-kernel.c创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdio-kernel.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../stdio.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../device/console.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../kernel/global.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> va_start(args, first_fix) args = (va_list)&amp;first_fix</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> va_end(args) args = NULL</span><br><br><span class="hljs-comment">/* 供内核使用的格式化输出函数 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">printk</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* format, ...)</span> &#123;<br>   va_list args;<br>   va_start(args, format);<br>   <span class="hljs-type">char</span> buf[<span class="hljs-number">1024</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>   <span class="hljs-built_in">vsprintf</span>(buf, format, args);<br>   va_end(args);<br>   console_put_str(buf);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="deviceideh创建"><a class="markdownIt-Anchor" href="#deviceideh创建"></a> device/ide.h创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __DEVICE_IDE_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __DEVICE_IDE_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;bitmap.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;list.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../thread/sync.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;list.h&quot;</span></span><br><br><span class="hljs-comment">/* 分区结构 */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">partition</span> &#123;</span><br>   <span class="hljs-type">uint32_t</span> start_lba;		 <span class="hljs-comment">// 起始扇区</span><br>   <span class="hljs-type">uint32_t</span> sec_cnt;		 <span class="hljs-comment">// 扇区数</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">disk</span>* <span class="hljs-title">my_disk</span>;</span>	 <span class="hljs-comment">// 分区所属的硬盘</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_elem</span> <span class="hljs-title">part_tag</span>;</span>	 <span class="hljs-comment">// 用于队列中的标记</span><br>   <span class="hljs-type">char</span> name[<span class="hljs-number">8</span>];		 <span class="hljs-comment">// 分区名称</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">super_block</span>* <span class="hljs-title">sb</span>;</span>	 <span class="hljs-comment">// 本分区的超级块</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bitmap</span> <span class="hljs-title">block_bitmap</span>;</span>	 <span class="hljs-comment">// 块位图</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bitmap</span> <span class="hljs-title">inode_bitmap</span>;</span>	 <span class="hljs-comment">// i结点位图</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list</span> <span class="hljs-title">open_inodes</span>;</span>	 <span class="hljs-comment">// 本分区打开的i结点队列</span><br>&#125;;<br><br><span class="hljs-comment">/* 硬盘结构 */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">disk</span> &#123;</span><br>   <span class="hljs-type">char</span> name[<span class="hljs-number">8</span>];			   <span class="hljs-comment">// 本硬盘的名称，如sda等</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ide_channel</span>* <span class="hljs-title">my_channel</span>;</span>	   <span class="hljs-comment">// 此块硬盘归属于哪个ide通道</span><br>   <span class="hljs-type">uint8_t</span> dev_no;			   <span class="hljs-comment">// 本硬盘是主0还是从1</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">partition</span> <span class="hljs-title">prim_parts</span>[4];</span>	   <span class="hljs-comment">// 主分区顶多是4个</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">partition</span> <span class="hljs-title">logic_parts</span>[8];</span>	   <span class="hljs-comment">// 逻辑分区数量无限,但总得有个支持的上限,那就支持8个</span><br>&#125;;<br><br><span class="hljs-comment">/* ata通道结构 */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ide_channel</span> &#123;</span><br>   <span class="hljs-type">char</span> name[<span class="hljs-number">8</span>];		 <span class="hljs-comment">// 本ata通道名称, 如ata0,也被叫做ide0. 可以参考bochs配置文件中关于硬盘的配置。</span><br>   <span class="hljs-type">uint16_t</span> port_base;		 <span class="hljs-comment">// 本通道的起始端口号</span><br>   <span class="hljs-type">uint8_t</span> irq_no;		 <span class="hljs-comment">// 本通道所用的中断号</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">lock</span> <span class="hljs-title">lock</span>;</span><br>   <span class="hljs-type">bool</span> expecting_intr;		 <span class="hljs-comment">// 向硬盘发完命令后等待来自硬盘的中断</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">semaphore</span> <span class="hljs-title">disk_done</span>;</span>	 <span class="hljs-comment">// 硬盘处理完成.线程用这个信号量来阻塞自己，由硬盘完成后产生的中断将线程唤醒</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">disk</span> <span class="hljs-title">devices</span>[2];</span>	 <span class="hljs-comment">// 一个通道上连接两个硬盘，一主一从</span><br>&#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">intr_hd_handler</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> irq_no)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">ide_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-keyword">extern</span> <span class="hljs-type">uint8_t</span> channel_cnt;<br><span class="hljs-keyword">extern</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ide_channel</span> <span class="hljs-title">channels</span>[];</span><br><span class="hljs-keyword">extern</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list</span> <span class="hljs-title">partition_list</span>;</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">ide_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> disk* hd, <span class="hljs-type">uint32_t</span> lba, <span class="hljs-type">void</span>* buf, <span class="hljs-type">uint32_t</span> sec_cnt)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">ide_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> disk* hd, <span class="hljs-type">uint32_t</span> lba, <span class="hljs-type">void</span>* buf, <span class="hljs-type">uint32_t</span> sec_cnt)</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
<h3 id="deviceidec创建"><a class="markdownIt-Anchor" href="#deviceidec创建"></a> device/ide.c创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;ide.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;debug.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdio-kernel.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdio.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;global.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../thread/sync.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;io.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;timer.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;interrupt.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;memory.h&quot;</span></span><br><br><br><span class="hljs-comment">/* 定义硬盘各寄存器的端口号 */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> reg_data(channel)	 (channel-&gt;port_base + 0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> reg_error(channel)	 (channel-&gt;port_base + 1)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> reg_sect_cnt(channel)	 (channel-&gt;port_base + 2)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> reg_lba_l(channel)	 (channel-&gt;port_base + 3)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> reg_lba_m(channel)	 (channel-&gt;port_base + 4)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> reg_lba_h(channel)	 (channel-&gt;port_base + 5)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> reg_dev(channel)	 (channel-&gt;port_base + 6)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> reg_status(channel)	 (channel-&gt;port_base + 7)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> reg_cmd(channel)	 (reg_status(channel))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> reg_alt_status(channel)  (channel-&gt;port_base + 0x206)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> reg_ctl(channel)	 reg_alt_status(channel)</span><br><br><span class="hljs-comment">/* reg_status寄存器的一些关键位 */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BIT_STAT_BSY	 0x80	      <span class="hljs-comment">// 硬盘忙</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BIT_STAT_DRDY	 0x40	      <span class="hljs-comment">// 驱动器准备好	 </span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BIT_STAT_DRQ	 0x8	      <span class="hljs-comment">// 数据传输准备好了</span></span><br><br><span class="hljs-comment">/* device寄存器的一些关键位 */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BIT_DEV_MBS	0xa0	    <span class="hljs-comment">// 第7位和第5位固定为1</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BIT_DEV_LBA	0x40</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BIT_DEV_DEV	0x10</span><br><br><span class="hljs-comment">/* 一些硬盘操作的指令 */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CMD_IDENTIFY	   0xec	    <span class="hljs-comment">// identify指令</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CMD_READ_SECTOR	   0x20     <span class="hljs-comment">// 读扇区指令</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CMD_WRITE_SECTOR   0x30	    <span class="hljs-comment">// 写扇区指令</span></span><br><br><span class="hljs-comment">/* 定义可读写的最大扇区数,调试用的 */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> max_lba ((80*1024*1024/512) - 1)	<span class="hljs-comment">// 只支持80MB硬盘</span></span><br><br><br><span class="hljs-type">uint8_t</span> channel_cnt;	   <span class="hljs-comment">// 按硬盘数计算的通道数</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ide_channel</span> <span class="hljs-title">channels</span>[2];</span>	 <span class="hljs-comment">// 有两个ide通道</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list</span> <span class="hljs-title">partition_list</span>;</span>	 <span class="hljs-comment">// 分区队列</span><br><span class="hljs-comment">/* 用于记录总扩展分区的起始lba,初始为0,partition_scan时以此为标记 */</span><br><span class="hljs-type">int32_t</span> ext_lba_base = <span class="hljs-number">0</span>;<br><span class="hljs-type">uint8_t</span> p_no = <span class="hljs-number">0</span>, l_no = <span class="hljs-number">0</span>;	 <span class="hljs-comment">// 用来记录硬盘主分区和逻辑分区的下标</span><br><br><br><span class="hljs-comment">/* 构建一个16字节大小的结构体,用来存分区表项 */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">partition_table_entry</span> &#123;</span><br>   <span class="hljs-type">uint8_t</span>  bootable;		 <span class="hljs-comment">// 是否可引导	</span><br>   <span class="hljs-type">uint8_t</span>  start_head;		 <span class="hljs-comment">// 起始磁头号</span><br>   <span class="hljs-type">uint8_t</span>  start_sec;		 <span class="hljs-comment">// 起始扇区号</span><br>   <span class="hljs-type">uint8_t</span>  start_chs;		 <span class="hljs-comment">// 起始柱面号</span><br>   <span class="hljs-type">uint8_t</span>  fs_type;		 <span class="hljs-comment">// 分区类型</span><br>   <span class="hljs-type">uint8_t</span>  end_head;		 <span class="hljs-comment">// 结束磁头号</span><br>   <span class="hljs-type">uint8_t</span>  end_sec;		 <span class="hljs-comment">// 结束扇区号</span><br>   <span class="hljs-type">uint8_t</span>  end_chs;		 <span class="hljs-comment">// 结束柱面号</span><br><span class="hljs-comment">/* 更需要关注的是下面这两项 */</span><br>   <span class="hljs-type">uint32_t</span> start_lba;		 <span class="hljs-comment">// 本分区起始扇区的lba地址</span><br>   <span class="hljs-type">uint32_t</span> sec_cnt;		 <span class="hljs-comment">// 本分区的扇区数目</span><br>&#125; __attribute__ ((packed));	 <span class="hljs-comment">// 保证此结构是16字节大小</span><br><br><span class="hljs-comment">/* 引导扇区,mbr或ebr所在的扇区 */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">boot_sector</span> &#123;</span><br>   <span class="hljs-type">uint8_t</span>  other[<span class="hljs-number">446</span>];		 <span class="hljs-comment">// 引导代码</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span>   <span class="hljs-title">partition_table_entry</span> <span class="hljs-title">partition_table</span>[4];</span>       <span class="hljs-comment">// 分区表中有4项,共64字节</span><br>   <span class="hljs-type">uint16_t</span> signature;		 <span class="hljs-comment">// 启动扇区的结束标志是0x55,0xaa,</span><br>&#125; __attribute__ ((packed));<br><br><span class="hljs-comment">/* 选择读写的硬盘 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">select_disk</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> disk* hd)</span> &#123;<br>   <span class="hljs-type">uint8_t</span> reg_device = BIT_DEV_MBS | BIT_DEV_LBA;<br>   <span class="hljs-keyword">if</span> (hd-&gt;dev_no == <span class="hljs-number">1</span>) &#123;	<span class="hljs-comment">// 若是从盘就置DEV位为1</span><br>      reg_device |= BIT_DEV_DEV;<br>   &#125;<br>   outb(reg_dev(hd-&gt;my_channel), reg_device);<br>&#125;<br><br><span class="hljs-comment">/* 向硬盘控制器写入起始扇区地址及要读写的扇区数 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">select_sector</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> disk* hd, <span class="hljs-type">uint32_t</span> lba, <span class="hljs-type">uint8_t</span> sec_cnt)</span> &#123;<br>   ASSERT(lba &lt;= max_lba);<br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ide_channel</span>* <span class="hljs-title">channel</span> =</span> hd-&gt;my_channel;<br><br>   <span class="hljs-comment">/* 写入要读写的扇区数*/</span><br>   outb(reg_sect_cnt(channel), sec_cnt);	 <span class="hljs-comment">// 如果sec_cnt为0,则表示写入256个扇区</span><br><br>   <span class="hljs-comment">/* 写入lba地址(即扇区号) */</span><br>   outb(reg_lba_l(channel), lba);		 <span class="hljs-comment">// lba地址的低8位,不用单独取出低8位.outb函数中的汇编指令outb %b0, %w1会只用al。</span><br>   outb(reg_lba_m(channel), lba &gt;&gt; <span class="hljs-number">8</span>);		 <span class="hljs-comment">// lba地址的8~15位</span><br>   outb(reg_lba_h(channel), lba &gt;&gt; <span class="hljs-number">16</span>);		 <span class="hljs-comment">// lba地址的16~23位</span><br><br>   <span class="hljs-comment">/* 因为lba地址的24~27位要存储在device寄存器的0～3位,</span><br><span class="hljs-comment">    * 无法单独写入这4位,所以在此处把device寄存器再重新写入一次*/</span><br>   outb(reg_dev(channel), BIT_DEV_MBS | BIT_DEV_LBA | (hd-&gt;dev_no == <span class="hljs-number">1</span> ? BIT_DEV_DEV : <span class="hljs-number">0</span>) | lba &gt;&gt; <span class="hljs-number">24</span>);<br>&#125;<br><br><span class="hljs-comment">/* 向通道channel发命令cmd */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">cmd_out</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> ide_channel* channel, <span class="hljs-type">uint8_t</span> cmd)</span> &#123;<br><span class="hljs-comment">/* 只要向硬盘发出了命令便将此标记置为true,硬盘中断处理程序需要根据它来判断 */</span><br>   channel-&gt;expecting_intr = <span class="hljs-literal">true</span>;<br>   outb(reg_cmd(channel), cmd);<br>&#125;<br><br><span class="hljs-comment">/* 硬盘读入sec_cnt个扇区的数据到buf */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">read_from_sector</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> disk* hd, <span class="hljs-type">void</span>* buf, <span class="hljs-type">uint8_t</span> sec_cnt)</span> &#123;<br>   <span class="hljs-type">uint32_t</span> size_in_byte;<br>   <span class="hljs-keyword">if</span> (sec_cnt == <span class="hljs-number">0</span>) &#123;<br>   <span class="hljs-comment">/* 因为sec_cnt是8位变量,由主调函数将其赋值时,若为256则会将最高位的1丢掉变为0 */</span><br>      size_in_byte = <span class="hljs-number">256</span> * <span class="hljs-number">512</span>;<br>   &#125; <span class="hljs-keyword">else</span> &#123; <br>      size_in_byte = sec_cnt * <span class="hljs-number">512</span>; <br>   &#125;<br>   insw(reg_data(hd-&gt;my_channel), buf, size_in_byte / <span class="hljs-number">2</span>);<br>&#125;<br><br><span class="hljs-comment">/* 将buf中sec_cnt扇区的数据写入硬盘 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">write2sector</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> disk* hd, <span class="hljs-type">void</span>* buf, <span class="hljs-type">uint8_t</span> sec_cnt)</span> &#123;<br>   <span class="hljs-type">uint32_t</span> size_in_byte;<br>   <span class="hljs-keyword">if</span> (sec_cnt == <span class="hljs-number">0</span>) &#123;<br>   <span class="hljs-comment">/* 因为sec_cnt是8位变量,由主调函数将其赋值时,若为256则会将最高位的1丢掉变为0 */</span><br>      size_in_byte = <span class="hljs-number">256</span> * <span class="hljs-number">512</span>;<br>   &#125; <span class="hljs-keyword">else</span> &#123; <br>      size_in_byte = sec_cnt * <span class="hljs-number">512</span>; <br>   &#125;<br>   outsw(reg_data(hd-&gt;my_channel), buf, size_in_byte / <span class="hljs-number">2</span>);<br>&#125;<br><br><span class="hljs-comment">/* 等待30秒 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">busy_wait</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> disk* hd)</span> &#123;<br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ide_channel</span>* <span class="hljs-title">channel</span> =</span> hd-&gt;my_channel;<br>   <span class="hljs-type">uint16_t</span> time_limit = <span class="hljs-number">30</span> * <span class="hljs-number">1000</span>;	     <span class="hljs-comment">// 可以等待30000毫秒</span><br>   <span class="hljs-keyword">while</span> (time_limit -= <span class="hljs-number">10</span> &gt;= <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">if</span> (!(inb(reg_status(channel)) &amp; BIT_STAT_BSY)) &#123;<br>	 <span class="hljs-keyword">return</span> (inb(reg_status(channel)) &amp; BIT_STAT_DRQ);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>	 mtime_sleep(<span class="hljs-number">10</span>);		     <span class="hljs-comment">// 睡眠10毫秒</span><br>      &#125;<br>   &#125;<br>   <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-comment">/* 从硬盘读取sec_cnt个扇区到buf */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">ide_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> disk* hd, <span class="hljs-type">uint32_t</span> lba, <span class="hljs-type">void</span>* buf, <span class="hljs-type">uint32_t</span> sec_cnt)</span> &#123;   <span class="hljs-comment">// 此处的sec_cnt为32位大小</span><br>   ASSERT(lba &lt;= max_lba);<br>   ASSERT(sec_cnt &gt; <span class="hljs-number">0</span>);<br>   lock_acquire (&amp;hd-&gt;my_channel-&gt;lock);<br><br><span class="hljs-comment">/* 1 先选择操作的硬盘 */</span><br>   select_disk(hd);<br><br>   <span class="hljs-type">uint32_t</span> secs_op;		 <span class="hljs-comment">// 每次操作的扇区数</span><br>   <span class="hljs-type">uint32_t</span> secs_done = <span class="hljs-number">0</span>;	 <span class="hljs-comment">// 已完成的扇区数</span><br>   <span class="hljs-keyword">while</span>(secs_done &lt; sec_cnt) &#123;<br>      <span class="hljs-keyword">if</span> ((secs_done + <span class="hljs-number">256</span>) &lt;= sec_cnt) &#123;<br>	 secs_op = <span class="hljs-number">256</span>;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>	 secs_op = sec_cnt - secs_done;<br>      &#125;<br><br>   <span class="hljs-comment">/* 2 写入待读入的扇区数和起始扇区号 */</span><br>      select_sector(hd, lba + secs_done, secs_op);<br><br>   <span class="hljs-comment">/* 3 执行的命令写入reg_cmd寄存器 */</span><br>      cmd_out(hd-&gt;my_channel, CMD_READ_SECTOR);	      <span class="hljs-comment">// 准备开始读数据</span><br><br>   <span class="hljs-comment">/*********************   阻塞自己的时机  ***********************</span><br><span class="hljs-comment">      在硬盘已经开始工作(开始在内部读数据或写数据)后才能阻塞自己,现在硬盘已经开始忙了,</span><br><span class="hljs-comment">      将自己阻塞,等待硬盘完成读操作后通过中断处理程序唤醒自己*/</span><br>      sema_down(&amp;hd-&gt;my_channel-&gt;disk_done);<br>   <span class="hljs-comment">/*************************************************************/</span><br><br>   <span class="hljs-comment">/* 4 检测硬盘状态是否可读 */</span><br>      <span class="hljs-comment">/* 醒来后开始执行下面代码*/</span><br>      <span class="hljs-keyword">if</span> (!busy_wait(hd)) &#123;			      <span class="hljs-comment">// 若失败</span><br>	 <span class="hljs-type">char</span> error[<span class="hljs-number">64</span>];<br>	 <span class="hljs-built_in">sprintf</span>(error, <span class="hljs-string">&quot;%s read sector %d failed!!!!!!\n&quot;</span>, hd-&gt;name, lba);<br>	 PANIC(error);<br>      &#125;<br><br>   <span class="hljs-comment">/* 5 把数据从硬盘的缓冲区中读出 */</span><br>      read_from_sector(hd, (<span class="hljs-type">void</span>*)((<span class="hljs-type">uint32_t</span>)buf + secs_done * <span class="hljs-number">512</span>), secs_op);<br>      secs_done += secs_op;<br>   &#125;<br>   lock_release(&amp;hd-&gt;my_channel-&gt;lock);<br>&#125;<br><br><span class="hljs-comment">/* 将buf中sec_cnt扇区数据写入硬盘 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">ide_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> disk* hd, <span class="hljs-type">uint32_t</span> lba, <span class="hljs-type">void</span>* buf, <span class="hljs-type">uint32_t</span> sec_cnt)</span> &#123;<br>   ASSERT(lba &lt;= max_lba);<br>   ASSERT(sec_cnt &gt; <span class="hljs-number">0</span>);<br>   lock_acquire (&amp;hd-&gt;my_channel-&gt;lock);<br><br><span class="hljs-comment">/* 1 先选择操作的硬盘 */</span><br>   select_disk(hd);<br><br>   <span class="hljs-type">uint32_t</span> secs_op;		 <span class="hljs-comment">// 每次操作的扇区数</span><br>   <span class="hljs-type">uint32_t</span> secs_done = <span class="hljs-number">0</span>;	 <span class="hljs-comment">// 已完成的扇区数</span><br>   <span class="hljs-keyword">while</span>(secs_done &lt; sec_cnt) &#123;<br>      <span class="hljs-keyword">if</span> ((secs_done + <span class="hljs-number">256</span>) &lt;= sec_cnt) &#123;<br>	 secs_op = <span class="hljs-number">256</span>;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>	 secs_op = sec_cnt - secs_done;<br>      &#125;<br><br>   <span class="hljs-comment">/* 2 写入待写入的扇区数和起始扇区号 */</span><br>      select_sector(hd, lba + secs_done, secs_op);		      <span class="hljs-comment">// 先将待读的块号lba地址和待读入的扇区数写入lba寄存器</span><br><br>   <span class="hljs-comment">/* 3 执行的命令写入reg_cmd寄存器 */</span><br>      cmd_out(hd-&gt;my_channel, CMD_WRITE_SECTOR);	      <span class="hljs-comment">// 准备开始写数据</span><br><br>   <span class="hljs-comment">/* 4 检测硬盘状态是否可读 */</span><br>      <span class="hljs-keyword">if</span> (!busy_wait(hd)) &#123;			      <span class="hljs-comment">// 若失败</span><br>	 <span class="hljs-type">char</span> error[<span class="hljs-number">64</span>];<br>	 <span class="hljs-built_in">sprintf</span>(error, <span class="hljs-string">&quot;%s write sector %d failed!!!!!!\n&quot;</span>, hd-&gt;name, lba);<br>	 PANIC(error);<br>      &#125;<br><br>   <span class="hljs-comment">/* 5 将数据写入硬盘 */</span><br>      write2sector(hd, (<span class="hljs-type">void</span>*)((<span class="hljs-type">uint32_t</span>)buf + secs_done * <span class="hljs-number">512</span>), secs_op);<br><br>      <span class="hljs-comment">/* 在硬盘响应期间阻塞自己 */</span><br>      sema_down(&amp;hd-&gt;my_channel-&gt;disk_done);<br>      secs_done += secs_op;<br>   &#125;<br>   <span class="hljs-comment">/* 醒来后开始释放锁*/</span><br>   lock_release(&amp;hd-&gt;my_channel-&gt;lock);<br>&#125;<br><br><span class="hljs-comment">/* 硬盘中断处理程序 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">intr_hd_handler</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> irq_no)</span> &#123;<br>   ASSERT(irq_no == <span class="hljs-number">0x2e</span> || irq_no == <span class="hljs-number">0x2f</span>);<br>   <span class="hljs-type">uint8_t</span> ch_no = irq_no - <span class="hljs-number">0x2e</span>;<br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ide_channel</span>* <span class="hljs-title">channel</span> =</span> &amp;channels[ch_no];<br>   ASSERT(channel-&gt;irq_no == irq_no);<br><span class="hljs-comment">/* 不必担心此中断是否对应的是这一次的expecting_intr,</span><br><span class="hljs-comment"> * 每次读写硬盘时会申请锁,从而保证了同步一致性 */</span><br>   <span class="hljs-keyword">if</span> (channel-&gt;expecting_intr) &#123;<br>      channel-&gt;expecting_intr = <span class="hljs-literal">false</span>;<br>      sema_up(&amp;channel-&gt;disk_done);<br><br><span class="hljs-comment">/* 读取状态寄存器使硬盘控制器认为此次的中断已被处理,</span><br><span class="hljs-comment"> * 从而硬盘可以继续执行新的读写 */</span><br>      inb(reg_status(channel));<br>   &#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">swap_pairs_bytes</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* dst, <span class="hljs-type">char</span>* buf, <span class="hljs-type">uint32_t</span> len)</span> &#123;<br>   <span class="hljs-type">uint8_t</span> idx;<br>   <span class="hljs-keyword">for</span> (idx = <span class="hljs-number">0</span>; idx &lt; len; idx += <span class="hljs-number">2</span>) &#123;<br>      <span class="hljs-comment">/* buf中存储dst中两相邻元素交换位置后的字符串*/</span><br>      buf[idx + <span class="hljs-number">1</span>] = *dst++;   <br>      buf[idx]     = *dst++;   <br>   &#125;<br>   buf[idx] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>&#125;<br><br><span class="hljs-comment">/* 获得硬盘参数信息 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">identify_disk</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> disk* hd)</span> &#123;<br>   <span class="hljs-type">char</span> id_info[<span class="hljs-number">512</span>];<br>   select_disk(hd);<br>   cmd_out(hd-&gt;my_channel, CMD_IDENTIFY);<br><span class="hljs-comment">/* 向硬盘发送指令后便通过信号量阻塞自己,</span><br><span class="hljs-comment"> * 待硬盘处理完成后,通过中断处理程序将自己唤醒 */</span><br>   sema_down(&amp;hd-&gt;my_channel-&gt;disk_done);<br><br><span class="hljs-comment">/* 醒来后开始执行下面代码*/</span><br>   <span class="hljs-keyword">if</span> (!busy_wait(hd)) &#123;     <span class="hljs-comment">//  若失败</span><br>      <span class="hljs-type">char</span> error[<span class="hljs-number">64</span>];<br>      <span class="hljs-built_in">sprintf</span>(error, <span class="hljs-string">&quot;%s identify failed!!!!!!\n&quot;</span>, hd-&gt;name);<br>      PANIC(error);<br>   &#125;<br>   read_from_sector(hd, id_info, <span class="hljs-number">1</span>);<br><br>   <span class="hljs-type">char</span> buf[<span class="hljs-number">64</span>];<br>   <span class="hljs-type">uint8_t</span> sn_start = <span class="hljs-number">10</span> * <span class="hljs-number">2</span>, sn_len = <span class="hljs-number">20</span>, md_start = <span class="hljs-number">27</span> * <span class="hljs-number">2</span>, md_len = <span class="hljs-number">40</span>;<br>   swap_pairs_bytes(&amp;id_info[sn_start], buf, sn_len);<br>   printk(<span class="hljs-string">&quot;   disk %s info:\n      SN: %s\n&quot;</span>, hd-&gt;name, buf);<br>   <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>   swap_pairs_bytes(&amp;id_info[md_start], buf, md_len);<br>   printk(<span class="hljs-string">&quot;      MODULE: %s\n&quot;</span>, buf);<br>   <span class="hljs-type">uint32_t</span> sectors = *(<span class="hljs-type">uint32_t</span>*)&amp;id_info[<span class="hljs-number">60</span> * <span class="hljs-number">2</span>];<br>   printk(<span class="hljs-string">&quot;      SECTORS: %d\n&quot;</span>, sectors);<br>   printk(<span class="hljs-string">&quot;      CAPACITY: %dMB\n&quot;</span>, sectors * <span class="hljs-number">512</span> / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">partition_scan</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> disk* hd, <span class="hljs-type">uint32_t</span> ext_lba)</span> &#123;<br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">boot_sector</span>* <span class="hljs-title">bs</span> =</span> sys_malloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> boot_sector));<br>   ide_read(hd, ext_lba, bs, <span class="hljs-number">1</span>);<br>   <span class="hljs-type">uint8_t</span> part_idx = <span class="hljs-number">0</span>;<br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">partition_table_entry</span>* <span class="hljs-title">p</span> =</span> bs-&gt;partition_table;<br><br>   <span class="hljs-comment">/* 遍历分区表4个分区表项 */</span><br>   <span class="hljs-keyword">while</span> (part_idx++ &lt; <span class="hljs-number">4</span>) &#123;<br>      <span class="hljs-keyword">if</span> (p-&gt;fs_type == <span class="hljs-number">0x5</span>) &#123;	 <span class="hljs-comment">// 若为扩展分区</span><br>	 <span class="hljs-keyword">if</span> (ext_lba_base != <span class="hljs-number">0</span>) &#123; <br>	 <span class="hljs-comment">/* 子扩展分区的start_lba是相对于主引导扇区中的总扩展分区地址 */</span><br>	    partition_scan(hd, p-&gt;start_lba + ext_lba_base);<br>	 &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// ext_lba_base为0表示是第一次读取引导块,也就是主引导记录所在的扇区</span><br>	 <span class="hljs-comment">/* 记录下扩展分区的起始lba地址,后面所有的扩展分区地址都相对于此 */</span><br>	    ext_lba_base = p-&gt;start_lba;<br>	    partition_scan(hd, p-&gt;start_lba);<br>	 &#125;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (p-&gt;fs_type != <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">// 若是有效的分区类型</span><br>	 <span class="hljs-keyword">if</span> (ext_lba == <span class="hljs-number">0</span>) &#123;	 <span class="hljs-comment">// 此时全是主分区</span><br>	    hd-&gt;prim_parts[p_no].start_lba = ext_lba + p-&gt;start_lba;<br>	    hd-&gt;prim_parts[p_no].sec_cnt = p-&gt;sec_cnt;<br>	    hd-&gt;prim_parts[p_no].my_disk = hd;<br>	    list_append(&amp;partition_list, &amp;hd-&gt;prim_parts[p_no].part_tag);<br>	    <span class="hljs-built_in">sprintf</span>(hd-&gt;prim_parts[p_no].name, <span class="hljs-string">&quot;%s%d&quot;</span>, hd-&gt;name, p_no + <span class="hljs-number">1</span>);<br>	    p_no++;<br>	    ASSERT(p_no &lt; <span class="hljs-number">4</span>);	    <span class="hljs-comment">// 0,1,2,3</span><br>	 &#125; <span class="hljs-keyword">else</span> &#123;<br>	    hd-&gt;logic_parts[l_no].start_lba = ext_lba + p-&gt;start_lba;<br>	    hd-&gt;logic_parts[l_no].sec_cnt = p-&gt;sec_cnt;<br>	    hd-&gt;logic_parts[l_no].my_disk = hd;<br>	    list_append(&amp;partition_list, &amp;hd-&gt;logic_parts[l_no].part_tag);<br>	    <span class="hljs-built_in">sprintf</span>(hd-&gt;logic_parts[l_no].name, <span class="hljs-string">&quot;%s%d&quot;</span>, hd-&gt;name, l_no + <span class="hljs-number">5</span>);	 <span class="hljs-comment">// 逻辑分区数字是从5开始,主分区是1～4.</span><br>	    l_no++;<br>	    <span class="hljs-keyword">if</span> (l_no &gt;= <span class="hljs-number">8</span>)    <span class="hljs-comment">// 只支持8个逻辑分区,避免数组越界</span><br>	       <span class="hljs-keyword">return</span>;<br>	 &#125;<br>      &#125; <br>      p++;<br>   &#125;<br>   sys_free(bs);<br>&#125;<br><br><span class="hljs-comment">/* 打印分区信息 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">partition_info</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> list_elem* pelem, <span class="hljs-type">int</span> arg)</span> &#123;<br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">partition</span>* <span class="hljs-title">part</span> =</span> elem2entry(<span class="hljs-keyword">struct</span> partition, part_tag, pelem);<br>   printk(<span class="hljs-string">&quot;   %s start_lba:0x%x, sec_cnt:0x%x\n&quot;</span>,part-&gt;name, part-&gt;start_lba, part-&gt;sec_cnt);<br><br><span class="hljs-comment">/* 在此处return false与函数本身功能无关,</span><br><span class="hljs-comment"> * 只是为了让主调函数list_traversal继续向下遍历元素 */</span><br>   <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-comment">/* 硬盘数据结构初始化 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">ide_init</span><span class="hljs-params">()</span> <br>&#123;<br>    printk(<span class="hljs-string">&quot;ide_init start\n&quot;</span>);<br>    <span class="hljs-type">uint8_t</span> hd_cnt = *((<span class="hljs-type">uint8_t</span>*)(<span class="hljs-number">0x475</span>));	      <span class="hljs-comment">// 获取硬盘的数量</span><br>    ASSERT(hd_cnt &gt; <span class="hljs-number">0</span>);<br>    list_init(&amp;partition_list);<br>    channel_cnt = DIV_ROUND_UP(hd_cnt, <span class="hljs-number">2</span>);	   <span class="hljs-comment">// 一个ide通道上有两个硬盘,根据硬盘数量反推有几个ide通道</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ide_channel</span>* <span class="hljs-title">channel</span>;</span><br>    <span class="hljs-type">uint8_t</span> channel_no = <span class="hljs-number">0</span>, dev_no = <span class="hljs-number">0</span>; <br><br>    <span class="hljs-comment">/* 处理每个通道上的硬盘 */</span><br>    <span class="hljs-keyword">while</span> (channel_no &lt; channel_cnt) <br>    &#123;<br>        channel = &amp;channels[channel_no];<br>        <span class="hljs-built_in">sprintf</span>(channel-&gt;name, <span class="hljs-string">&quot;ide%d&quot;</span>, channel_no);<br><br>        <span class="hljs-comment">/* 为每个ide通道初始化端口基址及中断向量 */</span><br>        <span class="hljs-keyword">switch</span> (channel_no) <br>        &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>            channel-&gt;port_base	 = <span class="hljs-number">0x1f0</span>;	   <span class="hljs-comment">// ide0通道的起始端口号是0x1f0</span><br>            channel-&gt;irq_no	 = <span class="hljs-number">0x20</span> + <span class="hljs-number">14</span>;	   <span class="hljs-comment">// 从片8259a上倒数第二的中断引脚,温盘,也就是ide0通道的的中断向量号</span><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>            channel-&gt;port_base	 = <span class="hljs-number">0x170</span>;	   <span class="hljs-comment">// ide1通道的起始端口号是0x170</span><br>            channel-&gt;irq_no	 = <span class="hljs-number">0x20</span> + <span class="hljs-number">15</span>;	   <span class="hljs-comment">// 从8259A上的最后一个中断引脚,我们用来响应ide1通道上的硬盘中断</span><br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        channel-&gt;expecting_intr = <span class="hljs-literal">false</span>;		   <span class="hljs-comment">// 未向硬盘写入指令时不期待硬盘的中断</span><br>        lock_init(&amp;channel-&gt;lock);		     <br><br>        <span class="hljs-comment">/* 初始化为0,目的是向硬盘控制器请求数据后,硬盘驱动sema_down此信号量会阻塞线程,</span><br><span class="hljs-comment">        直到硬盘完成后通过发中断,由中断处理程序将此信号量sema_up,唤醒线程. */</span><br>        sema_init(&amp;channel-&gt;disk_done, <span class="hljs-number">0</span>);<br><br>        register_handler(channel-&gt;irq_no, intr_hd_handler);<br><br>        <span class="hljs-comment">/* 分别获取两个硬盘的参数及分区信息 */</span><br>        <span class="hljs-keyword">while</span> (dev_no &lt; <span class="hljs-number">2</span>) <br>        &#123;<br>            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">disk</span>* <span class="hljs-title">hd</span> =</span> &amp;channel-&gt;devices[dev_no];<br>            hd-&gt;my_channel = channel;<br>            hd-&gt;dev_no = dev_no;<br>            <span class="hljs-built_in">sprintf</span>(hd-&gt;name, <span class="hljs-string">&quot;sd%c&quot;</span>, <span class="hljs-string">&#x27;a&#x27;</span> + channel_no * <span class="hljs-number">2</span> + dev_no);<br>            identify_disk(hd);	 <span class="hljs-comment">// 获取硬盘参数</span><br>            <span class="hljs-keyword">if</span> (dev_no != <span class="hljs-number">0</span>)        <span class="hljs-comment">// 内核本身的裸硬盘(hd60M.img)不处理</span><br>            &#123;	 <br>                partition_scan(hd, <span class="hljs-number">0</span>);  <span class="hljs-comment">// 扫描该硬盘上的分区  </span><br>            &#125;<br>            p_no = <span class="hljs-number">0</span>, l_no = <span class="hljs-number">0</span>;<br>            dev_no++; <br>        &#125;<br>        dev_no = <span class="hljs-number">0</span>;			  	   <span class="hljs-comment">// 将硬盘驱动器号置0,为下一个channel的两个硬盘初始化。</span><br>        channel_no++;				   <span class="hljs-comment">// 下一个channel</span><br>    &#125;<br><br>    printk(<span class="hljs-string">&quot;\n   all partition info\n&quot;</span>);<br>    <span class="hljs-comment">/* 打印所有分区信息 */</span><br>    list_traversal(&amp;partition_list, partition_info, (<span class="hljs-type">int</span>)<span class="hljs-literal">NULL</span>);<br>    printk(<span class="hljs-string">&quot;ide_init done\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="devicetimerh修改"><a class="markdownIt-Anchor" href="#devicetimerh修改"></a> device/timer.h修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __DEVICE_TIME_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __DEVICE_TIME_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">frequency_set</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> counter_port, \</span><br><span class="hljs-params">			  				<span class="hljs-type">uint8_t</span> counter_no, \</span><br><span class="hljs-params">			  				<span class="hljs-type">uint8_t</span> rwl, \</span><br><span class="hljs-params">							<span class="hljs-type">uint8_t</span> counter_mode, \</span><br><span class="hljs-params">							<span class="hljs-type">uint16_t</span> counter_value)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">timer_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">mtime_sleep</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> m_seconds)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">ticks_to_sleep</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> sleep_ticks)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">mtime_sleep</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> m_seconds)</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
<h3 id="devicetimerc修改"><a class="markdownIt-Anchor" href="#devicetimerc修改"></a> device/timer.c修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;timer.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;io.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;interrupt.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../thread/thread.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;debug.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IRQ0_FREQUENCY	   100</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INPUT_FREQUENCY	   1193180</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COUNTER0_VALUE	   INPUT_FREQUENCY / IRQ0_FREQUENCY</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CONTRER0_PORT	   0x40</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COUNTER0_NO	   0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COUNTER_MODE	   2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> READ_WRITE_LATCH   3</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIT_CONTROL_PORT   0x43</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> mil_seconds_per_intr (1000 / IRQ0_FREQUENCY)</span><br><br><br><span class="hljs-type">uint32_t</span> ticks;          <span class="hljs-comment">// ticks是内核自中断开启以来总共的嘀嗒数</span><br><br><span class="hljs-comment">/* 把操作的计数器counter_no、读写锁属性rwl、计数器模式counter_mode写入模式控制寄存器并赋予初始值counter_value */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">frequency_set</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> counter_port, \</span><br><span class="hljs-params">			  				<span class="hljs-type">uint8_t</span> counter_no, \</span><br><span class="hljs-params">			  				<span class="hljs-type">uint8_t</span> rwl, \</span><br><span class="hljs-params">							<span class="hljs-type">uint8_t</span> counter_mode, \</span><br><span class="hljs-params">							<span class="hljs-type">uint16_t</span> counter_value)</span> <br>&#123;<br>	<span class="hljs-comment">/* 往控制字寄存器端口0x43中写入控制字 */</span><br>	outb(PIT_CONTROL_PORT, (<span class="hljs-type">uint8_t</span>)(counter_no &lt;&lt; <span class="hljs-number">6</span> | rwl &lt;&lt; <span class="hljs-number">4</span> | counter_mode &lt;&lt; <span class="hljs-number">1</span>));<br>	<span class="hljs-comment">/* 先写入counter_value的低8位 */</span><br>	outb(counter_port, (<span class="hljs-type">uint8_t</span>)counter_value);<br>	<span class="hljs-comment">/* 再写入counter_value的高8位 */</span><br>	outb(counter_port, (<span class="hljs-type">uint8_t</span>)counter_value &gt;&gt; <span class="hljs-number">8</span>);<br>&#125;<br><br><br><span class="hljs-comment">/* 时钟的中断处理函数 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">intr_timer_handler</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> <br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span>* <span class="hljs-title">cur_thread</span> =</span> running_thread();<br><br>	ASSERT(cur_thread-&gt;stack_magic == <span class="hljs-number">0x19870916</span>);         <span class="hljs-comment">// 检查栈是否溢出</span><br><br>	cur_thread-&gt;elapsed_ticks++;	  <span class="hljs-comment">// 记录此线程占用的cpu时间嘀</span><br>	ticks++;	  <span class="hljs-comment">//从内核第一次处理时间中断后开始至今的滴哒数,内核态和用户态总共的嘀哒数</span><br><br>	<span class="hljs-keyword">if</span> (cur_thread-&gt;ticks == <span class="hljs-number">0</span>) 		<span class="hljs-comment">// 若进程时间片用完就开始调度新的进程上cpu</span><br>	&#123;	  <br>		schedule(); <br>	&#125; <br>	<span class="hljs-keyword">else</span> 			<span class="hljs-comment">// 将当前进程的时间片-1</span><br>	&#123;				  <br>		cur_thread-&gt;ticks--;<br>	&#125;<br>&#125;<br><br><br><span class="hljs-comment">/* 初始化PIT8253 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">timer_init</span><span class="hljs-params">()</span> <br>&#123;<br>	put_str(<span class="hljs-string">&quot;timer_init start\n&quot;</span>);<br>	<span class="hljs-comment">/* 设置8253的定时周期,也就是发中断的周期 */</span><br>	frequency_set(CONTRER0_PORT, COUNTER0_NO, READ_WRITE_LATCH, COUNTER_MODE, COUNTER0_VALUE);<br>	register_handler(<span class="hljs-number">0x20</span>, intr_timer_handler);<br>	put_str(<span class="hljs-string">&quot;timer_init done\n&quot;</span>);<br>&#125;<br><br><br><span class="hljs-comment">// 以tick为单位的sleep,任何时间形式的sleep会转换此ticks形式</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">ticks_to_sleep</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> sleep_ticks)</span> <br>&#123;<br>	<span class="hljs-type">uint32_t</span> start_tick = ticks;<br><br>	<span class="hljs-keyword">while</span> (ticks - start_tick &lt; sleep_ticks) 	<span class="hljs-comment">// 若间隔的ticks数不够便让出cpu</span><br>	&#123;	  <br>		thread_yield();<br>	&#125;<br>&#125;<br><br><br><span class="hljs-comment">// 以毫秒为单位的sleep   1秒= 1000毫秒</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">mtime_sleep</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> m_seconds)</span> <br>&#123;<br>	<span class="hljs-type">uint32_t</span> sleep_ticks = DIV_ROUND_UP(m_seconds, mil_seconds_per_intr);<br>	ASSERT(sleep_ticks &gt; <span class="hljs-number">0</span>);<br>	ticks_to_sleep(sleep_ticks); <br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="kernelinitc修改"><a class="markdownIt-Anchor" href="#kernelinitc修改"></a> kernel/init.c修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;init.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;interrupt.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../device/timer.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;memory.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../thread/thread.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../device/console.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../device/keyboard.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../userprog/tss.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../device/ide.h&quot;</span></span><br><br><span class="hljs-comment">/*负责初始化所有模块 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">init_all</span><span class="hljs-params">()</span> <br>&#123;<br>   	put_str(<span class="hljs-string">&quot;init_all\n&quot;</span>);<br>	idt_init();	     <span class="hljs-comment">// 初始化中断</span><br>	mem_init();<br>	timer_init();<br>	thread_init();<br>	console_init();<br>	keyboard_init();<br>	tss_init();<br>	syscall_init();<br>	ide_init();<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="kernelmainc修改"><a class="markdownIt-Anchor" href="#kernelmainc修改"></a> kernel/main.c修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;init.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;debug.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;string.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;memory.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../thread/thread.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;interrupt.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../device/console.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../device/ioqueue.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../device/keyboard.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../userprog/process.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../lib/user/syscall.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../userprog/syscall-init.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../lib/stdio.h&quot;</span></span><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>   	put_str(<span class="hljs-string">&quot;I am kernel\n&quot;</span>);<br>   	init_all();<br><br>	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br>   	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="运行结果"><a class="markdownIt-Anchor" href="#运行结果"></a> 运行结果</h3>
<p><img src="/img/os/os13.2.png" srcset="/img/loading.gif" lazyload alt="图为bochs运行界面" /></p>
<h3 id="写在后面"><a class="markdownIt-Anchor" href="#写在后面"></a> 写在后面</h3>
<p>完成这一章花费了一天的时间，主要是集中在编写硬盘驱动程序这块了。</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a>
                    
                      <a class="hover-with-bg" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E7%9C%9F%E8%B1%A1%E8%BF%98%E5%8E%9F/">真象还原</a>
                    
                  </div>
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/08/07/os(14-1)/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">第十四章 文件系统 最后的挑战(上)</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/08/04/os(12)/">
                        <span class="hidden-mobile">第十二章 实现系统调用 新增printf函数和堆内存管理</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <div style="font-size: 0.85rem"> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>





  

  
    <!-- KaTeX -->
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0/dist/katex.min.css" />
  











<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
