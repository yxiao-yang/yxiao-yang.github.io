

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/app.png">
  <link rel="icon" href="/img/app.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="第十五章 终章 呈现系统交互界面(中)  写在前面 这一中章全都是书上实现shell这一部分，为了呈现方便，直接采用了最终的代码，没有一步步按照书上的代码去展示。  实现shell  shell&#x2F;shell.h创建 1234567891011#ifndef __SHELL_SHELL_H#define __SHELL_SHELL_H#include &quot;stdint.h&quot;voi">
<meta property="og:type" content="article">
<meta property="og:title" content="第十五章 终章 呈现系统交互界面(中)">
<meta property="og:url" content="http://example.com/2022/08/09/os(15-2)/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="第十五章 终章 呈现系统交互界面(中)  写在前面 这一中章全都是书上实现shell这一部分，为了呈现方便，直接采用了最终的代码，没有一步步按照书上的代码去展示。  实现shell  shell&#x2F;shell.h创建 1234567891011#ifndef __SHELL_SHELL_H#define __SHELL_SHELL_H#include &quot;stdint.h&quot;voi">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/os/os15.2.png">
<meta property="og:image" content="http://example.com/img/os/os15.3.png">
<meta property="og:image" content="http://example.com/img/os/os15.4.png">
<meta property="og:image" content="http://example.com/img/os/os15.5.png">
<meta property="article:published_time" content="2022-08-09T08:07:16.200Z">
<meta property="article:modified_time" content="2022-08-09T14:04:32.083Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/os/os15.2.png">
  
  
  <title>第十五章 终章 呈现系统交互界面(中) - Hexo</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":50,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>羊</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/bg2.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="第十五章 终章 呈现系统交互界面(中)">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-08-09 16:07" pubdate>
        2022年8月9日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      34k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      284 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">第十五章 终章 呈现系统交互界面(中)</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：9 个月前
                
              </p>
            
            <div class="markdown-body">
              <h1 id="第十五章-终章-呈现系统交互界面中"><a class="markdownIt-Anchor" href="#第十五章-终章-呈现系统交互界面中"></a> 第十五章 终章 呈现系统交互界面(中)</h1>
<h2 id="写在前面"><a class="markdownIt-Anchor" href="#写在前面"></a> 写在前面</h2>
<p>这一中章全都是书上实现shell这一部分，为了呈现方便，直接采用了最终的代码，没有一步步按照书上的代码去展示。</p>
<h2 id="实现shell"><a class="markdownIt-Anchor" href="#实现shell"></a> 实现shell</h2>
<h3 id="shellshellh创建"><a class="markdownIt-Anchor" href="#shellshellh创建"></a> shell/shell.h创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __SHELL_SHELL_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __SHELL_SHELL_H</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">print_prompt</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">readline</span><span class="hljs-params">(<span class="hljs-type">char</span>* buf,<span class="hljs-type">int32_t</span> count)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">my_shell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int32_t</span> <span class="hljs-title function_">cmd_parse</span><span class="hljs-params">(<span class="hljs-type">char</span>* cmd_str,<span class="hljs-type">char</span>** argv,<span class="hljs-type">char</span> token)</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
<h3 id="shellshellc创建"><a class="markdownIt-Anchor" href="#shellshellc创建"></a> shell/shell.c创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;shell.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;global.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;string.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;syscall.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdio.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../fs/file.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../kernel/debug.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;buildin_cmd.h&quot;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_ARG_NR 16	   <span class="hljs-comment">// 加上命令名外,最多支持15个参数</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> cmd_len 128    			<span class="hljs-comment">//最大支持键入128个字符的命令行输入</span></span><br><br><span class="hljs-comment">/* 存储输入的命令 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">char</span> cmd_line[cmd_len] = &#123;<span class="hljs-number">0</span>&#125;;<br><span class="hljs-type">char</span> final_path[MAX_PATH_LEN] = &#123;<span class="hljs-number">0</span>&#125;;      <span class="hljs-comment">// 用于洗路径时的缓冲</span><br><br><span class="hljs-comment">/* 用来记录当前目录,是当前目录的缓存,每次执行cd命令时会更新此内容 */</span><br><span class="hljs-type">char</span> cwd_cache[<span class="hljs-number">64</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br><span class="hljs-type">char</span>* argv[MAX_ARG_NR] = &#123;<span class="hljs-literal">NULL</span>&#125;;<br><span class="hljs-type">int32_t</span> argc = <span class="hljs-number">-1</span>;<br><br><span class="hljs-comment">/* 输出提示符 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">print_prompt</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>   <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[rabbit@localhost %s]$ &quot;</span>, cwd_cache);<br>&#125;<br><br><span class="hljs-comment">/* 从键盘缓冲区中最多读入count个字节到buf。*/</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">readline</span><span class="hljs-params">(<span class="hljs-type">char</span>* buf, <span class="hljs-type">int32_t</span> count)</span> &#123;<br>   ASSERT(buf != <span class="hljs-literal">NULL</span> &amp;&amp; count &gt; <span class="hljs-number">0</span>);<br>   <span class="hljs-type">char</span>* pos = buf;<br><br>   <span class="hljs-keyword">while</span> (read(stdin_no, pos, <span class="hljs-number">1</span>) != <span class="hljs-number">-1</span> &amp;&amp; (pos - buf) &lt; count) &#123; <span class="hljs-comment">// 在不出错情况下,直到找到回车符才返回</span><br>      <span class="hljs-keyword">switch</span> (*pos) &#123;<br>       <span class="hljs-comment">/* 找到回车或换行符后认为键入的命令结束,直接返回 */</span><br>	 <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;\n&#x27;</span>:<br>	 <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;\r&#x27;</span>:<br>	    *pos = <span class="hljs-number">0</span>;	   <span class="hljs-comment">// 添加cmd_line的终止字符0</span><br>	    <span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27;\n&#x27;</span>);<br>	    <span class="hljs-keyword">return</span>;<br>	 <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;\b&#x27;</span>:<br>	    <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">0</span>] != <span class="hljs-string">&#x27;\b&#x27;</span>) &#123;		<span class="hljs-comment">// 阻止删除非本次输入的信息</span><br>	       --pos;	   <span class="hljs-comment">// 退回到缓冲区cmd_line中上一个字符</span><br>	       <span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27;\b&#x27;</span>);<br>	    &#125;<br>	    <span class="hljs-keyword">break</span>;<br>   	 <span class="hljs-comment">/* ctrl+l 清屏 */</span><br>	 <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;l&#x27;</span> - <span class="hljs-string">&#x27;a&#x27;</span>: <br>	    <span class="hljs-comment">/* 1 先将当前的字符&#x27;l&#x27;-&#x27;a&#x27;置为0 */</span><br>	    *pos = <span class="hljs-number">0</span>;<br>	    <span class="hljs-comment">/* 2 再将屏幕清空 */</span><br>	    clear();<br>	    <span class="hljs-comment">/* 3 打印提示符 */</span><br>	    print_prompt();<br>	    <span class="hljs-comment">/* 4 将之前键入的内容再次打印 */</span><br>	    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s&quot;</span>, buf);<br>	    <span class="hljs-keyword">break</span>;<br><br>	 <span class="hljs-comment">/* ctrl+u 清掉输入 */</span><br>	 <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;u&#x27;</span> - <span class="hljs-string">&#x27;a&#x27;</span>:<br>	    <span class="hljs-keyword">while</span> (buf != pos) &#123;<br>	       <span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27;\b&#x27;</span>);<br>	       *(pos--) = <span class="hljs-number">0</span>;<br>	    &#125;<br>	    <span class="hljs-keyword">break</span>;<br>	 <span class="hljs-comment">/* 非控制键则输出字符 */</span><br>	 <span class="hljs-keyword">default</span>:<br>	    <span class="hljs-built_in">putchar</span>(*pos);<br>	    pos++;<br>      &#125;<br>   &#125;<br>   <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;readline: can`t find enter_key in the cmd_line, max num of char is 128\n&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">/* 分析字符串cmd_str中以token为分隔符的单词,将各单词的指针存入argv数组 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int32_t</span> <span class="hljs-title function_">cmd_parse</span><span class="hljs-params">(<span class="hljs-type">char</span>* cmd_str, <span class="hljs-type">char</span>** argv, <span class="hljs-type">char</span> token)</span> &#123;<br>   ASSERT(cmd_str != <span class="hljs-literal">NULL</span>);<br>   <span class="hljs-type">int32_t</span> arg_idx = <span class="hljs-number">0</span>;<br>   <span class="hljs-keyword">while</span>(arg_idx &lt; MAX_ARG_NR) &#123;<br>      argv[arg_idx] = <span class="hljs-literal">NULL</span>;<br>      arg_idx++;<br>   &#125;<br>   <span class="hljs-type">char</span>* next = cmd_str;<br>   <span class="hljs-type">int32_t</span> argc = <span class="hljs-number">0</span>;<br>   <span class="hljs-comment">/* 外层循环处理整个命令行 */</span><br>   <span class="hljs-keyword">while</span>(*next) &#123;<br>      <span class="hljs-comment">/* 去除命令字或参数之间的空格 */</span><br>      <span class="hljs-keyword">while</span>(*next == token) &#123;<br>	 next++;<br>      &#125;<br>      <span class="hljs-comment">/* 处理最后一个参数后接空格的情况,如&quot;ls dir2 &quot; */</span><br>      <span class="hljs-keyword">if</span> (*next == <span class="hljs-number">0</span>) &#123;<br>	 <span class="hljs-keyword">break</span>; <br>      &#125;<br>      argv[argc] = next;<br><br>     <span class="hljs-comment">/* 内层循环处理命令行中的每个命令字及参数 */</span><br>      <span class="hljs-keyword">while</span> (*next &amp;&amp; *next != token) &#123;	  <span class="hljs-comment">// 在字符串结束前找单词分隔符</span><br>	 next++;<br>      &#125;<br><br>      <span class="hljs-comment">/* 如果未结束(是token字符),使tocken变成0 */</span><br>      <span class="hljs-keyword">if</span> (*next) &#123;<br>	 *next++ = <span class="hljs-number">0</span>;	<span class="hljs-comment">// 将token字符替换为字符串结束符0,做为一个单词的结束,并将字符指针next指向下一个字符</span><br>      &#125;<br>   <br>      <span class="hljs-comment">/* 避免argv数组访问越界,参数过多则返回0 */</span><br>      <span class="hljs-keyword">if</span> (argc &gt; MAX_ARG_NR) &#123;<br>	 <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>      &#125;<br>      argc++;<br>   &#125;<br>   <span class="hljs-keyword">return</span> argc;<br>&#125;<br><br><span class="hljs-comment">/* 简单的shell */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">my_shell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>   cwd_cache[<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;/&#x27;</span>;<br>   <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>      print_prompt(); <br>      <span class="hljs-built_in">memset</span>(final_path, <span class="hljs-number">0</span>, MAX_PATH_LEN);<br>      <span class="hljs-built_in">memset</span>(cmd_line, <span class="hljs-number">0</span>, cmd_len);<br>      readline(cmd_line, cmd_len);<br><br>      <span class="hljs-keyword">if</span> (cmd_line[<span class="hljs-number">0</span>] == <span class="hljs-number">0</span>) &#123;	 <span class="hljs-comment">// 若只键入了一个回车</span><br>	      <span class="hljs-keyword">continue</span>;<br>      &#125;<br><br>      argc = <span class="hljs-number">-1</span>;<br>      argc = cmd_parse(cmd_line, argv, <span class="hljs-string">&#x27; &#x27;</span>);<br>      <span class="hljs-keyword">if</span> (argc == <span class="hljs-number">-1</span>) &#123;<br>         <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;num of arguments exceed %d\n&quot;</span>, MAX_ARG_NR);<br>         <span class="hljs-keyword">continue</span>;<br>      &#125;<br><br>      <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;ls&quot;</span>, argv[<span class="hljs-number">0</span>])) &#123;<br>         buildin_ls(argc, argv);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;cd&quot;</span>, argv[<span class="hljs-number">0</span>])) &#123;<br>         <span class="hljs-keyword">if</span> (buildin_cd(argc, argv) != <span class="hljs-literal">NULL</span>) &#123;<br>            <span class="hljs-built_in">memset</span>(cwd_cache, <span class="hljs-number">0</span>, MAX_PATH_LEN);<br>            <span class="hljs-built_in">strcpy</span>(cwd_cache, final_path);<br>         &#125;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;pwd&quot;</span>, argv[<span class="hljs-number">0</span>])) &#123;<br>         buildin_pwd(argc, argv);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;ps&quot;</span>, argv[<span class="hljs-number">0</span>])) &#123;<br>         buildin_ps(argc, argv);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;clear&quot;</span>, argv[<span class="hljs-number">0</span>])) &#123;<br>         buildin_clear(argc, argv);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;mkdir&quot;</span>, argv[<span class="hljs-number">0</span>]))&#123;<br>         buildin_mkdir(argc, argv);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;rmdir&quot;</span>, argv[<span class="hljs-number">0</span>]))&#123;<br>         buildin_rmdir(argc, argv);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;rm&quot;</span>, argv[<span class="hljs-number">0</span>])) &#123;<br>         buildin_rm(argc, argv);<br>      &#125; <br>  &#125;<br>   panic(<span class="hljs-string">&quot;my_shell: should not be here&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="devicekeyboardc修改"><a class="markdownIt-Anchor" href="#devicekeyboardc修改"></a> device/keyboard.c修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;keyboard.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;io.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;interrupt.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;global.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;ioqueue.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KBD_BUF_PORT 0X60</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KBD_BUF_PORT 0X60</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> esc <span class="hljs-string">&#x27;\033&#x27;</span>		<span class="hljs-comment">//esc 和 delete都没有</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> delete <span class="hljs-string">&#x27;\0177&#x27;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> enter <span class="hljs-string">&#x27;\r&#x27;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> tab <span class="hljs-string">&#x27;\t&#x27;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> backspace <span class="hljs-string">&#x27;\b&#x27;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> char_invisible 0	<span class="hljs-comment">//功能性 不可见字符均设置为0</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ctrl_l_char char_invisible</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ctrl_r_char char_invisible </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> shift_l_char char_invisible</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> shift_r_char char_invisible</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> alt_l_char char_invisible</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> alt_r_char char_invisible</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> caps_lock_char char_invisible</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> shift_l_make 0x2a</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> shift_r_make 0x36</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> alt_l_make 0x38</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> alt_r_make 0xe038</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> alt_r_break 0xe0b8</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ctrl_l_make 0x1d</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ctrl_r_make 0xe01d</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ctrl_r_break 0xe09d</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> caps_lock_make 0x3a</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ioqueue</span> <span class="hljs-title">kbd_buf</span>;</span>	   <span class="hljs-comment">// 定义键盘缓冲区</span><br><br><span class="hljs-type">bool</span> ctrl_status = <span class="hljs-literal">false</span>,shift_status = <span class="hljs-literal">false</span>,alt_status = <span class="hljs-literal">false</span>,caps_lock_status = <span class="hljs-literal">false</span>,ext_scancode = <span class="hljs-literal">false</span>;<br><br><br><span class="hljs-type">char</span> keymap[][<span class="hljs-number">2</span>] = &#123;<br><span class="hljs-comment">/* 0x00 */</span>	&#123;<span class="hljs-number">0</span>,	<span class="hljs-number">0</span>&#125;,		<br><span class="hljs-comment">/* 0x01 */</span>	&#123;esc,	esc&#125;,		<br><span class="hljs-comment">/* 0x02 */</span>	&#123;<span class="hljs-string">&#x27;1&#x27;</span>,	<span class="hljs-string">&#x27;!&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x03 */</span>	&#123;<span class="hljs-string">&#x27;2&#x27;</span>,	<span class="hljs-string">&#x27;@&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x04 */</span>	&#123;<span class="hljs-string">&#x27;3&#x27;</span>,	<span class="hljs-string">&#x27;#&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x05 */</span>	&#123;<span class="hljs-string">&#x27;4&#x27;</span>,	<span class="hljs-string">&#x27;$&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x06 */</span>	&#123;<span class="hljs-string">&#x27;5&#x27;</span>,	<span class="hljs-string">&#x27;%&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x07 */</span>	&#123;<span class="hljs-string">&#x27;6&#x27;</span>,	<span class="hljs-string">&#x27;^&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x08 */</span>	&#123;<span class="hljs-string">&#x27;7&#x27;</span>,	<span class="hljs-string">&#x27;&amp;&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x09 */</span>	&#123;<span class="hljs-string">&#x27;8&#x27;</span>,	<span class="hljs-string">&#x27;*&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x0A */</span>	&#123;<span class="hljs-string">&#x27;9&#x27;</span>,	<span class="hljs-string">&#x27;(&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x0B */</span>	&#123;<span class="hljs-string">&#x27;0&#x27;</span>,	<span class="hljs-string">&#x27;)&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x0C */</span>	&#123;<span class="hljs-string">&#x27;-&#x27;</span>,	<span class="hljs-string">&#x27;_&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x0D */</span>	&#123;<span class="hljs-string">&#x27;=&#x27;</span>,	<span class="hljs-string">&#x27;+&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x0E */</span>	&#123;backspace, backspace&#125;,	<br><span class="hljs-comment">/* 0x0F */</span>	&#123;tab,	tab&#125;,		<br><span class="hljs-comment">/* 0x10 */</span>	&#123;<span class="hljs-string">&#x27;q&#x27;</span>,	<span class="hljs-string">&#x27;Q&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x11 */</span>	&#123;<span class="hljs-string">&#x27;w&#x27;</span>,	<span class="hljs-string">&#x27;W&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x12 */</span>	&#123;<span class="hljs-string">&#x27;e&#x27;</span>,	<span class="hljs-string">&#x27;E&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x13 */</span>	&#123;<span class="hljs-string">&#x27;r&#x27;</span>,	<span class="hljs-string">&#x27;R&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x14 */</span>	&#123;<span class="hljs-string">&#x27;t&#x27;</span>,	<span class="hljs-string">&#x27;T&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x15 */</span>	&#123;<span class="hljs-string">&#x27;y&#x27;</span>,	<span class="hljs-string">&#x27;Y&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x16 */</span>	&#123;<span class="hljs-string">&#x27;u&#x27;</span>,	<span class="hljs-string">&#x27;U&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x17 */</span>	&#123;<span class="hljs-string">&#x27;i&#x27;</span>,	<span class="hljs-string">&#x27;I&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x18 */</span>	&#123;<span class="hljs-string">&#x27;o&#x27;</span>,	<span class="hljs-string">&#x27;O&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x19 */</span>	&#123;<span class="hljs-string">&#x27;p&#x27;</span>,	<span class="hljs-string">&#x27;P&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x1A */</span>	&#123;<span class="hljs-string">&#x27;[&#x27;</span>,	<span class="hljs-string">&#x27;&#123;&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x1B */</span>	&#123;<span class="hljs-string">&#x27;]&#x27;</span>,	<span class="hljs-string">&#x27;&#125;&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x1C */</span>	&#123;enter,  enter&#125;,<br><span class="hljs-comment">/* 0x1D */</span>	&#123;ctrl_l_char, ctrl_l_char&#125;,<br><span class="hljs-comment">/* 0x1E */</span>	&#123;<span class="hljs-string">&#x27;a&#x27;</span>,	<span class="hljs-string">&#x27;A&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x1F */</span>	&#123;<span class="hljs-string">&#x27;s&#x27;</span>,	<span class="hljs-string">&#x27;S&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x20 */</span>	&#123;<span class="hljs-string">&#x27;d&#x27;</span>,	<span class="hljs-string">&#x27;D&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x21 */</span>	&#123;<span class="hljs-string">&#x27;f&#x27;</span>,	<span class="hljs-string">&#x27;F&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x22 */</span>	&#123;<span class="hljs-string">&#x27;g&#x27;</span>,	<span class="hljs-string">&#x27;G&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x23 */</span>	&#123;<span class="hljs-string">&#x27;h&#x27;</span>,	<span class="hljs-string">&#x27;H&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x24 */</span>	&#123;<span class="hljs-string">&#x27;j&#x27;</span>,	<span class="hljs-string">&#x27;J&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x25 */</span>	&#123;<span class="hljs-string">&#x27;k&#x27;</span>,	<span class="hljs-string">&#x27;K&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x26 */</span>	&#123;<span class="hljs-string">&#x27;l&#x27;</span>,	<span class="hljs-string">&#x27;L&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x27 */</span>	&#123;<span class="hljs-string">&#x27;;&#x27;</span>,	<span class="hljs-string">&#x27;:&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x28 */</span>	&#123;<span class="hljs-string">&#x27;\&#x27;&#x27;</span>,	<span class="hljs-string">&#x27;&quot;&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x29 */</span>	&#123;<span class="hljs-string">&#x27;`&#x27;</span>,	<span class="hljs-string">&#x27;~&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x2A */</span>	&#123;shift_l_char, shift_l_char&#125;,	<br><span class="hljs-comment">/* 0x2B */</span>	&#123;<span class="hljs-string">&#x27;\\&#x27;</span>,	<span class="hljs-string">&#x27;|&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x2C */</span>	&#123;<span class="hljs-string">&#x27;z&#x27;</span>,	<span class="hljs-string">&#x27;Z&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x2D */</span>	&#123;<span class="hljs-string">&#x27;x&#x27;</span>,	<span class="hljs-string">&#x27;X&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x2E */</span>	&#123;<span class="hljs-string">&#x27;c&#x27;</span>,	<span class="hljs-string">&#x27;C&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x2F */</span>	&#123;<span class="hljs-string">&#x27;v&#x27;</span>,	<span class="hljs-string">&#x27;V&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x30 */</span>	&#123;<span class="hljs-string">&#x27;b&#x27;</span>,	<span class="hljs-string">&#x27;B&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x31 */</span>	&#123;<span class="hljs-string">&#x27;n&#x27;</span>,	<span class="hljs-string">&#x27;N&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x32 */</span>	&#123;<span class="hljs-string">&#x27;m&#x27;</span>,	<span class="hljs-string">&#x27;M&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x33 */</span>	&#123;<span class="hljs-string">&#x27;,&#x27;</span>,	<span class="hljs-string">&#x27;&lt;&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x34 */</span>	&#123;<span class="hljs-string">&#x27;.&#x27;</span>,	<span class="hljs-string">&#x27;&gt;&#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x35 */</span>	&#123;<span class="hljs-string">&#x27;/&#x27;</span>,	<span class="hljs-string">&#x27;?&#x27;</span>&#125;,<br><span class="hljs-comment">/* 0x36	*/</span>	&#123;shift_r_char, shift_r_char&#125;,	<br><span class="hljs-comment">/* 0x37 */</span>	&#123;<span class="hljs-string">&#x27;*&#x27;</span>,	<span class="hljs-string">&#x27;*&#x27;</span>&#125;,    	<br><span class="hljs-comment">/* 0x38 */</span>	&#123;alt_l_char, alt_l_char&#125;,<br><span class="hljs-comment">/* 0x39 */</span>	&#123;<span class="hljs-string">&#x27; &#x27;</span>,	<span class="hljs-string">&#x27; &#x27;</span>&#125;,		<br><span class="hljs-comment">/* 0x3A */</span>	&#123;caps_lock_char, caps_lock_char&#125;<br>&#125;;<br><br><span class="hljs-comment">/* 键盘初始化 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">keyboard_init</span><span class="hljs-params">()</span> <br>&#123;<br>	put_str(<span class="hljs-string">&quot;keyboard init start\n&quot;</span>);<br>	ioqueue_init(&amp;kbd_buf);<br>	register_handler(<span class="hljs-number">0x21</span>, intr_keyboard_handler);<br>	put_str(<span class="hljs-string">&quot;keyboard init done\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">intr_keyboard_handler</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">bool</span> ctrl_down_last = ctrl_status;<br>    <span class="hljs-type">bool</span> shift_down_last = shift_status;<br>    <span class="hljs-type">bool</span> caps_lock_last = caps_lock_status;<br>    <br>    <span class="hljs-type">bool</span> break_code;<br>    <span class="hljs-type">uint16_t</span> scancode = inb(KBD_BUF_PORT);<br>    <br>    <span class="hljs-keyword">if</span>(scancode == <span class="hljs-number">0xe0</span>)	<span class="hljs-comment">//多字节处理</span><br>    &#123;<br>    	ext_scancode = <span class="hljs-literal">true</span>;<br>    	<span class="hljs-keyword">return</span>;<br>    &#125;<br>    <br>    break_code = ((scancode &amp; <span class="hljs-number">0x0080</span>) != <span class="hljs-number">0</span>); <span class="hljs-comment">//断码 = 通码 + 0x80 通码最小比0x80小 则只有断码才可以有</span><br>    <br>    <span class="hljs-keyword">if</span>(break_code)<br>    &#123;<br>    	<span class="hljs-type">uint16_t</span> make_code = (scancode &amp;= <span class="hljs-number">0xff7f</span>); <span class="hljs-comment">//多字节不处理</span><br>    	<span class="hljs-keyword">if</span>(make_code == ctrl_l_make || make_code == ctrl_r_make) ctrl_status = <span class="hljs-literal">false</span>;<br>    	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(make_code == shift_l_make || make_code == shift_r_make) shift_status = <span class="hljs-literal">false</span>;<br>    	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(make_code == alt_l_make || make_code == alt_r_make) alt_status = <span class="hljs-literal">false</span>;<br>    	<span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>((scancode &gt; <span class="hljs-number">0x00</span> &amp;&amp; scancode &lt; <span class="hljs-number">0x3b</span>) || (scancode == alt_r_make) || (scancode == ctrl_r_make))<br>    &#123;<br>    	<span class="hljs-type">bool</span> shift = <span class="hljs-literal">false</span>; <span class="hljs-comment">//先默认设置成false</span><br>    	<span class="hljs-keyword">if</span>((scancode &lt; <span class="hljs-number">0x0e</span>) || (scancode == <span class="hljs-number">0x29</span>) || (scancode == <span class="hljs-number">0x1a</span>) || \<br>    	(scancode == <span class="hljs-number">0x1b</span>) || (scancode == <span class="hljs-number">0x2b</span>) || (scancode == <span class="hljs-number">0x27</span>) || \<br>    	(scancode == <span class="hljs-number">0x28</span>) || (scancode == <span class="hljs-number">0x33</span>) || (scancode == <span class="hljs-number">0x34</span>) || \<br>    	(scancode == <span class="hljs-number">0x35</span>))<br>    	&#123;<br>    	    <span class="hljs-keyword">if</span>(shift_down_last)	shift = <span class="hljs-literal">true</span>;<br>    	&#125;<br>    	<span class="hljs-keyword">else</span><br>    	&#123;<br>    	    <span class="hljs-keyword">if</span>(shift_down_last &amp;&amp; caps_lock_last)	shift = <span class="hljs-literal">false</span>; <span class="hljs-comment">//效果确实是这样子的 我试了一下</span><br>    	    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(shift_down_last || caps_lock_last) shift = <span class="hljs-literal">true</span>; <span class="hljs-comment">//其中任意一个都是大写的作用</span><br>    	    <span class="hljs-keyword">else</span> shift = <span class="hljs-literal">false</span>;<br>    	&#125;<br>    	<br>    	<span class="hljs-type">uint8_t</span> index = (scancode &amp; <span class="hljs-number">0x00ff</span>);<br>        <span class="hljs-type">char</span> cur_char = keymap[index][shift];<br>        <br>        <span class="hljs-keyword">if</span>((ctrl_down_last &amp;&amp; cur_char == <span class="hljs-string">&#x27;l&#x27;</span>) || (ctrl_down_last &amp;&amp; cur_char == <span class="hljs-string">&#x27;u&#x27;</span>))<br>            cur_char -= <span class="hljs-string">&#x27;a&#x27;</span>;<br>        <br>        <span class="hljs-keyword">if</span>(cur_char)<br>        &#123;<br>        	<span class="hljs-keyword">if</span>(!ioq_full(&amp;kbd_buf))<br>        		ioq_putchar(&amp;kbd_buf,cur_char);<br>        	<span class="hljs-comment">//put_char(cur_char);</span><br>	    	<span class="hljs-keyword">return</span>;<br>	&#125;<br>    <br>	<span class="hljs-keyword">if</span>(scancode == ctrl_l_make || scancode == ctrl_r_make)    	<br>	    ctrl_status = <span class="hljs-literal">true</span>;<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(scancode == shift_l_make || scancode == shift_r_make)<br>            shift_status = <span class="hljs-literal">true</span>;<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(scancode == alt_l_make || scancode == alt_r_make)<br>	    alt_status = <span class="hljs-literal">true</span>;<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(scancode == caps_lock_make)<br>	    caps_lock_status = !caps_lock_status;<br>	<span class="hljs-keyword">else</span> put_str(<span class="hljs-string">&quot;unknown key\n&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="libusersyscallh修改"><a class="markdownIt-Anchor" href="#libusersyscallh修改"></a> lib/user/syscall.h修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __LIB_USER_SYSCALL_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LIB_USER_SYSCALL_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">SYSCALL_NR</span> &#123;</span><br>   SYS_GETPID,<br>   SYS_WRITE,<br>   SYS_MALLOC,<br>   SYS_FREE,<br>   SYS_FORK,<br>   SYS_READ,<br>   SYS_PUTCHAR,<br>   SYS_CLEAR,<br>   SYS_GETCWD,<br>   SYS_OPEN,<br>   SYS_CLOSE,<br>   SYS_LSEEK,<br>   SYS_UNLINK,<br>   SYS_MKDIR,<br>   SYS_OPENDIR,<br>   SYS_CLOSEDIR,<br>   SYS_CHDIR,<br>   SYS_RMDIR,<br>   SYS_READDIR,<br>   SYS_REWINDDIR,<br>   SYS_STAT,<br>   SYS_PS<br>&#125;;<br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">getpid</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">write</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">void</span>* buf, <span class="hljs-type">uint32_t</span> count)</span>;<br><span class="hljs-type">void</span>* <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> size)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">free</span><span class="hljs-params">(<span class="hljs-type">void</span>* ptr)</span>;<br><span class="hljs-type">int32_t</span> <span class="hljs-title function_">fork</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
<h3 id="libusersyscallc修改"><a class="markdownIt-Anchor" href="#libusersyscallc修改"></a> lib/user/syscall.c修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;syscall.h&quot;</span></span><br><br><span class="hljs-comment">/* 无参数的系统调用 */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _syscall0(NUMBER) (&#123;				       \</span><br><span class="hljs-meta">   int retval;					               \</span><br><span class="hljs-meta">   asm volatile (					       \</span><br><span class="hljs-meta">   <span class="hljs-string">&quot;int $0x80&quot;</span>						       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;=a&quot;</span> (retval)					       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;a&quot;</span> (NUMBER)					       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;memory&quot;</span>						       \</span><br><span class="hljs-meta">   );							       \</span><br><span class="hljs-meta">   retval;						       \</span><br><span class="hljs-meta">&#125;)</span><br><br><br><span class="hljs-comment">/* 一个参数的系统调用 */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _syscall1(NUMBER, ARG1) (&#123;			       \</span><br><span class="hljs-meta">   int retval;					               \</span><br><span class="hljs-meta">   asm volatile (					       \</span><br><span class="hljs-meta">   <span class="hljs-string">&quot;int $0x80&quot;</span>						       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;=a&quot;</span> (retval)					       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;a&quot;</span> (NUMBER), <span class="hljs-string">&quot;b&quot;</span> (ARG1)				       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;memory&quot;</span>						       \</span><br><span class="hljs-meta">   );							       \</span><br><span class="hljs-meta">   retval;						       \</span><br><span class="hljs-meta">&#125;)</span><br><br><span class="hljs-comment">/* 两个参数的系统调用 */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _syscall2(NUMBER, ARG1, ARG2) (&#123;		       \</span><br><span class="hljs-meta">   int retval;						       \</span><br><span class="hljs-meta">   asm volatile (					       \</span><br><span class="hljs-meta">   <span class="hljs-string">&quot;int $0x80&quot;</span>						       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;=a&quot;</span> (retval)					       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;a&quot;</span> (NUMBER), <span class="hljs-string">&quot;b&quot;</span> (ARG1), <span class="hljs-string">&quot;c&quot;</span> (ARG2)		       \</span><br><span class="hljs-meta">   : <span class="hljs-string">&quot;memory&quot;</span>						       \</span><br><span class="hljs-meta">   );							       \</span><br><span class="hljs-meta">   retval;						       \</span><br><span class="hljs-meta">&#125;)</span><br><br><span class="hljs-comment">/* 三个参数的系统调用 */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _syscall3(NUMBER, ARG1, ARG2, ARG3) (&#123;		       \</span><br><span class="hljs-meta">   int retval;						       \</span><br><span class="hljs-meta">   asm volatile (					       \</span><br><span class="hljs-meta">      <span class="hljs-string">&quot;int $0x80&quot;</span>					       \</span><br><span class="hljs-meta">      : <span class="hljs-string">&quot;=a&quot;</span> (retval)					       \</span><br><span class="hljs-meta">      : <span class="hljs-string">&quot;a&quot;</span> (NUMBER), <span class="hljs-string">&quot;b&quot;</span> (ARG1), <span class="hljs-string">&quot;c&quot;</span> (ARG2), <span class="hljs-string">&quot;d&quot;</span> (ARG3)       \</span><br><span class="hljs-meta">      : <span class="hljs-string">&quot;memory&quot;</span>					       \</span><br><span class="hljs-meta">   );							       \</span><br><span class="hljs-meta">   retval;						       \</span><br><span class="hljs-meta">&#125;)</span><br><br><span class="hljs-comment">/* 返回当前任务pid */</span><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">getpid</span><span class="hljs-params">()</span> <br>&#123;<br>   <span class="hljs-keyword">return</span> _syscall0(SYS_GETPID);<br>&#125;<br><br><span class="hljs-comment">/* 把buf中count个字符写入文件描述符fd */</span><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">write</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">void</span>* buf, <span class="hljs-type">uint32_t</span> count)</span> &#123;<br>   <span class="hljs-keyword">return</span> _syscall3(SYS_WRITE, fd, buf, count);<br>&#125;<br><br><span class="hljs-type">void</span>* <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> size)</span><br>&#123;<br>   <span class="hljs-keyword">return</span> (<span class="hljs-type">void</span>*)_syscall1(SYS_MALLOC, size);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">free</span><span class="hljs-params">(<span class="hljs-type">void</span>* ptr)</span><br>&#123;<br>   _syscall1(SYS_FREE, ptr);<br>&#125;<br><br><span class="hljs-type">int32_t</span> <span class="hljs-title function_">fork</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>   <span class="hljs-keyword">return</span> _syscall0(SYS_FORK);<br>&#125;<br><br><span class="hljs-comment">/* 从文件描述符fd中读取count个字节到buf */</span><br><span class="hljs-type">int32_t</span> <span class="hljs-title function_">read</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> fd, <span class="hljs-type">void</span>* buf, <span class="hljs-type">uint32_t</span> count)</span> &#123;<br>   <span class="hljs-keyword">return</span> _syscall3(SYS_READ, fd, buf, count);<br>&#125;<br><br><span class="hljs-comment">/* 输出一个字符 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">putchar</span><span class="hljs-params">(<span class="hljs-type">char</span> char_asci)</span> &#123;<br>   _syscall1(SYS_PUTCHAR, char_asci);<br>&#125;<br><br><span class="hljs-comment">/* 清空屏幕 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>   _syscall0(SYS_CLEAR);<br>&#125;<br><br><span class="hljs-comment">/* 获取当前工作目录 */</span><br><span class="hljs-type">char</span>* <span class="hljs-title function_">getcwd</span><span class="hljs-params">(<span class="hljs-type">char</span>* buf, <span class="hljs-type">uint32_t</span> size)</span> &#123;<br>   <span class="hljs-keyword">return</span> (<span class="hljs-type">char</span>*)_syscall2(SYS_GETCWD, buf, size);<br>&#125;<br><br><span class="hljs-comment">/* 以flag方式打开文件pathname */</span><br><span class="hljs-type">int32_t</span> <span class="hljs-title function_">open</span><span class="hljs-params">(<span class="hljs-type">char</span>* pathname, <span class="hljs-type">uint8_t</span> flag)</span> &#123;<br>   <span class="hljs-keyword">return</span> _syscall2(SYS_OPEN, pathname, flag);<br>&#125;<br><br><span class="hljs-comment">/* 关闭文件fd */</span><br><span class="hljs-type">int32_t</span> <span class="hljs-title function_">close</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> fd)</span> &#123;<br>   <span class="hljs-keyword">return</span> _syscall1(SYS_CLOSE, fd);<br>&#125;<br><br><span class="hljs-comment">/* 设置文件偏移量 */</span><br><span class="hljs-type">int32_t</span> <span class="hljs-title function_">lseek</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> fd, <span class="hljs-type">int32_t</span> offset, <span class="hljs-type">uint8_t</span> whence)</span> &#123;<br>   <span class="hljs-keyword">return</span> _syscall3(SYS_LSEEK, fd, offset, whence);<br>&#125;<br><br><span class="hljs-comment">/* 删除文件pathname */</span><br><span class="hljs-type">int32_t</span> <span class="hljs-title function_">unlink</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* pathname)</span> &#123;<br>   <span class="hljs-keyword">return</span> _syscall1(SYS_UNLINK, pathname);<br>&#125;<br><br><span class="hljs-comment">/* 创建目录pathname */</span><br><span class="hljs-type">int32_t</span> <span class="hljs-title function_">mkdir</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* pathname)</span> &#123;<br>   <span class="hljs-keyword">return</span> _syscall1(SYS_MKDIR, pathname);<br>&#125;<br><br><span class="hljs-comment">/* 打开目录name */</span><br><span class="hljs-keyword">struct</span> dir* <span class="hljs-title function_">opendir</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* name)</span> &#123;<br>   <span class="hljs-keyword">return</span> (<span class="hljs-keyword">struct</span> dir*)_syscall1(SYS_OPENDIR, name);<br>&#125;<br><br><span class="hljs-comment">/* 关闭目录dir */</span><br><span class="hljs-type">int32_t</span> <span class="hljs-title function_">closedir</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dir* dir)</span> &#123;<br>   <span class="hljs-keyword">return</span> _syscall1(SYS_CLOSEDIR, dir);<br>&#125;<br><br><span class="hljs-comment">/* 删除目录pathname */</span><br><span class="hljs-type">int32_t</span> <span class="hljs-title function_">rmdir</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* pathname)</span> &#123;<br>   <span class="hljs-keyword">return</span> _syscall1(SYS_RMDIR, pathname);<br>&#125;<br><br><span class="hljs-comment">/* 读取目录dir */</span><br><span class="hljs-keyword">struct</span> dir_entry* <span class="hljs-title function_">readdir</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dir* dir)</span> &#123;<br>   <span class="hljs-keyword">return</span> (<span class="hljs-keyword">struct</span> dir_entry*)_syscall1(SYS_READDIR, dir);<br>&#125;<br><br><span class="hljs-comment">/* 回归目录指针 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">rewinddir</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dir* dir)</span> &#123;<br>   _syscall1(SYS_REWINDDIR, dir);<br>&#125;<br><br><span class="hljs-comment">/* 获取path属性到buf中 */</span><br><span class="hljs-type">int32_t</span> <span class="hljs-title function_">stat</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-keyword">struct</span> stat* buf)</span> &#123;<br>   <span class="hljs-keyword">return</span> _syscall2(SYS_STAT, path, buf);<br>&#125;<br><br><span class="hljs-comment">/* 改变工作目录为path */</span><br><span class="hljs-type">int32_t</span> <span class="hljs-title function_">chdir</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path)</span> &#123;<br>   <span class="hljs-keyword">return</span> _syscall1(SYS_CHDIR, path);<br>&#125;<br><br><span class="hljs-comment">/* 显示任务列表 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">ps</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>   _syscall0(SYS_PS);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="userprogsyscall-initc修改"><a class="markdownIt-Anchor" href="#userprogsyscall-initc修改"></a> userprog/syscall-init.c修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;syscall-init.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../lib/user/syscall.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;interrupt.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../thread/thread.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../kernel/memory.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../fs/fs.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;fork.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../device/console.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> syscall_nr 32 </span><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span>* syscall;<br>syscall syscall_table[syscall_nr];<br><br><span class="hljs-comment">/* 返回当前任务的pid */</span><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">sys_getpid</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> <br>&#123;<br>   	<span class="hljs-keyword">return</span> running_thread()-&gt;pid;<br>&#125;<br><br><br><span class="hljs-comment">/* 初始化系统调用 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">syscall_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>   put_str(<span class="hljs-string">&quot;syscall_init start\n&quot;</span>);<br>   syscall_table[SYS_GETPID]	= sys_getpid;<br>   syscall_table[SYS_WRITE]	    = sys_write;<br>   syscall_table[SYS_MALLOC]	= sys_malloc;<br>   syscall_table[SYS_FREE]	    = sys_free;<br>   syscall_table[SYS_FORK]	    = sys_fork;<br>   syscall_table[SYS_READ]	    = sys_read;<br>   syscall_table[SYS_PUTCHAR]	= console_put_char;<br>   syscall_table[SYS_CLEAR]	    = cls_screen;<br>   syscall_table[SYS_GETCWD]	= sys_getcwd;<br>   syscall_table[SYS_OPEN]	    = sys_open;<br>   syscall_table[SYS_CLOSE]	    = sys_close;<br>   syscall_table[SYS_LSEEK]	    = sys_lseek;<br>   syscall_table[SYS_UNLINK]	= sys_unlink;<br>   syscall_table[SYS_MKDIR]	    = sys_mkdir;<br>   syscall_table[SYS_OPENDIR]	= sys_opendir;<br>   syscall_table[SYS_CLOSEDIR]	= sys_closedir;<br>   syscall_table[SYS_CHDIR]	    = sys_chdir;<br>   syscall_table[SYS_RMDIR]	    = sys_rmdir;<br>   syscall_table[SYS_READDIR]	= sys_readdir;<br>   syscall_table[SYS_REWINDDIR]	= sys_rewinddir;<br>   syscall_table[SYS_STAT]	    = sys_stat;<br>   syscall_table[SYS_PS]	    = sys_ps;<br><br>   put_str(<span class="hljs-string">&quot;syscall_init done\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="threadthreadc新增"><a class="markdownIt-Anchor" href="#threadthreadc新增"></a> thread/thread.c新增</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">pad_print</span><span class="hljs-params">(<span class="hljs-type">char</span>* buf,<span class="hljs-type">int32_t</span> buf_len,<span class="hljs-type">void</span>* ptr,<span class="hljs-type">char</span> format)</span><br>&#123;<br>    <span class="hljs-built_in">memset</span>(buf,<span class="hljs-number">0</span>,buf_len);<br>    <span class="hljs-type">uint8_t</span> out_pad_0idx = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">switch</span>(format)<br>    &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;s&#x27;</span>:<br>            out_pad_0idx = <span class="hljs-built_in">sprintf</span>(buf,<span class="hljs-string">&quot;%s&quot;</span>,ptr);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;d&#x27;</span>:<br>            out_pad_0idx = <span class="hljs-built_in">sprintf</span>(buf,<span class="hljs-string">&quot;%d&quot;</span>,*((<span class="hljs-type">int16_t</span>*)ptr));<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;x&#x27;</span>:<br>            out_pad_0idx = <span class="hljs-built_in">sprintf</span>(buf,<span class="hljs-string">&quot;%x&quot;</span>,*((<span class="hljs-type">uint32_t</span>*)ptr));   <br>    &#125;<br>    <span class="hljs-keyword">while</span>(out_pad_0idx &lt; buf_len)<br>    &#123;<br>        buf[out_pad_0idx] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        out_pad_0idx++;<br>    &#125;<br>    sys_write(stdout_no,buf,buf_len<span class="hljs-number">-1</span>);<br>&#125;<br><br><br><span class="hljs-type">bool</span> <span class="hljs-title function_">elem2thread_info</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> list_elem* pelem,<span class="hljs-type">int</span> arg)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span>* <span class="hljs-title">pthread</span> =</span> elem2entry(<span class="hljs-keyword">struct</span> task_struct,all_list_tag,pelem);<br>    <span class="hljs-type">char</span> out_pad[<span class="hljs-number">16</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    pad_print(out_pad,<span class="hljs-number">16</span>,&amp;pthread-&gt;pid,<span class="hljs-string">&#x27;d&#x27;</span>);<br>    <br>    <span class="hljs-keyword">if</span>(pthread-&gt;parent_pid == <span class="hljs-number">-1</span>)<br>    	pad_print(out_pad,<span class="hljs-number">16</span>,<span class="hljs-string">&quot;NULL&quot;</span>,<span class="hljs-string">&#x27;s&#x27;</span>);<br>    <span class="hljs-keyword">else</span><br>        pad_print(out_pad,<span class="hljs-number">16</span>,&amp;pthread-&gt;parent_pid,<span class="hljs-string">&#x27;d&#x27;</span>);<br>        <br>    <span class="hljs-keyword">switch</span>(pthread-&gt;status)<br>    &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>            pad_print(out_pad,<span class="hljs-number">16</span>,<span class="hljs-string">&quot;RUNNING&quot;</span>,<span class="hljs-string">&#x27;s&#x27;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>            pad_print(out_pad,<span class="hljs-number">16</span>,<span class="hljs-string">&quot;READY&quot;</span>,<span class="hljs-string">&#x27;s&#x27;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>            pad_print(out_pad,<span class="hljs-number">16</span>,<span class="hljs-string">&quot;BLOCKED&quot;</span>,<span class="hljs-string">&#x27;s&#x27;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>            pad_print(out_pad,<span class="hljs-number">16</span>,<span class="hljs-string">&quot;WAITING&quot;</span>,<span class="hljs-string">&#x27;s&#x27;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>            pad_print(out_pad,<span class="hljs-number">16</span>,<span class="hljs-string">&quot;HANGING&quot;</span>,<span class="hljs-string">&#x27;s&#x27;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:<br>            pad_print(out_pad,<span class="hljs-number">16</span>,<span class="hljs-string">&quot;DIED&quot;</span>,<span class="hljs-string">&#x27;s&#x27;</span>);<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>    pad_print(out_pad,<span class="hljs-number">16</span>,&amp;pthread-&gt;elapsed_ticks,<span class="hljs-string">&#x27;x&#x27;</span>);<br>    <br>    <span class="hljs-built_in">memset</span>(out_pad,<span class="hljs-number">0</span>,<span class="hljs-number">16</span>);<br>    ASSERT(<span class="hljs-built_in">strlen</span>(pthread-&gt;name) &lt; <span class="hljs-number">17</span>);<br>    <span class="hljs-built_in">memcpy</span>(out_pad,pthread-&gt;name,<span class="hljs-built_in">strlen</span>(pthread-&gt;name));<br>    <span class="hljs-built_in">strcat</span>(out_pad,<span class="hljs-string">&quot;\n&quot;</span>);<br>    sys_write(stdout_no,out_pad,<span class="hljs-built_in">strlen</span>(out_pad));<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><br><span class="hljs-comment">//打印任务列表</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">sys_ps</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span>* ps_title = <span class="hljs-string">&quot;PID             PPID            STAT             TICKS            COMMAND\n&quot;</span>;<br>    sys_write(stdout_no,ps_title,<span class="hljs-built_in">strlen</span>(ps_title));<br>    list_traversal(&amp;thread_all_list,elem2thread_info,<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="shellbuildin_cmdh创建"><a class="markdownIt-Anchor" href="#shellbuildin_cmdh创建"></a> shell/buildin_cmd.h创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __SHELL_BUILDIN_CMD_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __SHELL_BUILDIN_CMD_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">wash_path</span><span class="hljs-params">(<span class="hljs-type">char</span>* old_abs_path,<span class="hljs-type">char</span>* new_abs_path)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">make_clear_abs_path</span><span class="hljs-params">(<span class="hljs-type">char</span>* path,<span class="hljs-type">char</span>* final_path)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">buildin_pwd</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> argc,<span class="hljs-type">char</span>** argv)</span>;<br><span class="hljs-type">char</span>* <span class="hljs-title function_">buildin_cd</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> argc,<span class="hljs-type">char</span>** argv)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">buildin_ls</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> argc,<span class="hljs-type">char</span>** argv)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">buildin_ps</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> argc,<span class="hljs-type">char</span>** argv)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">buildin_clear</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> argc,<span class="hljs-type">char</span>** argv)</span>;<br><span class="hljs-type">int32_t</span> <span class="hljs-title function_">buildin_mkdir</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> argc,<span class="hljs-type">char</span>** argv)</span>;<br><span class="hljs-type">int32_t</span> <span class="hljs-title function_">buildin_rmdir</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> argc,<span class="hljs-type">char</span>** argv)</span>;<br><span class="hljs-type">int32_t</span> <span class="hljs-title function_">buildin_rm</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> argc,<span class="hljs-type">char</span>** argv)</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
<h3 id="shellbuildin_cmdc创建"><a class="markdownIt-Anchor" href="#shellbuildin_cmdc创建"></a> shell/buildin_cmd.c创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;buildin_cmd.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../fs/file.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../fs/fs.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;debug.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;string.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;syscall.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdio-kernel.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../fs/dir.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../fs/fs.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdio.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;shell.h&quot;</span></span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-type">char</span> final_path[<span class="hljs-number">160</span>];<br><br><span class="hljs-comment">//在用户态就把路径给解析出来</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">wash_path</span><span class="hljs-params">(<span class="hljs-type">char</span>* old_abs_path,<span class="hljs-type">char</span>* new_abs_path)</span><br>&#123;<br>    ASSERT(old_abs_path[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;/&#x27;</span>);<br>    <span class="hljs-type">char</span> name[MAX_FILE_NAME_LEN] = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-type">char</span>* sub_path = old_abs_path;<br>    sub_path = path_parse(sub_path,name);<br>    <br>    <span class="hljs-comment">//如果直接就是根目录 直接返回即可</span><br>    <span class="hljs-keyword">if</span>(name[<span class="hljs-number">0</span>] == <span class="hljs-number">0</span>)<br>    &#123;<br>        new_abs_path[<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;/&#x27;</span>;<br>        new_abs_path[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    new_abs_path[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>; <br>    <span class="hljs-built_in">strcat</span>(new_abs_path,<span class="hljs-string">&quot;/&quot;</span>);<br>    <span class="hljs-keyword">while</span>(name[<span class="hljs-number">0</span>])<br>    &#123;<br>        <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;..&quot;</span>,name))   <span class="hljs-comment">//返回上级</span><br>        &#123;<br>            <span class="hljs-type">char</span>* slash_ptr = <span class="hljs-built_in">strrchr</span>(new_abs_path,<span class="hljs-string">&#x27;/&#x27;</span>); <span class="hljs-comment">//等于移动到最偏右的/位置去</span><br>            <span class="hljs-keyword">if</span>(slash_ptr != new_abs_path)   <span class="hljs-comment">//如果为 /aaa 那么移动之后就到/的位置了 如果是/aaa/bbb 那么就会回到/aaa/</span><br>                *slash_ptr = <span class="hljs-number">0</span>; <span class="hljs-comment">// 把/变成0</span><br>            <span class="hljs-keyword">else</span><br>	        *(slash_ptr+<span class="hljs-number">1</span>) = <span class="hljs-number">0</span>; <span class="hljs-comment">// 如果是 / 或者 /aaa 那么都回到/ 则把最右边+1置零位即可</span><br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;.&quot;</span>,name))  <span class="hljs-comment">//如果不是到. 增加到后米纳即可 .等于没有作用 继续遍历即可</span><br>        &#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(new_abs_path,<span class="hljs-string">&quot;/&quot;</span>))  <span class="hljs-comment">//不是 / 防止出现// 的情况</span><br>                <span class="hljs-built_in">strcat</span>(new_abs_path,<span class="hljs-string">&quot;/&quot;</span>);<br>            <span class="hljs-built_in">strcat</span>(new_abs_path,name);<br>        &#125;<br>        <br>        <span class="hljs-built_in">memset</span>(name,<span class="hljs-number">0</span>,MAX_FILE_NAME_LEN);<br>        <span class="hljs-keyword">if</span>(sub_path)<br>            sub_path = path_parse(sub_path,name);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//把path处理 . ..去掉 储存在final_path getcwd得到当前工作目录 + 相对路径 即绝对路径</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">make_clear_abs_path</span><span class="hljs-params">(<span class="hljs-type">char</span>* path,<span class="hljs-type">char</span>* final_path)</span><br>&#123;<br>    <span class="hljs-type">char</span> abs_path[MAX_PATH_LEN] = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-keyword">if</span>(path[<span class="hljs-number">0</span>] != <span class="hljs-string">&#x27;/&#x27;</span>)  <span class="hljs-comment">//如果不是绝对路径就弄成绝对路径</span><br>    &#123;<br>        <span class="hljs-built_in">memset</span>(abs_path,<span class="hljs-number">0</span>,MAX_PATH_LEN);<br>        <span class="hljs-keyword">if</span>(getcwd(abs_path,MAX_PATH_LEN) != <span class="hljs-literal">NULL</span>)<br>        &#123;<br>            <span class="hljs-keyword">if</span>(!((abs_path[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;/&#x27;</span>) &amp;&amp; abs_path[<span class="hljs-number">1</span>] == <span class="hljs-number">0</span>))<br>                <span class="hljs-built_in">strcat</span>(abs_path,<span class="hljs-string">&quot;/&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//把path 加到工作目录的头上</span><br>    <span class="hljs-built_in">strcat</span>(abs_path,path);<br>    wash_path(abs_path,final_path);<br>&#125;<br><br><span class="hljs-comment">// pwd命令中的内建函数 得到当前工作目录</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">buildin_pwd</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> argc,<span class="hljs-type">char</span>** argv)</span><br>&#123;<br>    <span class="hljs-comment">//没有参数才可以</span><br>    <span class="hljs-keyword">if</span>(argc != <span class="hljs-number">1</span>)<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;pwd: no argument support!\n&quot;</span>);<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-keyword">if</span>(getcwd(final_path,MAX_PATH_LEN) != <span class="hljs-literal">NULL</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>,final_path);<br>        <span class="hljs-keyword">else</span><br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;pwd: get current work directory failed\n&quot;</span>);<br>    &#125;   <br>&#125;<br><br><span class="hljs-comment">// 支持一个参数 改变当前工作目录</span><br><span class="hljs-type">char</span>* <span class="hljs-title function_">buildin_cd</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> argc,<span class="hljs-type">char</span>** argv)</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(argc &gt; <span class="hljs-number">2</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;cd: only support 1 argument!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(argc == <span class="hljs-number">1</span>)<br>    &#123;<br>        final_path[<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;/&#x27;</span>;<br>        final_path[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span>    make_clear_abs_path(argv[<span class="hljs-number">1</span>],final_path);<br>    <br>    <span class="hljs-keyword">if</span>(chdir(final_path) == <span class="hljs-number">-1</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;cd: no such directory %s\n&quot;</span>,final_path);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> final_path;   <br>&#125;<br><br><span class="hljs-comment">// ls内建函数 仅支持-l -h -h等于不支持 哈哈</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">buildin_ls</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> argc,<span class="hljs-type">char</span>** argv)</span><br>&#123;<br>    <span class="hljs-type">char</span>* pathname = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">file_stat</span>;</span><br>    <span class="hljs-built_in">memset</span>(&amp;file_stat,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> stat));<br>    <span class="hljs-type">bool</span> long_info = <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">uint32_t</span> arg_path_nr = <span class="hljs-number">0</span>;  <br>    <span class="hljs-type">uint32_t</span> arg_idx = <span class="hljs-number">1</span>;    <span class="hljs-comment">//第一个字符串是 ls 跳过</span><br>    <span class="hljs-keyword">while</span>(arg_idx &lt; argc)    <span class="hljs-comment">//仅仅支持 ls 或者 ls -l 或者 ls -l path的形式</span><br>    &#123;<br>        <span class="hljs-keyword">if</span>(argv[arg_idx][<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;-&#x27;</span>)<br>        &#123;<br>            <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;-l&quot;</span>,argv[arg_idx]))<br>                long_info = <span class="hljs-literal">true</span>;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;-h&quot;</span>,argv[arg_idx]))<br>            &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;usage: -l list all all information about the file.\nnot support -h now sry - -\n&quot;</span>);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ls: invaild option %s\nTry &#x27;ls -l&#x27; u can get what u want\n&quot;</span>,argv[arg_idx]);<br>                <span class="hljs-keyword">return</span>; <br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-keyword">if</span>(arg_path_nr == <span class="hljs-number">0</span>)<br>            &#123;<br>                pathname = argv[arg_idx];<br>                arg_path_nr = <span class="hljs-number">1</span>;<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ls: only support one path\n&quot;</span>);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125;<br>        ++arg_idx;<br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span>(pathname == <span class="hljs-literal">NULL</span>) <span class="hljs-comment">//ls 或者 ls -l</span><br>    &#123;<br>        <span class="hljs-comment">//得到工作目录</span><br>        <span class="hljs-keyword">if</span>(getcwd(final_path,MAX_PATH_LEN) != <span class="hljs-literal">NULL</span>)<br>	    pathname = final_path;<br>	<span class="hljs-keyword">else</span><br>	&#123;<br>	    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ls: getcwd for default path failed\n&quot;</span>);<br>	    <span class="hljs-keyword">return</span>;<br>	&#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        make_clear_abs_path(pathname,final_path);<br>        pathname = final_path;<br>    &#125;<br>    <br>    <span class="hljs-comment">//目录下的文件</span><br>    <span class="hljs-keyword">if</span>(stat(pathname,&amp;file_stat) == <span class="hljs-number">-1</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ls: cannot access %s: No such file or directory\n&quot;</span>,pathname);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span>(file_stat.st_filetype == FT_DIRECTORY)  <span class="hljs-comment">//得到目录文件才继续</span><br>    &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dir</span>* <span class="hljs-title">dir</span> =</span> opendir(pathname); <span class="hljs-comment">//得到目录指针</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dir_entry</span>* <span class="hljs-title">dir_e</span> =</span> <span class="hljs-literal">NULL</span>;<br>        <span class="hljs-type">char</span> sub_pathname[MAX_PATH_LEN] = &#123;<span class="hljs-number">0</span>&#125;;<br>        <span class="hljs-type">uint32_t</span> pathname_len   = <span class="hljs-built_in">strlen</span>(pathname);<br>        <span class="hljs-type">uint32_t</span> last_char_idx  = pathname_len - <span class="hljs-number">1</span>;<br>        <span class="hljs-built_in">memcpy</span>(sub_pathname,pathname,pathname_len);<br>        <br>        <span class="hljs-comment">//方便后面得到当前目录下的文件stat信息 </span><br>        <span class="hljs-comment">//加个/ 之后每个文件加文件名stat即可</span><br>        <span class="hljs-keyword">if</span>(sub_pathname[last_char_idx] != <span class="hljs-string">&#x27;/&#x27;</span>) <br>        &#123;<br>            sub_pathname[pathname_len] = <span class="hljs-string">&#x27;/&#x27;</span>; <br>            ++pathname_len;<br>        &#125;<br>        <br>        rewinddir(dir);  <span class="hljs-comment">//目录指针指向0  方便readdir遍历目录项</span><br>        <span class="hljs-keyword">if</span>(long_info)    <span class="hljs-comment">// ls -l 这里是目录的ls</span><br>        &#123;<br>            <span class="hljs-type">char</span> ftype;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;total: %d\n&quot;</span>,file_stat.st_size);<br>            <span class="hljs-keyword">while</span>((dir_e = readdir(dir)))    <span class="hljs-comment">//通过readdir来遍历目录项 我还专门回去看了看这个函数</span><br>            &#123;<br>                ftype = <span class="hljs-string">&#x27;d&#x27;</span>;<br>                <span class="hljs-keyword">if</span>(dir_e-&gt;f_type == FT_REGULAR)<br>                    ftype = <span class="hljs-string">&#x27;-&#x27;</span>;<br>                sub_pathname[pathname_len] = <span class="hljs-number">0</span>; <span class="hljs-comment">//把字符串末尾设0 方便strcat函数</span><br>                <span class="hljs-built_in">strcat</span>(sub_pathname,dir_e-&gt;filename);<br>                <span class="hljs-built_in">memset</span>(&amp;file_stat,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> stat));<br>                <span class="hljs-keyword">if</span>(stat(sub_pathname,&amp;file_stat) == <span class="hljs-number">-1</span>)<br>                &#123;<br>                    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ls: cannot access %s:No such file or directory\n&quot;</span>,dir_e-&gt;filename);<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%c    %d    %d    %s\n&quot;</span>,ftype,dir_e-&gt;i_no,file_stat.st_size,dir_e-&gt;filename);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span>  <span class="hljs-comment">//仅仅是ls 把文件名写出来即可</span><br>        &#123;<br>            <span class="hljs-keyword">while</span>((dir_e = readdir(dir)))<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s  &quot;</span>,dir_e-&gt;filename);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>        &#125;<br>        closedir(dir);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-keyword">if</span>(long_info)<br>             <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;-    %d    %d    %s\n&quot;</span>,file_stat.st_ino,file_stat.st_size,pathname);<br>	<span class="hljs-keyword">else</span><br>	    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>,pathname);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">buildin_ps</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> argc,<span class="hljs-type">char</span>** argv)</span><br>&#123;<br>     <span class="hljs-comment">//不应该有参数</span><br>    <span class="hljs-keyword">if</span>(argc != <span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ps: no argument support!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    ps();<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">buildin_clear</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> argc,<span class="hljs-type">char</span>** argv)</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(argc != <span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;clear: no argument support!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    clear();<br>&#125;<br><br><span class="hljs-type">int32_t</span> <span class="hljs-title function_">buildin_mkdir</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> argc,<span class="hljs-type">char</span>** argv)</span><br>&#123;<br>    <span class="hljs-comment">//必须要有一个 安装路径参数</span><br>    <span class="hljs-type">int32_t</span> ret = <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">if</span>(argc != <span class="hljs-number">2</span>)<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;mkdir: only support 1 argument!\n&quot;</span>);<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        make_clear_abs_path(argv[<span class="hljs-number">1</span>],final_path);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;/&quot;</span>,final_path))  <span class="hljs-comment">//不是根目录 根目录一直都在</span><br>        &#123;<br>            <span class="hljs-keyword">if</span>(mkdir(final_path) == <span class="hljs-number">0</span>)<br>                ret = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">else</span><br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;mkdir: create directory %s failed.\n&quot;</span>,argv[<span class="hljs-number">1</span>]);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">int32_t</span> <span class="hljs-title function_">buildin_rmdir</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> argc,<span class="hljs-type">char</span>** argv)</span><br>&#123;<br>    <span class="hljs-type">int32_t</span> ret = <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">if</span>(argc != <span class="hljs-number">2</span>)<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;rmdir: only support 1 argument!\n&quot;</span>);<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        make_clear_abs_path(argv[<span class="hljs-number">1</span>],final_path);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;/&quot;</span>,final_path)) <span class="hljs-comment">// 不能删除根目录</span><br>        &#123;<br>            <span class="hljs-keyword">if</span>(rmdir(final_path) == <span class="hljs-number">0</span>)<br>                ret = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">else</span>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;rmdir: remove %s failed\n&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">int32_t</span> <span class="hljs-title function_">buildin_rm</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> argc,<span class="hljs-type">char</span>** argv)</span><br>&#123;<br>    <span class="hljs-type">int32_t</span> ret = <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">if</span>(argc != <span class="hljs-number">2</span>)<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;rm: only support 1 argument!\n&quot;</span>);<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        make_clear_abs_path(argv[<span class="hljs-number">1</span>],final_path);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;/&quot;</span>,final_path))<br>        &#123;<br>            <span class="hljs-keyword">if</span>(unlink(final_path) == <span class="hljs-number">0</span>)<br>                ret = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">else</span>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;rm: delete %s failed\n&quot;</span>,argv[<span class="hljs-number">1</span>]); <br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="libuserasserth创建"><a class="markdownIt-Anchor" href="#libuserasserth创建"></a> lib/user/assert.h创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __LIB_USER_ASSERT_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LIB_USER_ASSERT_H</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NULL ((void*)0)</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">user_spin</span><span class="hljs-params">(<span class="hljs-type">char</span>* filename, <span class="hljs-type">int</span> line, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* func, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* condition)</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> panic(...) user_spin(__FILE__, __LINE__, __func__, __VA_ARGS__)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> NDEBUG</span><br>   <span class="hljs-meta">#<span class="hljs-keyword">define</span> assert(CONDITION) ((void)0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>   <span class="hljs-meta">#<span class="hljs-keyword">define</span> assert(CONDITION)  \</span><br><span class="hljs-meta">      <span class="hljs-keyword">if</span> (!(CONDITION)) &#123;     \</span><br><span class="hljs-meta">	 panic(#CONDITION);   \</span><br><span class="hljs-meta">      &#125;    </span><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span><span class="hljs-comment">/*NDEBUG*/</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span><span class="hljs-comment">/*__LIB_USER_ASSERT_H*/</span></span><br></code></pre></td></tr></table></figure>
<h3 id="libuserassertc创建"><a class="markdownIt-Anchor" href="#libuserassertc创建"></a> lib/user/assert.c创建</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;assert.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdio.h&quot;</span></span><br><span class="hljs-type">void</span> <span class="hljs-title function_">user_spin</span><span class="hljs-params">(<span class="hljs-type">char</span>* filename, <span class="hljs-type">int</span> line, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* func, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* condition)</span> &#123;<br>   <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n\n\n\nfilename %s\nline %d\nfunction %s\ncondition %s\n&quot;</span>, filename, line, func, condition);<br>   <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="kernelmainc修改"><a class="markdownIt-Anchor" href="#kernelmainc修改"></a> kernel/main.c修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;init.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;debug.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;string.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;memory.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../thread/thread.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;interrupt.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../device/console.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../device/ioqueue.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../device/keyboard.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../userprog/process.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../lib/user/syscall.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../userprog/syscall-init.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../lib/stdio.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../lib/kernel/stdio-kernel.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../fs/fs.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../fs/file.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../shell/shell.h&quot;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>   put_str(<span class="hljs-string">&quot;I am kernel\n&quot;</span>);<br>   init_all();<br>   intr_enable();<br>	cls_screen();<br>	console_put_str(<span class="hljs-string">&quot;[rabbit@localhost /]$ &quot;</span>);<br>	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/* init进程 */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>   <span class="hljs-type">uint32_t</span> ret_pid = fork();<br>   <span class="hljs-keyword">if</span>(ret_pid) &#123;  <span class="hljs-comment">// 父进程</span><br>       <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br>   &#125; <span class="hljs-keyword">else</span> &#123;	  <span class="hljs-comment">// 子进程</span><br>      my_shell();<br>   &#125;<br>   PANIC(<span class="hljs-string">&quot;init: should not be here&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="makefile修改"><a class="markdownIt-Anchor" href="#makefile修改"></a> makefile修改</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><code class="hljs c">BUILD_DIR = ./build<br>ENTRY_POINT = <span class="hljs-number">0xc0001500</span><br>AS = nasm<br>CC = gcc<br>LD = ld<br>LIB = -I lib/ -I lib/kernel/ -I lib/user/ -I kernel/ -I device/ <br>ASFLAGS = -f elf<br>CFLAGS = -Wall -m32 -fno-<span class="hljs-built_in">stack</span>-protector $(LIB) -c -fno-builtin -W -Wstrict-prototypes -Wmissing-prototypes<br>LDFLAGS =  -m elf_i386 -Ttext $(ENTRY_POINT) -e main -Map $(BUILD_DIR)/kernel.<span class="hljs-built_in">map</span><br>OBJS = $(BUILD_DIR)/main.o $(BUILD_DIR)/init.o $(BUILD_DIR)/interrupt.o \<br>      $(BUILD_DIR)/timer.o $(BUILD_DIR)/kernel.o $(BUILD_DIR)/print.o $(BUILD_DIR)/<span class="hljs-keyword">switch</span>.o \<br>      $(BUILD_DIR)/debug.o $(BUILD_DIR)/<span class="hljs-built_in">string</span>.o $(BUILD_DIR)/memory.o \<br>      $(BUILD_DIR)/bitmap.o $(BUILD_DIR)/thread.o $(BUILD_DIR)/<span class="hljs-built_in">list</span>.o \<br>      $(BUILD_DIR)/sync.o $(BUILD_DIR)/console.o $(BUILD_DIR)/keyboard.o \<br>      $(BUILD_DIR)/ioqueue.o $(BUILD_DIR)/tss.o $(BUILD_DIR)/process.o \<br>      $(BUILD_DIR)/syscall-init.o $(BUILD_DIR)/syscall.o $(BUILD_DIR)/stdio.o \<br>      $(BUILD_DIR)/stdio-kernel.o $(BUILD_DIR)/ide.o $(BUILD_DIR)/fs.o $(BUILD_DIR)/inode.o \<br>      $(BUILD_DIR)/file.o $(BUILD_DIR)/dir.o $(BUILD_DIR)/fork.o $(BUILD_DIR)/shell.o \<br>      $(BUILD_DIR)/buildin_cmd.o<br>      <br>#############<span class="hljs-meta">#     c代码编译     ###############</span><br>$(BUILD_DIR)/main.o: kernel/main.c lib/kernel/print.h \<br>        lib/stdint.h kernel/init.h lib/<span class="hljs-built_in">string</span>.h kernel/memory.h \<br>        thread/thread.h kernel/interrupt.h device/console.h \<br>        device/keyboard.h device/ioqueue.h userprog/process.h \<br>        lib/user/syscall.h userprog/syscall-init.h lib/stdio.h \<br>        lib/kernel/stdio-kernel.h fs/file.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br><br>$(BUILD_DIR)/init.o: kernel/init.c kernel/init.h lib/kernel/print.h \<br>        lib/stdint.h kernel/interrupt.h device/timer.h kernel/memory.h \<br>        thread/thread.h device/console.h device/keyboard.h userprog/tss.h \<br>        userprog/syscall-init.h device/ide.h fs/fs.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br><br>$(BUILD_DIR)/interrupt.o: kernel/interrupt.c kernel/interrupt.h \<br>        lib/stdint.h kernel/global.h lib/kernel/io.h lib/kernel/print.h \<br>        kernel/kernel.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br><br>$(BUILD_DIR)/timer.o: device/timer.c device/timer.h lib/kernel/io.h lib/kernel/print.h \<br>        kernel/interrupt.h thread/thread.h kernel/debug.h kernel/global.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br><br>$(BUILD_DIR)/debug.o: kernel/debug.c kernel/debug.h \<br>        lib/kernel/print.h lib/stdint.h kernel/interrupt.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br>	<br>$(BUILD_DIR)/<span class="hljs-built_in">string</span>.o: lib/<span class="hljs-built_in">string</span>.c lib/<span class="hljs-built_in">string</span>.h \<br>	kernel/debug.h kernel/global.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br>	<br>$(BUILD_DIR)/memory.o: kernel/memory.c kernel/memory.h \<br>	lib/stdint.h lib/kernel/bitmap.h kernel/debug.h lib/<span class="hljs-built_in">string</span>.h kernel/global.h \<br>	thread/sync.h thread/thread.h lib/kernel/<span class="hljs-built_in">list</span>.h kernel/interrupt.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br>	<br>$(BUILD_DIR)/bitmap.o: lib/kernel/bitmap.c lib/kernel/bitmap.h kernel/global.h \<br>	lib/<span class="hljs-built_in">string</span>.h kernel/interrupt.h lib/kernel/print.h kernel/debug.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br>	<br>$(BUILD_DIR)/thread.o: thread/thread.c thread/thread.h \<br>	lib/stdint.h lib/<span class="hljs-built_in">string</span>.h kernel/global.h kernel/memory.h \<br>	kernel/debug.h kernel/interrupt.h lib/kernel/print.h \<br>	userprog/process.h thread/sync.h lib/user/syscall.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br>	<br>$(BUILD_DIR)/<span class="hljs-built_in">list</span>.o: lib/kernel/<span class="hljs-built_in">list</span>.c lib/kernel/<span class="hljs-built_in">list</span>.h \<br>	kernel/interrupt.h lib/stdint.h kernel/debug.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br>	<br>$(BUILD_DIR)/sync.o: thread/sync.c thread/sync.h \<br>	lib/stdint.h thread/thread.h kernel/debug.h kernel/interrupt.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br>	<br>$(BUILD_DIR)/console.o: device/console.c device/console.h \<br>	lib/kernel/print.h thread/sync.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br>	<br>$(BUILD_DIR)/keyboard.o: device/keyboard.c device/keyboard.h \<br>	lib/kernel/print.h lib/kernel/io.h kernel/interrupt.h \<br>	kernel/global.h lib/stdint.h device/ioqueue.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br>	<br>$(BUILD_DIR)/ioqueue.o: device/ioqueue.c device/ioqueue.h \<br>	kernel/interrupt.h kernel/global.h kernel/debug.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br>	<br>$(BUILD_DIR)/tss.o: userprog/tss.c userprog/tss.h \<br>	kernel/global.h thread/thread.h lib/kernel/print.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br>	<br>$(BUILD_DIR)/process.o: userprog/process.c userprog/process.h \<br>	lib/<span class="hljs-built_in">string</span>.h kernel/global.h kernel/memory.h lib/kernel/print.h \<br>	thread/thread.h kernel/interrupt.h kernel/debug.h device/console.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br>	<br>$(BUILD_DIR)/syscall-init.o: userprog/syscall-init.c userprog/syscall-init.h \<br>	lib/user/syscall.h lib/stdint.h lib/kernel/print.h kernel/interrupt.h thread/thread.h \<br>	kernel/memory.h fs/file.h userprog/fork.h lib/kernel/stdio-kernel.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br>	<br>$(BUILD_DIR)/syscall.o: lib/user/syscall.c lib/user/syscall.h fs/file.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br><br>$(BUILD_DIR)/stdio.o: lib/stdio.c lib/stdio.h lib/stdint.h lib/<span class="hljs-built_in">string</span>.h lib/user/syscall.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br><br>$(BUILD_DIR)/stdio-kernel.o: lib/kernel/stdio-kernel.c lib/kernel/stdio-kernel.h \<br>	lib/stdio.h device/console.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br>	<br>$(BUILD_DIR)/ide.o: device/ide.c device/ide.h lib/stdint.h kernel/debug.h \<br>	lib/kernel/stdio-kernel.h lib/stdio.h kernel/global.h thread/sync.h \<br>	lib/kernel/io.h device/timer.h kernel/interrupt.h lib/kernel/<span class="hljs-built_in">list</span>.h fs/fs.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br>	<br>$(BUILD_DIR)/fs.o: fs/fs.c fs/fs.h lib/stdint.h kernel/global.h device/ide.h fs/inode.h fs/dir.h \<br>	fs/super_block.h lib/kernel/stdio-kernel.h lib/<span class="hljs-built_in">string</span>.h kernel/debug.h lib/kernel/<span class="hljs-built_in">list</span>.h \<br>	fs/file.h thread/thread.h device/ioqueue.h device/keyboard.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br>	<br>$(BUILD_DIR)/inode.o: fs/inode.c fs/inode.h device/ide.h kernel/debug.h thread/thread.h \<br>	kernel/memory.h lib/<span class="hljs-built_in">string</span>.h lib/kernel/<span class="hljs-built_in">list</span>.h kernel/interrupt.h lib/kernel/bitmap.h \<br>	fs/file.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br>	<br>$(BUILD_DIR)/file.o: fs/file.c fs/file.h lib/kernel/stdio-kernel.h thread/thread.h device/ide.h \<br>	fs/file.h kernel/global.h kernel/interrupt.h device/console.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br>	<br>$(BUILD_DIR)/dir.o: fs/dir.c fs/dir.h device/ide.h fs/fs.h fs/inode.h kernel/memory.h lib/<span class="hljs-built_in">string</span>.h lib/stdint.h \<br>	lib/kernel/stdio-kernel.h kernel/debug.h fs/file.h kernel/memory.h lib/<span class="hljs-built_in">string</span>.h kernel/debug.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br>	<br>$(BUILD_DIR)/fork.o: userprog/fork.c userprog/fork.h kernel/global.h lib/stdint.h lib/<span class="hljs-built_in">string</span>.h \<br>	kernel/memory.h kernel/interrupt.h thread/sync.h thread/thread.h  kernel/debug.h userprog/process.h \<br>	lib/kernel/stdio-kernel.h fs/file.h lib/kernel/<span class="hljs-built_in">list</span>.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br>	<br>$(BUILD_DIR)/shell.o: shell/shell.c shell/shell.h kernel/global.h lib/stdint.h lib/<span class="hljs-built_in">string</span>.h \<br>	lib/user/syscall.h lib/stdio.h fs/file.h kernel/debug.h shell/buildin_cmd.h fs/fs.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br>	<br>$(BUILD_DIR)/buildin_cmd.o: shell/buildin_cmd.c shell/buildin_cmd.h fs/file.h fs/fs.h kernel/debug.h \<br>	lib/<span class="hljs-built_in">string</span>.h lib/user/syscall.h fs/dir.h fs/fs.h lib/stdio.h shell/shell.h<br>	$(CC) $(CFLAGS) $&lt; -o $@<br><br>##############    汇编代码编译    ###############<br>$(BUILD_DIR)/kernel.o: kernel/kernel.S<br>	$(AS) $(ASFLAGS) $&lt; -o $@<br><br>$(BUILD_DIR)/print.o: lib/kernel/print.S<br>	$(AS) $(ASFLAGS) $&lt; -o $@<br><br>$(BUILD_DIR)/<span class="hljs-keyword">switch</span>.o: thread/<span class="hljs-keyword">switch</span>.S<br>	$(AS) $(ASFLAGS) $&lt; -o $@<br><br>##############    链接所有目标文件    #############<br>$(BUILD_DIR)/kernel.bin: $(OBJS)<br>	$(LD) $(LDFLAGS) $^ -o $@<br><br>.PHONY : mk_dir hd clean all<br><br>mk_dir:<br>	<span class="hljs-keyword">if</span> [ ! -d $(BUILD_DIR) ]; then mkdir $(BUILD_DIR); fi<br><br>hd:<br>	dd <span class="hljs-keyword">if</span>=$(BUILD_DIR)/kernel.bin \<br>           of=/home/podest/bochs/hd60M.img \<br>           bs=<span class="hljs-number">512</span> count=<span class="hljs-number">200</span> seek=<span class="hljs-number">9</span> conv=notrunc<br><br>clean:<br>	cd $(BUILD_DIR) &amp;&amp; rm -f  .<span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">build: $(BUILD_DIR)/kernel.bin</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">all: mk_dir build hd</span><br></code></pre></td></tr></table></figure>
<h3 id="运行结果"><a class="markdownIt-Anchor" href="#运行结果"></a> 运行结果</h3>
<p><img src="/img/os/os15.2.png" srcset="/img/loading.gif" lazyload alt="图为bochs运行界面" /><br />
<img src="/img/os/os15.3.png" srcset="/img/loading.gif" lazyload alt="图为bochs运行界面" /><br />
<img src="/img/os/os15.4.png" srcset="/img/loading.gif" lazyload alt="图为bochs运行界面" /><br />
<img src="/img/os/os15.5.png" srcset="/img/loading.gif" lazyload alt="图为bochs运行界面" /></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a>
                    
                      <a class="hover-with-bg" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E7%9C%9F%E8%B1%A1%E8%BF%98%E5%8E%9F/">真象还原</a>
                    
                  </div>
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/08/09/os(15-3)/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">第十五章 终章 呈现系统交互界面(下)</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/08/09/os(15-1)/">
                        <span class="hidden-mobile">第十五章 终章 呈现系统交互界面(上)</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <div style="font-size: 0.85rem"> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>





  

  
    <!-- KaTeX -->
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0/dist/katex.min.css" />
  











<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
